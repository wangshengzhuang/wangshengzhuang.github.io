<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>小强斋太-Study Notes</title>
  <subtitle>Stay hungry. Stay foolish</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://wangshengzhuang.com/"/>
  <updated>2017-05-19T15:34:23.626Z</updated>
  <id>http://wangshengzhuang.com/</id>
  
  <author>
    <name>小强斋太</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ansible安装</title>
    <link href="http://wangshengzhuang.com/2017/05/19/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ansible%E5%AE%89%E8%A3%85/"/>
    <id>http://wangshengzhuang.com/2017/05/19/运维相关/Ansible/Ansible安装/</id>
    <published>2017-05-19T15:26:47.000Z</published>
    <updated>2017-05-19T15:34:23.626Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录了ansible的安装方法。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg" alt=""></p>
<a id="more"></a>
<h1 id="一、安装前准备"><a href="#一、安装前准备" class="headerlink" title="一、安装前准备"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id9" target="_blank" rel="external">一、安装前准备</a></h1><h2 id="需要安装些什么"><a href="#需要安装些什么" class="headerlink" title="需要安装些什么"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id11" target="_blank" rel="external">需要安装些什么</a></h2><p>Ansible默认通过 SSH 协议管理机器.目前,只要机器上安装了 Python 2.6 或 Python 2.7 (windows系统不可以做控制主机),都可以运行Ansible.</p>
<p>主机的系统可以是 Red Hat, Debian, CentOS, OS X, BSD的各种版本,等等.</p>
<p>安装Ansible之后,不需要启动或运行一个后台进程,或是添加一个数据库.只要在一台电脑(可以是一台笔记本)上安装好,就可以通过这台电脑管理一组远程的机器.在远程被管理的机器上,不需要安装运行任何软件,因此升级Ansible版本不会有太多问题.</p>
<h2 id="版本及安装方式选择"><a href="#版本及安装方式选择" class="headerlink" title="版本及安装方式选择?"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id12" target="_blank" rel="external">版本及安装方式选择?</a></h2><p>因为Ansible可以很简单的从源码运行,且不必在远程被管理机器上安装任何软件,很多Ansible用户会跟进使用开发版本.</p>
<p>Ansible一般每两个月出一个发行版本.小bugs一般在下一个发行版本中修复,并在稳定分支中做backports.大bugs会在必要时出一个维护版本,不过这不是很频繁.</p>
<p>若你希望使用Ansible的最新版本,并且你使用的操作系统是 Red Hat Enterprise Linux (TM), CentOS, Fedora, Debian, Ubuntu,<strong>我们建议使用系统的软件包管理器</strong>.</p>
<p>另有一种选择是通过”pip”工具安装,”pip”是一个安装和管理Python包的工具.</p>
<p>若你希望跟进开发版本,想使用和测试最新的功能特性,我们会分享如何从源码运行Ansible的方法.从源码运行程序不需要进行软件安装.</p>
<h1 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id15" target="_blank" rel="external">二、安装</a></h1><h2 id="2-1-通过Yum安装最新发布版本"><a href="#2-1-通过Yum安装最新发布版本" class="headerlink" title="2.1 通过Yum安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id17" target="_blank" rel="external">2.1 通过Yum安装最新发布版本</a></h2><p>RHEL或CentOS用户,需要 <a href="http://fedoraproject.org/wiki/EPEL" target="_blank" rel="external">配置 EPEL</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># install the epel-release RPM if needed on CentOS, RHEL, or Scientific Linux</div><div class="line">$ sudo yum install epel-release</div><div class="line">$ sudo yum install ansible</div></pre></td></tr></table></figure>
<h2 id="2-2-自己创建RPM软件包"><a href="#2-2-自己创建RPM软件包" class="headerlink" title="2.2 自己创建RPM软件包"></a>2.2 自己创建RPM软件包</h2><p>你也可以自己创建RPM软件包.在Ansible项目的checkout的根目录下,或是在一个tarball中,使用 <code>make rpm</code> 命令创建RPM软件包. 然后可分发这个软件包或是使用它来安装Ansible.在创建之前,先确定你已安装了 <code>rpm-build</code>, <code>make</code>, and <code>python2-devel</code> .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git clone git://github.com/ansible/ansible.git</div><div class="line">$ cd ./ansible</div><div class="line">$ make rpm</div><div class="line">$ sudo rpm -Uvh ~/rpmbuild/ansible-*.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="2-3-通过Apt-Ubuntu-安装最新发布版本"><a href="#2-3-通过Apt-Ubuntu-安装最新发布版本" class="headerlink" title="2.3 通过Apt (Ubuntu)安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id18" target="_blank" rel="external">2.3 通过Apt (Ubuntu)安装最新发布版本</a></h2><p>配置PPA及安装ansible,执行如下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install software-properties-common</div><div class="line">$ sudo apt-add-repository ppa:ansible/ansible</div><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install ansible</div></pre></td></tr></table></figure>
<h2 id="2-4-通过-Pip-安装最新发布版本"><a href="#2-4-通过-Pip-安装最新发布版本" class="headerlink" title="2.4 通过 Pip 安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id24" target="_blank" rel="external">2.4 通过 Pip 安装最新发布版本</a></h2><p>Ansible可通过 “pip” 安装(安装和管理Python包的工具),若你还没有安装 pip,可执行如下命令安装:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo easy_install pip</div></pre></td></tr></table></figure>
<p>然后安装Ansible:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo pip install ansible</div></pre></td></tr></table></figure>
<p>如果你是在 OS X Mavericks 上安装,编译器可能或告警或报错,可通过如下设置避免这种情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo CFLAGS=-Qunused-arguments CPPFLAGS=-Qunused-arguments pip install ansible</div></pre></td></tr></table></figure>
<h2 id="2-5-发行版的Tarball"><a href="#2-5-发行版的Tarball" class="headerlink" title="2.5 发行版的Tarball"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id25" target="_blank" rel="external">2.5 发行版的Tarball</a></h2><p>不想通过git checkout 创建Ansible的软件包？在这里可获取Tarball <a href="http://releases.ansible.com/ansible" target="_blank" rel="external">Ansible downloads</a></p>
<h2 id="2-6-在Mac-OSX-上安装最新发布版本"><a href="#2-6-在Mac-OSX-上安装最新发布版本" class="headerlink" title="2.6 在Mac OSX 上安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id21" target="_blank" rel="external">2.6 在Mac OSX 上安装最新发布版本</a></h2><p>在 Mac 上安装 ansible，最好是通过 pip 安装，参照 <a href="http://www.ansible.com.cn/docs/intro_installation.html#pip" target="_blank" rel="external">通过 Pip 安装最新发布版本</a> .</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录了ansible的安装方法。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Supervisor简介、安装、配置</title>
    <link href="http://wangshengzhuang.com/2017/05/11/Linux/Supervisor/Supervisor%E7%AE%80%E4%BB%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/11/Linux/Supervisor/Supervisor简介/</id>
    <published>2017-05-10T16:00:00.000Z</published>
    <updated>2017-05-11T14:05:29.697Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍了supervisor的安装、使用。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-11/27833402-file_1494510301732_82f7.jpg" alt=""></p>
<a id="more"></a>
<h3 id="1-什么是supervisor"><a href="#1-什么是supervisor" class="headerlink" title="1. 什么是supervisor"></a>1. <strong>什么是supervisor</strong></h3><p> Supervisor是一个Python开发的client/server系统，可以管理和监控类unix上面的进程。类似daemontools</p>
<p>什么情况下我们需要进程管理呢？就是执行一些需要以守护进程方式执行的程序，比如一个后台任务，如经常会碰到要写一些守护进程，简单做法放入后台：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; nohup python xxx.py &amp;</div></pre></td></tr></table></figure>
<p>除此之外，Supervisor 还能很友好的管理程序在命令行上输出的日志，可以将日志重定向到自定义的日志文件中，还能按文件大小对日志进行分割。</p>
<h3 id="2-为啥用supervisor"><a href="#2-为啥用supervisor" class="headerlink" title="2. 为啥用supervisor"></a>2. 为啥用supervisor</h3><p><strong>方便</strong></p>
<p>为啥简单呢？因为咱们通常管理linux进程的时候，一般来说都需要自己编写一个能够实现进程start/stop/restart/reload功能的脚本，然后丢到/etc/init.d/下面。这么做有很多不好的地方，第一我们要编写这个脚本，这就很耗时耗力了。第二，当这个进程挂掉的时候，linux不会自动重启它的，想要自动重启的话，我们还要自己写一个监控重启脚本。而supervisor则可以完美的解决这些问题。supervisor管理进程，是通过fork/exec的方式把这些被管理的进程，当作supervisor的子进程来启动。这样的话，我们只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去就OK了。这样就省下了我们如同linux管理进程的时自己写控制脚本的麻烦了。第二，被管理进程作为supervisor的子进程，当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，所以当然也就可以对挂掉的子进程进行自动重启了，当然重启还是不重启，也要看你的配置文件里面有木有设置autostart=true了。</p>
<p><strong>精确</strong></p>
<p> Supervisord将进程作为子进程启动，因此可以一直知晓子进程的状态，可以方便查询。而基于pid文件文件获取进程状态有时候不靠谱</p>
<p><strong>权限代理</strong></p>
<p>某些进程需要root或者sudo权限运行，而又不方便把机器的root权限和sudo权限开放给用户的时候，普通用户可以借助supervisor的命令和web UI进行进程的启动和关闭</p>
<p><strong>进程组</strong></p>
<p>linux系统没有批量启动关闭进程的功能，我们想要停止多个进程，只能一个一个的去停止，要么就自己写个脚本去批量停止。Supervisor 允许赋予进程优先级，可以使用supervisorctl 的“start all”, and “restart all”，按照优先级顺序启动。并且进程可以分组，相关的进程可以作为一个单元启动。</p>
<h3 id="3-supervisor特点"><a href="#3-supervisor特点" class="headerlink" title="3. supervisor特点"></a>3. supervisor特点</h3><ul>
<li><strong>简单</strong> :supervisor通过一个 INI-style的文件配置，简单易学。提供了许多诸如重启失败进程、自动日子归档的功能</li>
<li><strong>中心化</strong>:    可以在在同一个地方启动 停止 监控子进程，进程可以单独控制，也可以分组控制，并提供命令行和web接口配置supervisor</li>
<li><strong>高效</strong>:    通过 fork/exec启动子进程</li>
<li><strong>可扩展</strong>:  提供了simple event notification protocol和XML-RPC interface，方便通过各种语言进行配置管理</li>
<li><strong>兼容性强</strong>: 类Unix都支持，不支持windows，基于Python</li>
<li><strong>作为一款已经被使用了十多年的软件，可用性已经被广泛证明</strong></li>
</ul>
<h3 id="4-Supervisor-组成"><a href="#4-Supervisor-组成" class="headerlink" title="4. Supervisor 组成"></a>4. Supervisor 组成</h3><ol>
<li><strong>supervisord</strong>：supervisord是supervisor的服务端程序。负责启动子程序，应答客户端命令，重启crash进程，子程序日志记录，对进程变化发送事件通知等</li>
<li><strong>supervisorctl：</strong>  客户端命令行工具，可以连接服务器端，进行进程的启动、关闭、重启、状态查看等。重要的一点是，supervisorctl不仅可以连接到本机上的supervisord，还可以连接到远程的supervisord，当然在本机上面是通过UNIX socket连接的，远程是通过TCP socket连接的。supervisorctl和supervisord之间的通信，是通过xml_rpc完成的。    相应的配置在[supervisorctl]块里面</li>
<li><strong>Web Server</strong>   可以在界面上管理进程的WEB UI, 通过[inet_http_server] section配置，默认<a href="http://localhost:9001/`" target="_blank" rel="external">http://localhost:9001/`</a></li>
<li><strong>XML-RPC Interface</strong> XML-RPC接口，提供XML-RPC服务来对子进程进行管理，监控，参照 <a href="http://supervisord.org/api.html#xml-rpc" target="_blank" rel="external"><em>XML-RPC API Documentation</em></a>.</li>
</ol>
<h3 id="5-安装"><a href="#5-安装" class="headerlink" title="5 安装"></a>5 安装</h3><h4 id="5-1-yum-安装-推荐"><a href="#5-1-yum-安装-推荐" class="headerlink" title="5.1 yum 安装(推荐)"></a>5.1 yum 安装(推荐)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install supervisor</div></pre></td></tr></table></figure>
<p>会自动安装成服务形式，可以使用systemctl进行管理</p>
<h4 id="5-2-使用Setuptools安装"><a href="#5-2-使用Setuptools安装" class="headerlink" title="5.2 使用Setuptools安装"></a>5.2 使用Setuptools安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget -q http://peak.telecommunity.com/dist/ez_setup.py</div><div class="line">python ez_setup.py</div><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-setuptools</div><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<h4 id="5-3-安装方式3"><a href="#5-3-安装方式3" class="headerlink" title="5.3 安装方式3"></a>5.3 安装方式3</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://pypi.python.org/packages/80/37/964c0d53cbd328796b1aeb7abea4c0f7b0e8c7197ea9b0b9967b7d004def/supervisor-3.3.1.tar.gz</div><div class="line">tar -zxvf supervisor-3.3.1.tar.gz </div><div class="line">cd supervisor-3.3.1</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<h4 id="5-4生成配置文件"><a href="#5-4生成配置文件" class="headerlink" title="5.4生成配置文件"></a>5.4生成配置文件</h4><p><code>yum 安装方式不需要此步骤，因为已经自动生产了supervisord.conf 和supervisord.d文件夹</code></p>
<p>安装完 supervisor 之后，可以运行<code>echo_supervisord_conf</code> 命令输出默认的配置项，也可以重定向到一个配置文件里：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure>
<h4 id="5-5启动"><a href="#5-5启动" class="headerlink" title="5.5启动"></a>5.5启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<h3 id="6-配置文件-etc-supervisord-conf"><a href="#6-配置文件-etc-supervisord-conf" class="headerlink" title="6. 配置文件/etc/supervisord.conf"></a>6. 配置文件/etc/supervisord.conf</h3><p>上面我们已经把 supervisrod 运行起来了，现在可以添加我们要管理的进程的配置文件。可以把所有配置项都写到 supervisord.conf 文件里，但并不推荐这样做，而是通过 include 的方式把不同的程序（组）写到不同的配置文件里。yum方式安装，会自动配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[include]</div><div class="line">files = supervisord.d/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<p>/etc/supervisord.conf 参数说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用</div><div class="line">;chmod=0700                 ; socket 文件的 mode，默认是 0700</div><div class="line">;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid</div><div class="line"> </div><div class="line">;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">;username=user              ; 登录管理后台的用户名</div><div class="line">;password=123               ; 登录管理后台的密码</div><div class="line"> </div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; 日志文件，默认是 $CWD/supervisord.log</div><div class="line">logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB</div><div class="line">logfile_backups=10           ; 日志文件保留备份数量默认 10</div><div class="line">loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace</div><div class="line">pidfile=/tmp/supervisord.pid ; pid 文件</div><div class="line">nodaemon=false               ; 是否在前台启动，默认是 false，即以 daemon 的方式启动</div><div class="line">minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024</div><div class="line">minprocs=200                 ; 可以打开的进程数的最小值，默认 200</div><div class="line"> </div><div class="line">; the below section must remain in the config file for RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them in separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"> </div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致</div><div class="line">;serverurl=http://127.0.0.1:9001 ; 通过 HTTP 的方式连接 supervisord</div><div class="line"> </div><div class="line">; 包含其他的配置文件</div><div class="line">[include]</div><div class="line">files = /etc/supervisord.d/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<h3 id="7-添加一个被管理的进程"><a href="#7-添加一个被管理的进程" class="headerlink" title="7. 添加一个被管理的进程"></a>7. 添加一个被管理的进程</h3><p>我们假如有一个hello.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import web</div><div class="line">urls = (     &apos;/(.*)&apos;,&apos;hello&apos; )</div><div class="line">app = web.application(urls, globals())</div><div class="line">class hello:</div><div class="line">    def GET(self, name):</div><div class="line">        return &apos;hello: &apos; + name</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app.run()</div></pre></td></tr></table></figure>
<p>所以直接在命令行启动的方式可能是这样的：(需要先安装web.py <code>easy_install web.py</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python  /opt/hello.py</div></pre></td></tr></table></figure>
<p>现在编写一份配置文件<code>/etc/supervisord.d/hello.ini</code>来管理这个进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[program:hello]</div><div class="line">directory = /opt    ; 程序的启动目录</div><div class="line">command = python /opt/hello.py  ; 启动命令，可以看出与手动在命令行启动的命令是一样的</div><div class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</div><div class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</div><div class="line">autorestart = true   ; 程序异常退出后自动重启</div><div class="line">startretries = 3     ; 启动失败自动重试次数，默认是 3</div><div class="line">user = xqzt          ; 用哪个用户启动</div><div class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</div><div class="line">stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB</div><div class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</div><div class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</div><div class="line">stdout_logfile = /var/log/supervisor/hello.log</div></pre></td></tr></table></figure>
<p>一份配置文件至少需要一个 <code>[program:x]</code> 部分的配置，来告诉 supervisord 需要管理那个进程。<code>[program:x]</code> 语法中的 <code>x</code> 表示 program name，会在客户端（supervisorctl 或 web 界面）显示，在 supervisorctl 中通过这个值来对程序进行 start、restart、stop 等操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">supervisor&gt; status</div><div class="line">hello                            RUNNING   pid 2809, uptime 0:00:06</div></pre></td></tr></table></figure>
<h3 id="8-使用-supervisorctl"><a href="#8-使用-supervisorctl" class="headerlink" title="8. 使用 supervisorctl"></a>8. 使用 supervisorctl</h3><p>Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件，否则与 supervisord 一样按照顺序查找配置文件。supervisorctl 这个命令会进入 supervisorctl 的 shell 界面，然后可以执行不同的命令了，也可以直接在 bash 终端运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># supervisorctl --help</div><div class="line">supervisorctl -- control applications run by supervisord from the cmd line.</div><div class="line"></div><div class="line">Usage: /usr/bin/supervisorctl [options] [action [arguments]]</div><div class="line"></div><div class="line">Options:</div><div class="line">-c/--configuration -- configuration file path (default /etc/supervisord.conf)</div><div class="line">-h/--help -- print usage message and exit</div><div class="line">-i/--interactive -- start an interactive shell after executing commands</div><div class="line">-s/--serverurl URL -- URL on which supervisord server is listening</div><div class="line">     (default &quot;http://localhost:9001&quot;).</div><div class="line">-u/--username -- username to use for authentication with server</div><div class="line">-p/--password -- password to use for authentication with server</div><div class="line">-r/--history-file -- keep a readline history (if readline is available)</div></pre></td></tr></table></figure>
<p>输入help,可以查看支持的命令及用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">supervisor&gt; help</div><div class="line"></div><div class="line">default commands (type help &lt;topic&gt;):</div><div class="line">=====================================</div><div class="line">add    clear  fg        open  quit    remove  restart   start   stop  update </div><div class="line">avail  exit   maintail  pid   reload  reread  shutdown  status  tail  version</div><div class="line"></div><div class="line">supervisor&gt; help start</div><div class="line">start &lt;name&gt;		Start a process</div><div class="line">start &lt;gname&gt;:*		Start all processes in a group</div><div class="line">start &lt;name&gt; &lt;name&gt;	Start multiple processes or groups</div><div class="line">start all		Start all processes</div></pre></td></tr></table></figure>
<p>常用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 停止某一个进程，program_name 为 [program:x] 里的 x</div><div class="line">supervisorctl stop program_name</div><div class="line"># 启动某个进程</div><div class="line">supervisorctl start program_name</div><div class="line"># 重启某个进程</div><div class="line">supervisorctl restart program_name</div><div class="line"># 结束所有属于名为 groupworker 这个分组的进程 (start，restart 同理)</div><div class="line">supervisorctl stop groupworker:</div><div class="line"># 结束 groupworker:name1 这个进程 (start，restart 同理)</div><div class="line">supervisorctl stop groupworker:name1</div><div class="line"># 停止全部进程，注：start、restart、stop 都不会载入最新的配置文件</div><div class="line">supervisorctl stop all</div><div class="line"># 载入最新的配置文件，停止原有进程并按新的配置启动、管理所有进程</div><div class="line">supervisorctl reload</div><div class="line"># 根据最新的配置文件，启动新配置或有改动的进程，配置没有改动的进程不会受影响而重启</div><div class="line">supervisorctl update</div></pre></td></tr></table></figure>
<h3 id="9-supervisor-Web-UI"><a href="#9-supervisor-Web-UI" class="headerlink" title="9. supervisor Web UI"></a>9. supervisor Web UI</h3><p>除了 supervisorctl 之外，还可以配置 supervisrod 启动 web 管理界面，这个 web 后台使用 Basic Auth 的方式进行身份认证。将supervisord.conf中[inet_http_server]部分做相应配置，在supervisorctl中reload即可启动web管理界面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[inet_http_server] ; HTTP 服务器，提供 web 管理界面</div><div class="line">port=172.17.84.64:9001 ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">username=user ; 登录管理后台的用户名</div><div class="line">password=123 ; 登录管理后台的密码</div></pre></td></tr></table></figure>
<p>在浏览器中输入<a href="http://127.0.0.1:9001，可进入web管理界面" target="_blank" rel="external">http://127.0.0.1:9001，可进入web管理界面</a></p>
<p><img src="http://image.wangshengzhuang.com/17-5-11/65946564-file_1494502213044_176b5.png" alt=""></p>
<h3 id="10-将多个进程按组管理"><a href="#10-将多个进程按组管理" class="headerlink" title="10.  将多个进程按组管理"></a>10.  将多个进程按组管理</h3><p>Supervisor 同时还提供了另外一种进程组的管理方式，通过这种方式，可以使用 supervisorctl 命令来管理一组进程。跟 [program:x] 的进程组不同的是，这里的进程是一个个的 [program:x] 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[group:thegroupname]</div><div class="line">programs=progname1,progname2  ; each refers to &apos;x&apos; in [program:x] definitions</div><div class="line">priority=999                  ; the relative start priority (default 999)</div></pre></td></tr></table></figure>
<p>当添加了上述配置后，<code>progname1</code> 和 <code>progname2</code> 的进程名就会变成 <code>thegroupname:progname1</code> 和 <code>thegroupname:progname2</code> 以后就要用这个名字来管理进程了，而不是之前的 <code>progname1</code>。</p>
<p>以后执行 <code>supervisorctl stop thegroupname:</code> 就能同时结束 <code>progname1</code> 和 <code>progname2</code>，执行 <code>supervisorctl stop thegroupname:progname1</code> 就能结束 <code>progname1</code>。如下所示</p>
<p><code>/etc/supervisord.d/hello.ini</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[group:group1]</div><div class="line">programs=hello</div><div class="line"></div><div class="line">[program:hello]</div><div class="line">directory = /opt    ; 程序的启动目录</div><div class="line">command = python /opt/hello.py  ; 启动命令，可以看出与手动在命令行启动的命令是一样的</div><div class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</div><div class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</div><div class="line">autorestart = true   ; 程序异常退出后自动重启</div><div class="line">startretries = 3     ; 启动失败自动重试次数，默认是 3</div><div class="line">user = xqzt          ; 用哪个用户启动</div><div class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</div><div class="line">stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB</div><div class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</div><div class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</div><div class="line">; stdout_logfile = /var/log/supervisor/hello.log</div></pre></td></tr></table></figure>
<p>进程状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@centos7 etc]# supervisorctl </div><div class="line">group1:hello                     RUNNING   pid 2842, uptime 0:02:53</div></pre></td></tr></table></figure>
<h3 id="11-Subprocesses进程状态变化"><a href="#11-Subprocesses进程状态变化" class="headerlink" title="11. Subprocesses进程状态变化"></a>11. Subprocesses进程状态变化</h3><p><img src="http://supervisord.org/_images/subprocess-transitions.png" alt="http://supervisord.org/_images/subprocess-transitions.png"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://supervisord.org/#" target="_blank" rel="external">官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要介绍了supervisor的安装、使用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-11/27833402-file_1494510301732_82f7.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="Supervisor" scheme="http://wangshengzhuang.com/categories/Linux/Supervisor/"/>
    
    
      <category term="supervisor" scheme="http://wangshengzhuang.com/tags/supervisor/"/>
    
  </entry>
  
  <entry>
    <title>cd命令</title>
    <link href="http://wangshengzhuang.com/2017/05/10/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/cd%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/10/Linux/每天一个Linux命令/cd命令/</id>
    <published>2017-05-10T14:12:49.000Z</published>
    <updated>2017-05-11T14:43:40.740Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录cd命令的用法</p>
<a id="more"></a>
<h3 id="1、作用"><a href="#1、作用" class="headerlink" title="1、作用"></a><strong>1、作用</strong></h3><p><strong>cd</strong>（Change Directory 改变目录）命令用来切换工作目录至dirname。 其中dirName表示法可为绝对路径或相对路径。若目录名称省略，则变换至使用者的home directory(也就是刚login时所在的目录)。另外，~也表示为home directory的意思，.则是表示目前所在的目录，..则表示目前目录位置的上一层目录。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a><strong>2、用法</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd    (选项)   (参数)</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-p  如果要切换到的目标目录是一个符号连接，直接切换到符号连接指向的目标目录</div><div class="line">-L  如果要切换的目标目录是一个符号的连接，直接切换到字符连接名代表的目录，而非符号连接所指向的目标目录。</div><div class="line"> -   当仅实用&quot;-&quot;一个选项时，当前工作目录将被切换到环境变量&quot;OLDPWD&quot;所表示的目录。每当你更改目录时，shell都会将上一个目录位置记录在环境变量OLDPWD中</div></pre></td></tr></table></figure>
<h4 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h4><h4 id="1、cd-进入用户主目录；"><a href="#1、cd-进入用户主目录；" class="headerlink" title="1、cd 进入用户主目录；"></a>1、cd 进入用户主目录；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# cd</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="2、cd-进入用户主目录；"><a href="#2、cd-进入用户主目录；" class="headerlink" title="2、cd ~ 进入用户主目录；"></a>2、cd ~ 进入用户主目录；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# cd ~</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div><div class="line">[root@cent6 ~]#</div></pre></td></tr></table></figure>
<h4 id="3、cd-返回进入此目录之前所在的目录"><a href="#3、cd-返回进入此目录之前所在的目录" class="headerlink" title="3、cd - 返回进入此目录之前所在的目录"></a>3、cd - 返回进入此目录之前所在的目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div><div class="line">[root@cent6 ~]# cd /home</div><div class="line">[root@cent6 home]# cd -</div><div class="line">/root</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="4、cd-返回上级目录"><a href="#4、cd-返回上级目录" class="headerlink" title="4、cd .. 返回上级目录"></a>4、cd .. 返回上级目录</h4><p>（若当前目录为“/“，则执行完后还在“/“；”..”为上级目录的意思）；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# pwd</div><div class="line">/etc/init.d</div><div class="line">[root@cent6 init.d]# cd ..</div><div class="line">[root@cent6 etc]# pwd</div><div class="line">/etc</div></pre></td></tr></table></figure>
<h4 id="5、cd-返回上两级目录；"><a href="#5、cd-返回上两级目录；" class="headerlink" title="5、cd ../.. 返回上两级目录；"></a>5、cd ../.. 返回上两级目录；</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# pwd</div><div class="line">/etc/init.d</div><div class="line">[root@cent6 init.d]# cd ../..</div><div class="line">[root@cent6 /]# pwd</div><div class="line">/</div></pre></td></tr></table></figure>
<h4 id="6、cd-把上个命令的参数作为cd参数使用"><a href="#6、cd-把上个命令的参数作为cd参数使用" class="headerlink" title="6、cd !$ 把上个命令的参数作为cd参数使用"></a>6、cd !$ 把上个命令的参数作为cd参数使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@cent6 /]# ls -ld /media/</div><div class="line">drwxr-xr-x. 2 root root 4096 Sep 23  2011 /media/</div><div class="line">[root@cent6 /]# cd !$</div><div class="line">cd /media/</div><div class="line">[root@cent6 media]# pwd</div><div class="line">/media</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录cd命令的用法&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="cd" scheme="http://wangshengzhuang.com/tags/cd/"/>
    
  </entry>
  
  <entry>
    <title>pwd命令</title>
    <link href="http://wangshengzhuang.com/2017/05/09/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/pwd%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/09/Linux/每天一个Linux命令/pwd命令/</id>
    <published>2017-05-09T14:12:49.000Z</published>
    <updated>2017-05-11T14:36:17.259Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录pwd命令的用法</p>
<a id="more"></a>
<h3 id="1、命令简介"><a href="#1、命令简介" class="headerlink" title="1、命令简介"></a>1、命令简介</h3><p><strong>pwd</strong>（print work directory 打印当前目录）命令以绝对路径的方式显示用户当前工作目录。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pwd  [-LP]</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-L    --logical    当目录为连接路径时，显示连接路径</div><div class="line">-P    --physical    显示实际物理路径，而非使用连接（link）路径</div></pre></td></tr></table></figure>
<h3 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h3><h4 id="4-1-显示当前目录所在路径-pwd"><a href="#4-1-显示当前目录所在路径-pwd" class="headerlink" title="4.1 显示当前目录所在路径 pwd"></a>4.1 显示当前目录所在路径 pwd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="4-2-显示当前目录的物理路径-pwd-–P"><a href="#4-2-显示当前目录的物理路径-pwd-–P" class="headerlink" title="4.2 显示当前目录的物理路径 pwd –P"></a>4.2 显示当前目录的物理路径 pwd –P</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# cd /etc/init.d </div><div class="line">[root@cent6 init.d]# pwd -P</div><div class="line">/etc/rc.d/init.d</div></pre></td></tr></table></figure>
<h4 id="4-3-显示当前目录的连接路径：pwd-L"><a href="#4-3-显示当前目录的连接路径：pwd-L" class="headerlink" title="4.3 显示当前目录的连接路径：pwd -L"></a>4.3 显示当前目录的连接路径：pwd -L</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# cd /etc/init.d </div><div class="line">[root@cent6 init.d]# pwd -L</div><div class="line">/etc/init.d</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录pwd命令的用法&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="pwd" scheme="http://wangshengzhuang.com/tags/pwd/"/>
    
  </entry>
  
  <entry>
    <title>从已有的组复制搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/08/MySQL/MySQL%20HA/InnoDB%20Cluster/%E4%BB%8E%E5%B7%B2%E6%9C%89%E7%9A%84%E7%BB%84%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/08/MySQL/MySQL HA/InnoDB Cluster/从已有的组复制搭建InnoDB Cluster环境/</id>
    <published>2017-05-07T16:00:00.000Z</published>
    <updated>2017-05-07T17:47:01.159Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何基于已有的MySQL Group Replication，创建一个 Innodb cluster。</p>
<a id="more"></a>
<h3 id="1-已有的MySQL-Group-Replication-环境信息"><a href="#1-已有的MySQL-Group-Replication-环境信息" class="headerlink" title="1. 已有的MySQL Group Replication 环境信息"></a>1. 已有的MySQL Group Replication 环境信息</h3><table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.84.71</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>172.17.84.72</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>172.17.84.73</td>
<td>mysql003</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>查看组复制当前状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 80af8598-1520-11e7-a8b9-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | 8abf4eab-1521-11e7-9cc9-080027b95fc4 | mysql002    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | dcd3068d-15bc-11e7-b264-080027dad0d6 | mysql003    |        3306 | ONLINE       |</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><pre><code>wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm
rpm -ivh mysql57-community-release-el7-10.noarch.rpm
yum install mysql-shell -y
</code></pre><h3 id="3-创建cluster"><a href="#3-创建cluster" class="headerlink" title="3. 创建cluster"></a>3. 创建cluster</h3><p>通过指定 <code>adoptFromGR</code> option，使用dba.createCluster()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysqlsh --uri root@172.17.84.71:3306</div><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true&#125;);</div><div class="line">A new InnoDB cluster will be created on instance &apos;root@172.17.84.7:3306&apos;.</div><div class="line"></div><div class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;root@172.17.84.72:3306&apos;...</div><div class="line">Adding Seed Instance...</div><div class="line"></div><div class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</div><div class="line">At least 3 instances are needed for the cluster to be able to withstand up to</div><div class="line">one server failure.</div></pre></td></tr></table></figure>
<p>查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster=dba.getCluster()</div><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;,</div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;,</div><div class="line">        &quot;primary&quot;: &quot;172.17.84.71:3306&quot;,</div><div class="line">        &quot;status&quot;: &quot;OK&quot;,</div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;,</div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;172.17.84.71:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.84.71:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql002:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql002:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql003:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql003:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-持久化配置文件"><a href="#4-持久化配置文件" class="headerlink" title="4. 持久化配置文件"></a>4. 持久化配置文件</h3><p>对于已经在cluster中的实例，可以持久化cluster的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dba.configureLocalInstance(root@localhost:3306)</div></pre></td></tr></table></figure>
<p>查看配置文件的变化my.cnf</p>
<h3 id="5-简单测试Failover"><a href="#5-简单测试Failover" class="headerlink" title="5.简单测试Failover"></a>5.简单测试Failover</h3><p>关闭mysql001实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld</div></pre></td></tr></table></figure>
<p>重启mysql001实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld</div></pre></td></tr></table></figure>
<p>查看cluster状态,发现Primary Master已经切换到mysql002</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;,</div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;,</div><div class="line">        &quot;primary&quot;: &quot;172.17.84.72:3306&quot;,</div><div class="line">        &quot;status&quot;: &quot;OK&quot;,</div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;,</div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;172.17.84.72:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.84.72:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql001:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql001:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql003:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql003:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-createCluster语法"><a href="#6-createCluster语法" class="headerlink" title="6.createCluster语法"></a>6.createCluster语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.help(createCluster());</div><div class="line">ReferenceError: createCluster is not defined</div><div class="line">mysql-js&gt; dba.help(&apos;createCluster&apos;);</div><div class="line"></div><div class="line">Creates a MySQL InnoDB cluster.</div><div class="line"></div><div class="line">SYNTAX</div><div class="line"></div><div class="line">  &lt;Dba&gt;.createCluster(name[, options])</div><div class="line"></div><div class="line">WHERE</div><div class="line"></div><div class="line">  name: The name of the cluster object to be created.</div><div class="line">  options: Dictionary with options that modify the behavior of this function.</div><div class="line"></div><div class="line">DESCRIPTION</div><div class="line"></div><div class="line">Creates a MySQL InnoDB cluster taking as seed instance the active global</div><div class="line">session.</div><div class="line"></div><div class="line">The options dictionary can contain the next values:</div><div class="line"></div><div class="line"> - clusterAdminType: defines the type of management to be done on the cluster</div><div class="line">   instances.</div><div class="line"> - multiMaster: boolean value used to define an InnoDB cluster with multiple</div><div class="line">   writable instances.</div><div class="line"> - force: boolean, confirms that the multiMaster option must be applied.</div><div class="line"> - adoptFromGR: boolean value used to create the InnoDB cluster based on</div><div class="line">   existing replication group.</div><div class="line"> - memberSslMode: SSL mode used to configure the members of the cluster.</div><div class="line"> - ipWhitelist: The list of hosts allowed to connect to the instance for group</div><div class="line">   replication.</div><div class="line"></div><div class="line">The values for clusterAdminType options include: local, manual, guided or ssh,</div><div class="line">however, at the moment only local is supported and is used as default value if</div><div class="line">this attribute is not specified.</div><div class="line"></div><div class="line">A InnoDB cluster may be setup in two ways:</div><div class="line"></div><div class="line"> - Single Master: One member of the cluster allows write operations while the</div><div class="line">   rest are in read only mode.</div><div class="line"> - Multi Master: All the members in the cluster support both read and write</div><div class="line">   operations.</div><div class="line"></div><div class="line">By default this function create a Single Master cluster, use the multiMaster</div><div class="line">option set to true if a Multi Master cluster is required.</div><div class="line"></div><div class="line">The memberSslMode option supports these values:</div><div class="line"></div><div class="line"> - REQUIRED: if used, SSL (encryption) will be enabled for the instances to</div><div class="line">   communicate with other members of the cluster</div><div class="line"> - DISABLED: if used, SSL (encryption) will be disabled</div><div class="line"> - AUTO: if used, SSL (encryption) will be enabled if supported by the</div><div class="line">   instance, otherwise disabled</div><div class="line"></div><div class="line">If memberSslMode is not specified AUTO will be used by default.</div><div class="line"></div><div class="line">The ipWhitelist format is a comma separated list of IP addresses or subnet CIDR</div><div class="line">notation, for example: 192.168.1.0/24,10.0.0.1. By default the value is set to</div><div class="line">AUTOMATIC, allowing addresses from the instance private network to be</div><div class="line">automatically set for the whitelist.</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-group-replication.html" target="_blank" rel="external">Creating an InnoDB Cluster From an Existing Group Replication Deployment</a></li>
<li><a href="https://ronniethedba.wordpress.com/2017/04/23/creating-an-innodb-cluster-router-from-an-existing-group-replication-deployment/" target="_blank" rel="external">https://ronniethedba.wordpress.com/2017/04/23/creating-an-innodb-cluster-router-from-an-existing-group-replication-deployment/</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何基于已有的MySQL Group Replication，创建一个 Innodb cluster。&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/tags/Group-Replication/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL Group Replication 部署中遇到的错误</title>
    <link href="http://wangshengzhuang.com/2017/05/07/MySQL/Group%20Replication/MySQL%20Group%20Replication%20%E9%83%A8%E7%BD%B2%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF/"/>
    <id>http://wangshengzhuang.com/2017/05/07/MySQL/Group Replication/MySQL Group Replication 部署中遇到的错误/</id>
    <published>2017-05-06T16:20:05.000Z</published>
    <updated>2017-05-07T16:41:56.285Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要描述了MySQL Group Replication 部署中遇到的错误</p>
<a id="more"></a>
<h3 id="错误一-未设置白名单导致的无法启动group-replication"><a href="#错误一-未设置白名单导致的无法启动group-replication" class="headerlink" title="错误一 未设置白名单导致的无法启动group_replication"></a>错误一 未设置白名单导致的无法启动group_replication</h3><h4 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">2017-04-24T06:23:09.971308Z 3 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 127.0.0.1/8 to the whitelist&apos;</div><div class="line">2017-04-24T06:23:09.971480Z 3 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</div><div class="line">2017-04-24T06:23:09.971513Z 3 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;; group_replication_local_address: &quot;172.17.84.71:33061&quot;; group_replication_group_seeds: &quot;172.17.84.71:33061,172.17.84.72:33061,172.17.84.73:33061&quot;; group_replication_bootstrap_group: true; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</div><div class="line">2017-04-24T06:23:09.972386Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T06:23:09.982442Z 15 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./mysql001-relay-bin-group_replication_applier.000001&apos; position: 4</div><div class="line">2017-04-24T06:23:09.982441Z 3 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</div><div class="line">2017-04-24T06:23:09.982618Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 7&apos;</div><div class="line">2017-04-24T06:23:09.982637Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 1&apos;</div><div class="line">2017-04-24T06:23:09.982841Z 0 [Note] Plugin group_replication reported: &apos;state 4257 action xa_init&apos;</div><div class="line">2017-04-24T06:23:09.982957Z 0 [Note] Plugin group_replication reported: &apos;Successfully bound to 0.0.0.0:33061 (socket=80).&apos;</div><div class="line">2017-04-24T06:23:09.983104Z 0 [Note] Plugin group_replication reported: &apos;Successfully set listen backlog to 32 (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983149Z 0 [Note] Plugin group_replication reported: &apos;Successfully unblocked socket (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983232Z 0 [Note] Plugin group_replication reported: &apos;Ready to accept incoming connections on 0.0.0.0:33061 (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983302Z 0 [Note] Plugin group_replication reported: &apos;connecting to 172.17.84.71 33061&apos;</div><div class="line">2017-04-24T06:23:09.983432Z 0 [Note] Plugin group_replication reported: &apos;client connected to 172.17.84.71 33061 fd 83&apos;</div><div class="line">2017-04-24T06:23:09.983524Z 0 [Warning] Plugin group_replication reported: &apos;[GCS] Connection attempt from IP address 172.17.84.71 refused. Address is not in the IP whitelist.&apos;</div><div class="line">2017-04-24T06:23:09.983620Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error connecting to the local group communication engine instance.&apos;</div><div class="line">2017-04-24T06:23:09.983647Z 0 [Note] Plugin group_replication reported: &apos;state 4257 action xa_exit&apos;</div><div class="line">2017-04-24T06:23:09.983926Z 0 [Note] Plugin group_replication reported: &apos;Exiting xcom thread&apos;</div><div class="line">2017-04-24T06:23:11.014814Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] The member was unable to join the group. Local port: 33061&apos;</div><div class="line">2017-04-24T06:24:09.991677Z 3 [ERROR] Plugin group_replication reported: &apos;Timeout on wait for view after joining group&apos;</div><div class="line">2017-04-24T06:24:09.991847Z 3 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</div><div class="line">2017-04-24T06:24:09.991903Z 3 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</div><div class="line">2017-04-24T06:24:09.992323Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_increment is reset to 1&apos;</div><div class="line">2017-04-24T06:24:09.992354Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_offset is reset to 1&apos;</div><div class="line">2017-04-24T06:24:09.992922Z 15 [Note] Error reading relay log event for channel &apos;group_replication_applier&apos;: slave SQL thread was killed</div><div class="line">2017-04-24T06:24:09.993527Z 12 [Note] Plugin group_replication reported: &apos;The group replication applier thread was killed&apos;</div></pre></td></tr></table></figure>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>基于网段或者IP 指定白名单，可以在线动态修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">set global group_replication_ip_whitelist = &apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;;</div><div class="line">set global group_replication_ip_whitelist = &apos;172.17.84.71/24&apos;;</div></pre></td></tr></table></figure>
<p>或者添加到my.cnf中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure>
<h3 id="错误二-无法解析主机名导致member状态一直未recoving"><a href="#错误二-无法解析主机名导致member状态一直未recoving" class="headerlink" title="错误二 无法解析主机名导致member状态一直未recoving"></a>错误二 无法解析主机名导致member状态一直未recoving</h3><h4 id="错误信息-1"><a href="#错误信息-1" class="headerlink" title="错误信息"></a>错误信息</h4><p>通过<code>SELECT * FROM performance_schema.replication_group_members;</code>查询，发现MEMBER_STATE一直是recoving</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">2017-04-24T07:01:19.864784Z 0 [Note] Plugin group_replication reported: &apos;Starting group replication recovery with view_id 14930159987057432:2&apos;</div><div class="line">2017-04-24T07:01:19.865335Z 19 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</div><div class="line">2017-04-24T07:01:19.871742Z 19 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;mysql001&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T07:01:19.881203Z 19 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 60b61f19-289f-11e7-b97d-08002730b4d8 at mysql001 port: 3306.&apos;</div><div class="line">2017-04-24T07:01:19.881586Z 21 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</div><div class="line">2017-04-24T07:01:19.882339Z 22 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./mysql002-relay-bin-group_replication_recovery.000001&apos; position: 4</div><div class="line">2017-04-24T07:01:19.883547Z 21 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: error connecting to master &apos;rpl_user@mysql001:3306&apos; - retry-time: 60  retries: 1, Error_code: 2005</div><div class="line">2017-04-24T07:01:19.883573Z 21 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos; killed while connecting to master</div><div class="line">2017-04-24T07:01:19.883582Z 21 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</div><div class="line">2017-04-24T07:01:19.883861Z 19 [ERROR] Plugin group_replication reported: &apos;There was an error when connecting to the donor server. Check group replication recovery&apos;s connection credentials.&apos;</div><div class="line">2017-04-24T07:01:19.884138Z 19 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</div><div class="line">2017-04-24T07:01:55.338092Z 0 [Note] Plugin group_replication reported: &apos;getstart group_id 4317e324&apos;</div><div class="line">2017-04-24T07:01:57.362663Z 0 [Note] Plugin group_replication reported: &apos;Marking group replication view change with view_id 14930159987057432:3&apos;</div><div class="line">2017-04-24T07:01:57.422909Z 0 [Note] Plugin group_replication reported: &apos;The member with address mysql003:3306 was declared online within the replication group&apos;</div><div class="line">2017-04-24T07:02:19.884808Z 19 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;mysql001&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;mysql003&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T07:02:19.890519Z 19 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 164b8061-28ba-11e7-9a51-080027dad0d6 at mysql003 port: 3306.&apos;</div><div class="line">2017-04-24T07:02:19.891514Z 26 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</div><div class="line">2017-04-24T07:02:19.893156Z 26 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: error connecting to master &apos;rpl_user@mysql003:3306&apos; - retry-time: 60  retries: 1, Error_code: 2005</div><div class="line">2017-04-24T07:02:19.893186Z 26 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos; killed while connecting to master</div><div class="line">2017-04-24T07:02:19.893194Z 26 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</div><div class="line">2017-04-24T0</div></pre></td></tr></table></figure>
<h4 id="解决办法-1"><a href="#解决办法-1" class="headerlink" title="解决办法"></a>解决办法</h4><p><strong>方法一  配置hosts</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">172.17.84.71 mysql001</div><div class="line">172.17.84.72 msyql002</div><div class="line">172.17.84.73 mysql003</div></pre></td></tr></table></figure>
<p><strong>方法二</strong></p>
<p>或者在配置文件my.cnf使用report_host=ip，显示指定使用IP，而非默认的主机名</p>
<h3 id="错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed-Gtid-Set不同"><a href="#错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed-Gtid-Set不同" class="headerlink" title="错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed_Gtid_Set不同"></a>错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed_Gtid_Set不同</h3><h4 id="错误信息-2"><a href="#错误信息-2" class="headerlink" title="错误信息"></a>错误信息</h4><p>修改密码操作必须设置binlog不记录，执行后再打开，否则会引起START GROUP_REPLICATION执行报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ERROR] Plugin group_replication reported: &apos;The member contains transactions not present in the group. The member will now exit the group.&apos;</div><div class="line">[Note] Plugin group_replication reported: &apos;To force this member into the group you can use the group_replication_allow_local_disjoint_gtids_join option&apos;</div></pre></td></tr></table></figure>
<h4 id="解决办法-2"><a href="#解决办法-2" class="headerlink" title="解决办法"></a>解决办法</h4><p><strong>方法一：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000002</div><div class="line">         Position: 150</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set:</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p><strong>方法二</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set global group_replication_allow_local_disjoint_gtids_join=ON;</div></pre></td></tr></table></figure></p>
<p><strong>方法三</strong></p>
<p>如果是全新的实例，可以通过reset master清空Executed_Gtid_Set</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt;reset master</div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000010</div><div class="line">         Position: 1486</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-10</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要描述了MySQL Group Replication 部署中遇到的错误&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/categories/MySQL/Group-Replication/"/>
    
    
  </entry>
  
  <entry>
    <title>Deploying Group Replication in Single-Primary Mode</title>
    <link href="http://wangshengzhuang.com/2017/05/06/MySQL/Group%20Replication/Deploying%20Group%20Replication%20in%20Single-Primary%20Mode/"/>
    <id>http://wangshengzhuang.com/2017/05/06/MySQL/Group Replication/Deploying Group Replication in Single-Primary Mode/</id>
    <published>2017-05-06T15:41:22.000Z</published>
    <updated>2017-05-07T16:12:30.150Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了3实例MySQL Group Replication的搭建过程</p>
<p><img src="http://image.wangshengzhuang.com/c0fb0918de7c170b6d6749896862f7bd.png" alt="MGR"></p>
<a id="more"></a>
<h3 id="一、环境信息"><a href="#一、环境信息" class="headerlink" title="一、环境信息"></a>一、环境信息</h3><table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.84.71</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>172.17.84.72</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>172.17.84.73</td>
<td>mysql003</td>
<td>3</td>
</tr>
</tbody>
</table>
<h3 id="二、搭建前准备"><a href="#二、搭建前准备" class="headerlink" title="二、搭建前准备"></a>二、搭建前准备</h3><ol>
<li>关闭selinux(略)     </li>
<li><p>开启端口3306 33061</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">##Add</div><div class="line">firewall-cmd --permanent --zone=public --add-port=3306/tcp</div><div class="line">firewall-cmd --permanent --zone=public --add-port=33061/tcp</div><div class="line"></div><div class="line">##Reload</div><div class="line">firewall-cmd --reload</div><div class="line"> </div><div class="line">## 检查是否生效</div><div class="line">firewall-cmd --zone=public --query-port=3306/tcp</div><div class="line">firewall-cmd --zone=public --query-port=33061/tcp</div><div class="line"> </div><div class="line">## 列出所有的开放端口</div><div class="line">firewall-cmd --list-all</div></pre></td></tr></table></figure>
</li>
<li><p>配置/etc/hosts ip和主机名对应关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@mysql003 ~]# cat /etc/hosts</div><div class="line">172.17.84.71 mysql001</div><div class="line">172.17.84.72 msyql002</div><div class="line">172.17.84.73 mysql003</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、初始化三个数据库实例"><a href="#三、初始化三个数据库实例" class="headerlink" title="三、初始化三个数据库实例"></a>三、初始化三个数据库实例</h3><h4 id="3-1-初始化3个mysql实例"><a href="#3-1-初始化3个mysql实例" class="headerlink" title="3.1 初始化3个mysql实例"></a>3.1 初始化3个mysql实例</h4><p>mysql001配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">[root@mysql001 ~]# cat /usr/local/mysql/etc/my.cnf</div><div class="line">[client]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/run/mysql.sock</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/run/mysql.sock</div><div class="line">pid_file = /usr/local/mysql/run/mysql.pid</div><div class="line">datadir = /usr/local/mysql/data</div><div class="line">default_storage_engine = InnoDB</div><div class="line">max_allowed_packet = 512M</div><div class="line">max_connections = 2048</div><div class="line">open_files_limit = 65535</div><div class="line"></div><div class="line">lower_case_table_names=1</div><div class="line"></div><div class="line">character-set-server = utf8mb4</div><div class="line">collation-server = utf8mb4_unicode_ci</div><div class="line">init_connect=&apos;SET NAMES utf8mb4&apos;</div><div class="line"></div><div class="line"></div><div class="line">innodb_buffer_pool_size = 1024M</div><div class="line">innodb_log_file_size = 2048M</div><div class="line">innodb_file_per_table = 1</div><div class="line">innodb_flush_log_at_trx_commit = 0</div><div class="line"></div><div class="line"></div><div class="line">key_buffer_size = 64M</div><div class="line"></div><div class="line">log-error = /usr/local/mysql/log/mysql_error.log</div><div class="line">log-bin = /usr/local/mysql/binlogs/mysql-bin</div><div class="line">slow_query_log = 1</div><div class="line">slow_query_log_file = /usr/local/mysql/log/mysql_slow_query.log</div><div class="line">long_query_time = 5</div><div class="line"></div><div class="line"></div><div class="line">tmp_table_size = 32M</div><div class="line">max_heap_table_size = 32M</div><div class="line">query_cache_type = 0</div><div class="line">query_cache_size = 0</div><div class="line"></div><div class="line">server-id=1</div><div class="line">gtid_mode = ON</div><div class="line">enforce_gtid_consistency = ON</div><div class="line">binlog_checksum=NONE</div><div class="line">log_slave_updates = ON</div><div class="line">master_info_repository = TABLE</div><div class="line">relay_log_info_repository = TABLE</div><div class="line"></div><div class="line">transaction_write_set_extraction=XXHASH64</div><div class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</div><div class="line">loose-group_replication_start_on_boot=off</div><div class="line">loose-group_replication_local_address= &quot;172.17.84.71:33061&quot;</div><div class="line">loose-group_replication_group_seeds= &quot;172.17.84.71:33061,172.17.84.72:33061,172.17.84.73:33061&quot;</div><div class="line">loose-group_replication_bootstrap_group= off</div><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure></p>
<p>参数说明见<a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html" target="_blank" rel="external">Group Replication System Variables</a></p>
<p>初始化实例 并启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</div><div class="line">systemctl start mysqld</div></pre></td></tr></table></figure>
<p>到错误日志文件中找到临时密码进行登录，登录后修改临时密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@mysql001 /]# grep &apos;temporary password&apos; /usr/local/mysql/log/mysql_error.log</div><div class="line">2017-04-24T03:37:44.558511Z 1 [Note] A temporary password is generated for root@localhost: 3yFK,#qtjAl;</div></pre></td></tr></table></figure></p>
<p>修改root密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000002</div><div class="line">         Position: 150</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set:</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">ERROR:</div><div class="line">No query specified</div></pre></td></tr></table></figure></p>
<p>修改密码操作必须设置binlog不记录，执行后再打开，否则会引起START GROUP_REPLICATION执行报错。全新的环境可以通过reset master解决这个问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ERROR] Plugin group_replication reported: &apos;The member contains transactions not present in the group. The member will now exit the group.&apos;</div><div class="line">[Note] Plugin group_replication reported: &apos;To force this member into the group you can use the group_replication_allow_local_disjoint_gtids_join option&apos;</div></pre></td></tr></table></figure></p>
<h3 id="四、配置MGR"><a href="#四、配置MGR" class="headerlink" title="四、配置MGR"></a>四、配置MGR</h3><h4 id="4-1-创建复制账号"><a href="#4-1-创建复制账号" class="headerlink" title="4.1 创建复制账号"></a>4.1 创建复制账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos;;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos; IDENTIFIED BY &apos;rpl_pass&apos;;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="4-2-使用change-master命令配置server"><a href="#4-2-使用change-master命令配置server" class="headerlink" title="4.2 使用change master命令配置server"></a>4.2 使用change master命令配置server</h4><p>在下次需要从其他成员恢复其状态时，使用group_replication_recovery复制通道的给定凭据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;rpl_pass&apos;  FOR CHANNEL &apos;group_replication_recovery&apos;;</div><div class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</div></pre></td></tr></table></figure></p>
<h4 id="4-3-安装复制组插件"><a href="#4-3-安装复制组插件" class="headerlink" title="4.3 安装复制组插件"></a>4.3 安装复制组插件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; install plugin group_replication soname &apos;group_replication.so&apos;;</div><div class="line">Query OK, 0 rows affected (0.26 sec)</div></pre></td></tr></table></figure>
<h4 id="4-4-查看插件是否安装成功"><a href="#4-4-查看插件是否安装成功" class="headerlink" title="4.4 查看插件是否安装成功"></a>4.4 查看插件是否安装成功</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show plugins;</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div><div class="line">| Name                       | Status   | Type               | Library              | License |</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div><div class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</div><div class="line">| mysql_native_password      | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div></pre></td></tr></table></figure>
<h4 id="4-5、配置引导组，并启动GROUP-REPLICATION"><a href="#4-5、配置引导组，并启动GROUP-REPLICATION" class="headerlink" title="4.5、配置引导组，并启动GROUP_REPLICATION"></a>4.5、配置引导组，并启动GROUP_REPLICATION</h4><p>此引导应仅有单个server独立完成，该server启动组并且只启动一次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#### 设置group_replication_bootstrap_group 只需要在mysql001上执行一次，另外两个实例不执行这句</div><div class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON;  </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</div></pre></td></tr></table></figure></p>
<p>查看log，发现是白名单问题导致的，my.cnf添加白名单后重新启动组复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set global group_replication_ip_whitelist = &apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">Query OK, 0 rows affected (1.02 sec)</div><div class="line"></div><div class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>直接添加白名单到my.cnf,防止下次启动再重新问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure>
<h4 id="4-6-查看状态"><a href="#4-6-查看状态" class="headerlink" title="4.6 查看状态"></a>4.6 查看状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 60b61f19-289f-11e7-b97d-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">1 row in set (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000003</div><div class="line">         Position: 434</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="4-7-向组中添加实例mysql002-mysql003"><a href="#4-7-向组中添加实例mysql002-mysql003" class="headerlink" title="4.7 向组中添加实例mysql002 mysql003"></a>4.7 向组中添加实例mysql002 mysql003</h4><p>mysql002 mysql003的操作和mysql001相同，除了不需要SET GLOBAL group_replication_bootstrap_group=ON;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">Query OK, 0 rows affected (1.02 sec)</div></pre></td></tr></table></figure>
<p>查看最终状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 80af8598-1520-11e7-a8b9-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | 8abf4eab-1521-11e7-9cc9-080027b95fc4 | mysql002    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | dcd3068d-15bc-11e7-b264-080027dad0d6 | mysql003    |        3306 | ONLINE       |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h4 id="4-8-修改-group-replication-start-on-boot-on"><a href="#4-8-修改-group-replication-start-on-boot-on" class="headerlink" title="4.8 修改 group_replication_start_on_boot=on"></a>4.8 修改 group_replication_start_on_boot=on</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_start_on_boot=on</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-deploying-in-single-primary-mode.html" target="_blank" rel="external">Deploying Group Replication in Single-Primary Mode</a></li>
<li><a href="http://www.niugebbs.com/HRT152/1244148.html" target="_blank" rel="external">http://www.niugebbs.com/HRT152/1244148.html</a></li>
<li><a href="http://blog.csdn.net/dbaxiaosa/article/details/70226540" target="_blank" rel="external">http://blog.csdn.net/dbaxiaosa/article/details/70226540</a></li>
<li><a href="http://hbxflihua.iteye.com/blog/2358031" target="_blank" rel="external">MySQL Group Replication多机多实例安装配置</a></li>
<li><a href="http://fordba.com/mysql-group-replication-install.html" target="_blank" rel="external">MySQL Group Replication 9节点快速部署</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了3实例MySQL Group Replication的搭建过程&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/c0fb0918de7c170b6d6749896862f7bd.png&quot; alt=&quot;MGR&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/categories/MySQL/Group-Replication/"/>
    
    
  </entry>
  
  <entry>
    <title>多节点3实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/05/MySQL/MySQL%20HA/InnoDB%20Cluster/InnoDB%20Cluster%20%E5%A4%9A%E6%9C%BA3%E5%AE%9E%E4%BE%8B%E8%8A%82%E7%82%B9%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/05/MySQL/MySQL HA/InnoDB Cluster/InnoDB Cluster 多机3实例节点搭建过程/</id>
    <published>2017-05-05T13:00:00.000Z</published>
    <updated>2017-05-05T15:38:59.799Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.101</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>192.168.0.102</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>192.168.0.103</td>
<td>mysql003</td>
<td>3</td>
</tr>
<tr>
<td>192.168.0.104</td>
<td>mysql-router</td>
</tr>
</tbody>
</table>
<p><img src="http://image.wangshengzhuang.com/17-5-5/42193296-file_1493993554567_5bbb.png" alt=""></p>
<a id="more"></a>
<p>主要步骤如图所示</p>
<p><img src="http://image.wangshengzhuang.com/17-5-5/60464800-file_1493998183242_301b.png" alt=""></p>
<h3 id="1-安装3个mysql实例"><a href="#1-安装3个mysql实例" class="headerlink" title="1. 安装3个mysql实例"></a>1. 安装3个mysql实例</h3><p>注意：修改root密码时候设置SQL_LOG_BIN=0;此步骤主要是避免Executed_Gtid_Set不一致</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password('admin_123');</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'admin_123' WITH GRANT OPTION;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt;  SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>一句话执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -padmin_123 -e "SET SQL_LOG_BIN=0;GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'admin_123' WITH GRANT OPTION; flush privileges; SET SQL_LOG_BIN=1"</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="3-Configuring-the-Instance"><a href="#3-Configuring-the-Instance" class="headerlink" title="3. Configuring the Instance"></a>3. Configuring the Instance</h3><p>检查并配置3个数据库实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:<span class="number">3306</span></div><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(<span class="string">'root@localhost:3306'</span>)</div><div class="line">mysql-js&gt; dba.configureLocalInstance(<span class="string">'root@localhost:3306'</span>)</div></pre></td></tr></table></figure>
<p>详细过程如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3306&apos; is not valid for Cluster usage.</div><div class="line"></div><div class="line">The following issues were encountered:</div><div class="line"></div><div class="line"> - Some configuration options need to be fixed.</div><div class="line"></div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| Variable                         | Current Value | Required Value | Note                                             |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| binlog_checksum                  | CRC32         | NONE           | Update the server variable or restart the server |</div><div class="line">| enforce_gtid_consistency         | OFF           | ON             | Restart the server                               |</div><div class="line">| gtid_mode                        | OFF           | ON             | Restart the server                               |</div><div class="line">| log_slave_updates                | 0             | ON             | Restart the server                               |</div><div class="line">| master_info_repository           | FILE          | TABLE          | Restart the server                               |</div><div class="line">| relay_log_info_repository        | FILE          | TABLE          | Restart the server                               |</div><div class="line">| transaction_write_set_extraction | OFF           | XXHASH64       | Restart the server                               |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line">Please fix these issues , restart the serverand try again.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;server_update&quot;, </div><div class="line">            &quot;current&quot;: &quot;CRC32&quot;, </div><div class="line">            &quot;option&quot;: &quot;binlog_checksum&quot;, </div><div class="line">            &quot;required&quot;: &quot;NONE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line"></div><div class="line">Detecting the configuration file...</div><div class="line">Default file not found at the standard locations.</div><div class="line">Please specify the path to the MySQL configuration file: /usr/local/mysql/mysql_3306/etc/my.cnf</div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The configuration has been updated but it is required to restart the server.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; systemctl restart mysqld</div></pre></td></tr></table></figure>
<p>重新检查3个实例，确保结果ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  dba.checkInstanceConfiguration(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3306&apos; is valid for Cluster usage</div><div class="line">&#123;</div><div class="line">    &quot;status&quot;: &quot;ok&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-创建-InnoDB-Cluster"><a href="#4-创建-InnoDB-Cluster" class="headerlink" title="4.  创建 InnoDB Cluster"></a>4.  创建 InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3306:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.101:3306</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@192.168.0.101:3306&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="5-添加-Instances-至-InnoDB-Cluster"><a href="#5-添加-Instances-至-InnoDB-Cluster" class="headerlink" title="5.添加 Instances 至 InnoDB Cluster"></a>5.添加 Instances 至 InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.0.101 mysql001</div><div class="line">192.168.0.102 mysql002</div><div class="line">192.168.0.103 mysql003</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.101:3306</div><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.102:3306&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3306&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-持久化配置文件"><a href="#6-持久化配置文件" class="headerlink" title="6. 持久化配置文件"></a>6. 持久化配置文件</h3><p>已经在cluster中的实例，第二次运行dba.configureLocalInstance(‘root@localhost:3306’)，会将配置cluster的配置持久化到my.cnf</p>
<p>必须使用<code>localhost</code>连接后在每个实例单独执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div></pre></td></tr></table></figure>
<h3 id="7-安装配置-MySQL-Router"><a href="#7-安装配置-MySQL-Router" class="headerlink" title="7. 安装配置 MySQL Router"></a>7. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@192.168.0.103:3306 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:devCluster]</div><div class="line">router_id=1</div><div class="line">bootstrap_server_addresses=mysql://192.168.0.101:3306,mysql://192.168.0.102:3306,mysql://192.168.0.103:3306</div><div class="line">user=mysql_router1_m55oiq8bjdry</div><div class="line">metadata_cluster=devCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:devCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:devCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">shell&gt;</span> mysqlsh --uri root@localhost:6446</div><div class="line"><span class="meta">mysql-js&gt;</span> \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line"><span class="meta">mysql-sql&gt;</span> select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3306 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="8-Testing-Failover"><a href="#8-Testing-Failover" class="headerlink" title="8. Testing Failover"></a>8. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 192.168.0.101:3306</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld@3301</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3306 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现192.168.0.102:3306已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@192.168.0.101:3306&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="lhttps://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html" target="_blank" rel="external"> Working with a Production Deployment</a></li>
<li><a href="http://mysqlserverteam.com/mysql-innodb-cluster-real-world-cluster-tutorial-for-oel-fedora-rhel-and-centos/" target="_blank" rel="external">MySQL InnoDB Cluster – Real-World Cluster Tutorial for OEL, Fedora, RHEL and CentOS</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ip地址&lt;/th&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;th&gt;server_id&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.101&lt;/td&gt;
&lt;td&gt;mysql001&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.102&lt;/td&gt;
&lt;td&gt;mysql002&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.103&lt;/td&gt;
&lt;td&gt;mysql003&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.104&lt;/td&gt;
&lt;td&gt;mysql-router&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-5/42193296-file_1493993554567_5bbb.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>单机3实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/04/MySQL/MySQL%20HA/InnoDB%20Cluster/%E5%8D%95%E6%9C%BA3%E5%AE%9E%E4%BE%8B%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/04/MySQL/MySQL HA/InnoDB Cluster/单机3实例搭建InnoDB Cluster环境/</id>
    <published>2017-05-04T13:00:00.000Z</published>
    <updated>2017-05-04T15:08:17.710Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-4/61574976-file_1493910145576_cdbc.png" alt=""></p>
<a id="more"></a>
<blockquote>
<p>This section explains how to set up a single-primary InnoDB cluster and configure MySQL Router to achieve high availability. </p>
<p>This tutorial shows how to use MySQL Shell to create an InnoDB cluster consisting of a MySQL Server instance which provides the seed instance of the InnoDB cluster and holds the initial data set. Two more MySQL server instances are created and added to the InnoDB cluster. Then MySQL Router is deployed and used to route connections to the InnoDB cluster, and high availability is tested. </p>
</blockquote>
<h3 id="1-安装3个mysql实例"><a href="#1-安装3个mysql实例" class="headerlink" title="1. 安装3个mysql实例"></a>1. 安装3个mysql实例</h3><p>注意：修改root密码时候设置SQL_LOG_BIN=0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;admin_123&apos; WITH GRANT OPTION;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt;  SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="3-Configuring-the-Instance"><a href="#3-Configuring-the-Instance" class="headerlink" title="3. Configuring the Instance"></a>3. Configuring the Instance</h3><p>检查并配置3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3301</div><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div></pre></td></tr></table></figure>
<p>详细过程如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3301&apos; is not valid for Cluster usage.</div><div class="line"></div><div class="line">The following issues were encountered:</div><div class="line"></div><div class="line"> - Some configuration options need to be fixed.</div><div class="line"></div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| Variable                         | Current Value | Required Value | Note                                             |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| binlog_checksum                  | CRC32         | NONE           | Update the server variable or restart the server |</div><div class="line">| enforce_gtid_consistency         | OFF           | ON             | Restart the server                               |</div><div class="line">| gtid_mode                        | OFF           | ON             | Restart the server                               |</div><div class="line">| log_slave_updates                | 0             | ON             | Restart the server                               |</div><div class="line">| master_info_repository           | FILE          | TABLE          | Restart the server                               |</div><div class="line">| relay_log_info_repository        | FILE          | TABLE          | Restart the server                               |</div><div class="line">| transaction_write_set_extraction | OFF           | XXHASH64       | Restart the server                               |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line">Please fix these issues , restart the serverand try again.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;server_update&quot;, </div><div class="line">            &quot;current&quot;: &quot;CRC32&quot;, </div><div class="line">            &quot;option&quot;: &quot;binlog_checksum&quot;, </div><div class="line">            &quot;required&quot;: &quot;NONE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line"></div><div class="line">Detecting the configuration file...</div><div class="line">Default file not found at the standard locations.</div><div class="line">Please specify the path to the MySQL configuration file: /usr/local/mysql/mysql_3301/etc/my.cnf</div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The configuration has been updated but it is required to restart the server.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell&gt; systemctl restart mysqld@3301</div><div class="line">shell&gt; systemctl restart mysqld@3302</div><div class="line">shell&gt; systemctl restart mysqld@3303</div></pre></td></tr></table></figure>
<p>重新检查3个实例，确保结果ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3301&apos; is valid for Cluster usage</div><div class="line">&#123;</div><div class="line">    &quot;status&quot;: &quot;ok&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-Creating-the-InnoDB-Cluster"><a href="#4-Creating-the-InnoDB-Cluster" class="headerlink" title="4.  Creating the InnoDB Cluster"></a>4.  Creating the InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3301:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.103:3301</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@192.168.0.103:3301&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="5-Adding-Instances-to-an-InnoDB-Cluster"><a href="#5-Adding-Instances-to-an-InnoDB-Cluster" class="headerlink" title="5. Adding Instances to an InnoDB Cluster"></a>5. Adding Instances to an InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 mysql001</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.103:3301</div><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3302&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3303&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-持久化配置文件"><a href="#6-持久化配置文件" class="headerlink" title="6. 持久化配置文件"></a>6. 持久化配置文件</h3><p>已经在cluster中的实例，第二次运行dba.configureLocalInstance(‘root@localhost:3301’)，会将配置cluster的配置持久化到my.cnf</p>
<p>必须使用<code>localhost</code>连接后在每个实例单独执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3301</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3302</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3302&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3303</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3303&apos;)</div></pre></td></tr></table></figure>
<h3 id="7-安装配置-MySQL-Router"><a href="#7-安装配置-MySQL-Router" class="headerlink" title="7. 安装配置 MySQL Router"></a>7. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@localhost:3301 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:devCluster]</div><div class="line">router_id=1</div><div class="line">bootstrap_server_addresses=mysql://192.168.0.103:3301,mysql://192.168.0.103:3302,mysql://192.168.0.103:3303</div><div class="line">user=mysql_router1_m55oiq8bjdry</div><div class="line">metadata_cluster=devCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:devCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:devCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh --uri root@localhost:6446</div><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3301 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="8-Testing-Failover"><a href="#8-Testing-Failover" class="headerlink" title="8. Testing Failover"></a>8. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 3301</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld@3301</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3302 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现3302实例已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld@3301</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@192.168.0.103:3301&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="lhttps://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html" target="_blank" rel="external"> Working with a Production Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-4/61574976-file_1493910145576_cdbc.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>沙盒实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/03/MySQL/MySQL%20HA/InnoDB%20Cluster/3%E6%B2%99%E7%9B%92%E5%AE%9E%E4%BE%8B%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/03/MySQL/MySQL HA/InnoDB Cluster/3沙盒实例搭建InnoDB Cluster环境/</id>
    <published>2017-05-02T16:00:00.000Z</published>
    <updated>2017-05-04T15:16:41.278Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过三个沙盒msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-4/93088466-file_1493910959566_e506.png" alt=""></p>
<a id="more"></a>
<blockquote>
<p>This section explains how to set up a single-primary InnoDB cluster and configure MySQL Router to achieve high availability. </p>
<p>This tutorial shows how to use MySQL Shell to create an InnoDB cluster consisting of a MySQL Server instance which provides the seed instance of the InnoDB cluster and holds the initial data set. Two more sandbox MySQL server instances are created and added to the InnoDB cluster. Then MySQL Router is deployed and used to route connections to the InnoDB cluster, and high availability is tested. </p>
</blockquote>
<h3 id="1-Yum-安装MySQL-Shell"><a href="#1-Yum-安装MySQL-Shell" class="headerlink" title="1. Yum 安装MySQL Shell"></a>1. Yum 安装MySQL Shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="2-创建三个沙盒实例"><a href="#2-创建三个沙盒实例" class="headerlink" title="2. 创建三个沙盒实例"></a>2. 创建三个沙盒实例</h3><p>Start MySQL Shell </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh</div></pre></td></tr></table></figure>
<p>MySQL Shell provides two scripting languages: JavaScript and Python. Throughout this guide MySQL Shell is used primarily in JavaScript mode . When MySQL Shell starts it is in JavaScript mode by default. You switch into JavaScript mode, Python mode and SQL mode using the commands <code>\js</code>, <code>\py</code>, and <code>\sql</code>. Ensure you are in JavaScript mode by issuing the <code>\js</code> command, then execute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.deploySandboxInstance(3310)</div><div class="line">mysql-js&gt; dba.deploySandboxInstance(3320)</div><div class="line">mysql-js&gt; dba.deploySandboxInstance(3330)</div></pre></td></tr></table></figure>
<h3 id="3-Creating-the-InnoDB-Cluster"><a href="#3-Creating-the-InnoDB-Cluster" class="headerlink" title="3.  Creating the InnoDB Cluster"></a>3.  Creating the InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3310:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3310</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@localhost:3310&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="4-Adding-Instances-to-an-InnoDB-Cluster"><a href="#4-Adding-Instances-to-an-InnoDB-Cluster" class="headerlink" title="4. Adding Instances to an InnoDB Cluster"></a>4. Adding Instances to an InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 mysql001</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.addInstance(&apos;root@localhost:3320&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.addInstance(&apos;root@localhost:3330&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3310&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-安装配置-MySQL-Router"><a href="#5-安装配置-MySQL-Router" class="headerlink" title="5. 安装配置 MySQL Router"></a>5. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@localhost:3310 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:testCluster]</div><div class="line">router_id=3</div><div class="line">bootstrap_server_addresses=mysql://localhost:3310,mysql://localhost:3320,mysql://localhost:3330</div><div class="line">user=mysql_router3_c3j5z9t7rjgk</div><div class="line">metadata_cluster=testCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:testCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://testCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:testCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://testCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:testCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://testCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:testCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://testCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh --uri root@localhost:6446</div><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3310 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="6-Testing-Failover"><a href="#6-Testing-Failover" class="headerlink" title="6. Testing Failover"></a>6. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 3310</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.killSandboxInstance(3310)</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3330 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现3320实例已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3320&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.startSandboxInstance(3310)</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@localhost:3310&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3320&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-getting-started.html" target="_blank" rel="external"> Getting Started with InnoDB Cluster</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过三个沙盒msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-4/93088466-file_1493910959566_e506.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDB Cluster简介</title>
    <link href="http://wangshengzhuang.com/2017/05/02/MySQL/MySQL%20HA/InnoDB%20Cluster/InnoDB%20Cluster%E7%AE%80%E4%BB%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/02/MySQL/MySQL HA/InnoDB Cluster/InnoDB Cluster简介/</id>
    <published>2017-05-01T16:00:00.000Z</published>
    <updated>2017-05-05T15:23:53.587Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、InnoDB-Cluster简介"><a href="#一、InnoDB-Cluster简介" class="headerlink" title="一、InnoDB Cluster简介"></a>一、InnoDB Cluster简介</h3><p>前几天 Mysql 团队愉快的发布了 InnoDB Cluster 的 GA（General Availability 正式发布） 版本</p>
<p>InnoDB Cluster 是 Mysql 的一套完整的高可用解决方案</p>
<blockquote>
<p>MySQL InnoDB cluster is a collection of products that work together to provide a complete High Availability solution for MySQL.</p>
</blockquote>
<p><img src="http://image.wangshengzhuang.com/0acc4ee7b48fa39a7685491e99bbccfb.png" alt=""></p>
<a id="more"></a>
<p>InnoDB Cluster 由下面3个核心组件构成：</p>
<ul>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-shell.html" target="_blank" rel="external">MySQL Shell</a>    通过内置的 AdminAPI 来创建和管理整个 InnoDB Clusters</p>
<blockquote>
<p>Includes the AdminAPI, which enables you to script the creation and administration of an InnoDB cluster, using either JavaScript or Python.</p>
</blockquote>
</li>
<li><p><a href="https://dev.mysql.com/doc/mysql-router/2.1/en/" target="_blank" rel="external">MySQL Router</a>   缓存 InnoDB cluster 的元数据，负责把 client 的 read/write 请求路由到当前的主数据库节点，还可以对 client 的请求进行负载均衡，并且在主数据库节点出现故障时，保证 client 的请求被路由到新的主服务器节点</p>
<blockquote>
<p>Caches the metadata of the InnoDB cluster and routes read/write client requests to the current primary. If the primary instance becomes unavailable, MySQL Router automatically routes client requests to a promoted secondary (the new primary). </p>
</blockquote>
</li>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication.html" target="_blank" rel="external"><em>Group Replication</em></a>  MySQL Server 5.7.17 or higher. 可以把数据同步到集群内的所有成员中，并支持 <strong>容错</strong> 、 <strong>自动故障转移</strong> 、 <strong>灵活扩展</strong>   等重要特性</p>
<blockquote>
<p>This provides the MySQL Group Replication mechanism to allow data to be replicated within the cluster, with built-in failover. Group Replication </p>
</blockquote>
<p><img src="http://image.wangshengzhuang.com/17-5-3/23165946-file_1493815367505_f827.png" alt=""></p>
<p>​</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、InnoDB-Cluster简介&quot;&gt;&lt;a href=&quot;#一、InnoDB-Cluster简介&quot; class=&quot;headerlink&quot; title=&quot;一、InnoDB Cluster简介&quot;&gt;&lt;/a&gt;一、InnoDB Cluster简介&lt;/h3&gt;&lt;p&gt;前几天 Mysql 团队愉快的发布了 InnoDB Cluster 的 GA（General Availability 正式发布） 版本&lt;/p&gt;
&lt;p&gt;InnoDB Cluster 是 Mysql 的一套完整的高可用解决方案&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;MySQL InnoDB cluster is a collection of products that work together to provide a complete High Availability solution for MySQL.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/0acc4ee7b48fa39a7685491e99bbccfb.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://wangshengzhuang.com/2017/05/01/hello-world/"/>
    <id>http://wangshengzhuang.com/2017/05/01/hello-world/</id>
    <published>2017-04-30T16:00:00.000Z</published>
    <updated>2017-05-03T15:38:44.674Z</updated>
    
    <content type="html"><![CDATA[<p>今天是五一劳动节，我的新Blog诞生了。希望在新的一年里，能在此认认真真的记录自己的成长！</p>
<p><img src="http://image.wangshengzhuang.com/17-5-1/18885308-file_1493622006489_1591c.jpg" alt=""></p>
<a id="more"></a>
<p>目标：每天一篇学习笔记</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天是五一劳动节，我的新Blog诞生了。希望在新的一年里，能在此认认真真的记录自己的成长！&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-1/18885308-file_1493622006489_1591c.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
</feed>
