<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>小强斋太-Study Notes</title>
  <subtitle>Stay hungry. Stay foolish</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://wangshengzhuang.com/"/>
  <updated>2017-06-07T15:00:06.669Z</updated>
  <id>http://wangshengzhuang.com/</id>
  
  <author>
    <name>小强斋太</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>rmdir命令</title>
    <link href="http://wangshengzhuang.com/2017/05/20/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/rmdir%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/20/Linux/每天一个Linux命令/rmdir命令/</id>
    <published>2017-05-20T14:55:56.000Z</published>
    <updated>2017-06-07T15:00:06.669Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a>
<h3 id="1、命令简介"><a href="#1、命令简介" class="headerlink" title="1、命令简介"></a>1、命令简介</h3><p><strong>rmdir</strong> (Remove Directory删除目录): 用来删除空目录，删除某目录时也必须具有对父目录的写权限。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">用法：rmdir [选项]... 目录...</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">--ignore-fail-on-non-empty  忽略仅由目录非空产生的所有错误</div><div class="line">-p, –parents              删除指定目录及其上级文件夹，例如&quot;rmdir -p a/b/c&apos;&quot;  与&quot;rmdir a/b/c a/b a&apos;&quot; 基本相同</div><div class="line">-v, –verbose              输出处理的目录详情</div></pre></td></tr></table></figure>
<h3 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h3><h4 id="实例1：删除一个空目录"><a href="#实例1：删除一个空目录" class="headerlink" title="实例1：删除一个空目录"></a>实例1：删除一个空目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# rmdir dir1</div></pre></td></tr></table></figure>
<h4 id="实例2：删除空目录显示信息"><a href="#实例2：删除空目录显示信息" class="headerlink" title="实例2：删除空目录显示信息"></a>实例2：删除空目录显示信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# rmdir -v dir3</div><div class="line">rmdir: 正在删除目录 "dir3"</div></pre></td></tr></table></figure>
<h4 id="实例3：删除一个非空目录"><a href="#实例3：删除一个非空目录" class="headerlink" title="实例3：删除一个非空目录"></a>实例3：删除一个非空目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# rmdir -v dir2</div><div class="line">rmdir: 正在删除目录 "dir2"</div><div class="line">rmdir: 删除 "dir2" 失败: 目录非空</div></pre></td></tr></table></figure>
<h4 id="实例4：若父目录为空，则递归删除父目录"><a href="#实例4：若父目录为空，则递归删除父目录" class="headerlink" title="实例4：若父目录为空，则递归删除父目录"></a>实例4：若父目录为空，则递归删除父目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# rmdir -pv dir1/sub1/sub2</div><div class="line">rmdir: 正在删除目录 "dir1/sub1/sub2"</div><div class="line">rmdir: 正在删除目录 "dir1/sub1"</div><div class="line">rmdir: 正在删除目录 "dir1"</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;1、命令简介&quot;&gt;&lt;a href=&quot;#1、命令简介&quot; class=&quot;headerlink&quot; title=&quot;1、命令简介&quot;&gt;&lt;/a&gt;1、命令简介&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;rmdir&lt;/strong&gt; (Remove Direc
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="rmdir" scheme="http://wangshengzhuang.com/tags/rmdir/"/>
    
  </entry>
  
  <entry>
    <title>mkdir命令</title>
    <link href="http://wangshengzhuang.com/2017/05/19/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/mkdir%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/19/Linux/每天一个Linux命令/mkdir命令/</id>
    <published>2017-05-19T14:43:25.000Z</published>
    <updated>2017-06-07T14:56:16.022Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a>
<h3 id="1、命令简介"><a href="#1、命令简介" class="headerlink" title="1、命令简介"></a>1、命令简介</h3><p><strong>mkdir</strong> (Make Directory 创建目录): 若指定目录不存在则创建目录。在创建目录时，要求创建目录的用户具有写权限，并应保证新建的目录没有重名。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">用法：mkdir [选项]... 目录...</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-m, --mode=模式       设置权限模式(类似chmod)，而不是rwxrwxrwx 减umask</div><div class="line">-p, --parents        需要时创建目标目录的上层目录，但即使这些目录已存在也不当作错误处理</div><div class="line">-v, --verbose        每次创建新目录都显示信息</div><div class="line">-Z, --context=CTX      将每个创建的目录的SELinux 安全环境设置为CTX</div></pre></td></tr></table></figure>
<h3 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h3><h4 id="实例1：创建一个空目录"><a href="#实例1：创建一个空目录" class="headerlink" title="实例1：创建一个空目录"></a>实例1：创建一个空目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir dir1</div><div class="line">[root@oracledb study]# ls</div><div class="line">dir1</div></pre></td></tr></table></figure>
<h4 id="实例2：一次创建多个目录"><a href="#实例2：一次创建多个目录" class="headerlink" title="实例2：一次创建多个目录"></a>实例2：一次创建多个目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir dir1 dir2 dir3</div><div class="line">[root@oracledb study]# ls</div><div class="line">dir1  dir2  dir3</div></pre></td></tr></table></figure>
<h4 id="实例3：递归创建多个目录"><a href="#实例3：递归创建多个目录" class="headerlink" title="实例3：递归创建多个目录"></a>实例3：递归创建多个目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir -p dir1/sub1/sub2</div><div class="line">[root@oracledb study]# tree</div><div class="line">.</div><div class="line">└── dir1</div><div class="line">    └── sub1</div><div class="line">        └── sub2</div><div class="line"></div><div class="line">3 directories, 0 files</div></pre></td></tr></table></figure>
<h4 id="实例4：创建权限为755的目录"><a href="#实例4：创建权限为755的目录" class="headerlink" title="实例4：创建权限为755的目录"></a>实例4：创建权限为755的目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir -m 755 dir1</div><div class="line">[root@oracledb study]# ls</div><div class="line">drwxr-xr-x 2 root root 4096 4月  16 15:03 dir1</div></pre></td></tr></table></figure>
<h4 id="实例5：创建新目录都显示信息"><a href="#实例5：创建新目录都显示信息" class="headerlink" title="实例5：创建新目录都显示信息"></a>实例5：创建新目录都显示信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir -v dir3</div><div class="line">mkdir: 已创建目录 "dir3"</div></pre></td></tr></table></figure>
<h4 id="实例6：一个命令创建项目的目录结构"><a href="#实例6：一个命令创建项目的目录结构" class="headerlink" title="实例6：一个命令创建项目的目录结构"></a>实例6：一个命令创建项目的目录结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@oracledb study]# mkdir -vp tomcat/&#123;bin,lib,conf,logs,webapps/&#123;examples,docs&#125;,work&#125;</div><div class="line">mkdir: 已创建目录 "tomcat"</div><div class="line">mkdir: 已创建目录 "tomcat/bin"</div><div class="line">mkdir: 已创建目录 "tomcat/lib"</div><div class="line">mkdir: 已创建目录 "tomcat/conf"</div><div class="line">mkdir: 已创建目录 "tomcat/logs"</div><div class="line">mkdir: 已创建目录 "tomcat/webapps"</div><div class="line">mkdir: 已创建目录 "tomcat/webapps/examples"</div><div class="line">mkdir: 已创建目录 "tomcat/webapps/docs"</div><div class="line">mkdir: 已创建目录 "tomcat/work"</div><div class="line">[root@oracledb study]# tree</div><div class="line">.</div><div class="line">└── tomcat</div><div class="line">    ├── bin</div><div class="line">    ├── conf</div><div class="line">    ├── lib</div><div class="line">    ├── logs</div><div class="line">    ├── webapps</div><div class="line">    │   ├── docs</div><div class="line">    │   └── examples</div><div class="line">    └── work</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;1、命令简介&quot;&gt;&lt;a href=&quot;#1、命令简介&quot; class=&quot;headerlink&quot; title=&quot;1、命令简介&quot;&gt;&lt;/a&gt;1、命令简介&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;mkdir&lt;/strong&gt; (Make Directo
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="mkdir" scheme="http://wangshengzhuang.com/tags/mkdir/"/>
    
  </entry>
  
  <entry>
    <title>Playbook 角色(Roles) 和 Include 语句</title>
    <link href="http://wangshengzhuang.com/2017/05/18/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Playbook%20%E8%A7%92%E8%89%B2(Roles)%20%E5%92%8C%20Include%20%E8%AF%AD%E5%8F%A5/"/>
    <id>http://wangshengzhuang.com/2017/05/18/运维相关/Ansible/Playbook 角色(Roles) 和 Include 语句/</id>
    <published>2017-05-18T15:26:47.000Z</published>
    <updated>2017-05-23T14:50:07.420Z</updated>
    
    <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a><a href="http://www.ansible.com.cn/docs/playbooks_roles.html#id6" target="_blank" rel="external">简介</a></h3><p>当我们刚开始学习运用 playbook 时，可能会把 playbook 写成一个很大的文件，到后来可能你会希望这些文件是可以方便去重用的，所以需要重新去组织这些文件。</p>
<a id="more"></a>  
<h3 id="Include-语句"><a href="#Include-语句" class="headerlink" title="Include 语句"></a><a href="http://www.ansible.com.cn/docs/playbooks_roles.html#id5" target="_blank" rel="external">Include 语句</a></h3><p>基本上，使用 include 语句引用 task 文件的方法，可允许你将一个配置策略分解到更小的文件中。使用 include 语句引用 tasks 是将 tasks 从其他文件拉取过来。因为 handlers 也是 tasks，所以你也可以使用 include 语句去引用 handlers 文件。</p>
<p>Playbook 同样可以使用 include 引用其他 playbook 文件中的 play。这时被引用的 play 会被插入到当前的 playbook 中，当前的 playbook 中就有了一个更长的的 play 列表。Include 指令看起来像下面这样，在一个 playbook 中，Include 指令可以跟普通的 task 混合在一起使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line"></div><div class="line">  - include: tasks/foo.yml</div></pre></td></tr></table></figure>
<p>你也可以给 include 传递变量。我们称之为 ‘参数化的 include’。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line">  - include: wordpress.yml wp_user=timmy</div></pre></td></tr></table></figure>
<h3 id="Playbook-角色-Roles"><a href="#Playbook-角色-Roles" class="headerlink" title="Playbook 角色(Roles)"></a><a href="http://www.ansible.com.cn/docs/playbooks_roles.html#id5" target="_blank" rel="external">Playbook 角色(Roles)</a></h3><p>那怎样组织 playbook 才是最好的方式呢？简单的回答就是：使用 roles ! Roles 的概念来自于这样的想法：通过 include 包含文件并将它们组合在一起，组织成一个简洁、可重用的抽象对象。这种方式可使你将注意力更多地放在大局上，只有在需要时才去深入了解细节。Roles 基于一个已知的文件结构，去自动的加载某些 vars_files，tasks 以及 handlers。基于 roles 对内容进行分组，使得我们可以容易地与其他用户分享 roles 。</p>
<!-- more -->
<p><img src="http://image.wangshengzhuang.com/17-05-23/1495543493176.jpg" alt="img"></p>
<p>这个 playbook 为一个角色 ‘x’ 指定了如下的行为：</p>
<ul>
<li>如果 roles/x/tasks/main.yml 存在, 其中列出的 tasks 将被添加到 play 中</li>
<li>如果 roles/x/handlers/main.yml 存在, 其中列出的 handlers 将被添加到 play 中</li>
<li>如果 roles/x/vars/main.yml 存在, 其中列出的 variables 将被添加到 play 中</li>
<li>如果 roles/x/meta/main.yml 存在, 其中列出的 “角色依赖” 将被添加到 roles 列表中 (1.3 and later)</li>
<li>所有 copy tasks 可以引用 roles/x/files/ 中的文件，不需要指明文件的路径。</li>
<li>所有 script tasks 可以引用 roles/x/files/ 中的脚本，不需要指明文件的路径。</li>
<li>所有 template tasks 可以引用 roles/x/templates/ 中的文件，不需要指明文件的路径。</li>
<li>所有 include tasks 可以引用 roles/x/tasks/ 中的文件，不需要指明文件的路径。</li>
</ul>
<h3 id="角色依赖-Role-Dependencies"><a href="#角色依赖-Role-Dependencies" class="headerlink" title="角色依赖(Role Dependencies)"></a><a href="http://www.ansible.com.cn/docs/playbooks_roles.html#id10" target="_blank" rel="external">角色依赖(Role Dependencies)</a></h3><p>“角色依赖” 使你可以自动地将其他 roles 拉取到现在使用的 role 中。”角色依赖” 保存在 roles 目录下的 meta/main.yml 文件中。这个文件应包含一列 roles 和 为之指定的参数，</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://www.ansible.com.cn/docs/playbooks_roles.html#id6&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;简介&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;当我们刚开始学习运用 playbook 时，可能会把 playbook 写成一个很大的文件，到后来可能你会希望这些文件是可以方便去重用的，所以需要重新去组织这些文件。&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible Playbook</title>
    <link href="http://wangshengzhuang.com/2017/05/17/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ansilbe%20Playbook/"/>
    <id>http://wangshengzhuang.com/2017/05/17/运维相关/Ansible/Ansilbe Playbook/</id>
    <published>2017-05-17T15:26:47.000Z</published>
    <updated>2017-05-23T14:07:09.954Z</updated>
    
    <content type="html"><![CDATA[<p>Playbooks 是 Ansible的配置,部署,编排语言.他们可以被描述为一个需要希望远程主机执行命令的方案,或者一组IT程序运行的命令集合.</p>
<a id="more"></a>
<p>Playbooks 的格式是YAML 语法做到最小化,意在避免 playbooks 成为一种编程语言或是脚本</p>
<p>playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’ 为元素的列表.play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible 模块的调用。playbook命令根据自上而下的顺序依次执行。‘plays’ 好似音符,playbook 好似由 ‘plays’ 构成的曲谱,通过 playbook,可以编排步骤进行多机器的部署,比如在 webservers 组的所有机器上运行一定的步骤, 然后在 database server 组运行一些步骤,最后回到 webservers 组,再运行一些步骤,诸如此类.使得你可以实现一些复杂的部署机制,这是ansible命令无法实现的。</p>
<p>playbook通过ansible-playbook命令使用,它的参数和ansible命令类似,ansible-playbook的简单使用方法: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook example-play.yml</div></pre></td></tr></table></figure>
<h3 id="一、一个简单的示例"><a href="#一、一个简单的示例" class="headerlink" title="一、一个简单的示例"></a>一、一个简单的示例</h3><p>下面是一个简单的ansible-playbook示例，可以了解其构成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  vars:</div><div class="line">    http_port: 80</div><div class="line">    max_clients: 200</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">  - name: ensure apache is at the latest version</div><div class="line">    yum: pkg=httpd state=latest</div><div class="line">  - name: write the apache config file</div><div class="line">    template: src=/srv/httpd.j2 dest=/etc/httpd.conf</div><div class="line">    notify:</div><div class="line">    - restart apache</div><div class="line">  - name: ensure apache is running</div><div class="line">    service: name=httpd state=started</div><div class="line">  handlers:</div><div class="line">    - name: restart apache</div><div class="line">      service: name=httpd state=restarted</div></pre></td></tr></table></figure>
<h3 id="二、playbook的构成"><a href="#二、playbook的构成" class="headerlink" title="二、playbook的构成"></a>二、playbook的构成</h3><p>playbook 由一个或多个 ‘plays’ 组成.它的内容是一个以 ‘plays’ 为元素的列表.play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible 模块的调用。将多个play组织在一个playbook中即可以让它们联同起来按事先编排的机制同唱一台大戏。其主要有以下四部分构成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">playbooks组成：</div><div class="line">  Target section：   定义将要执行 playbook 的远程主机组</div><div class="line">  Variable section： 定义 playbook 运行时需要使用的变量</div><div class="line">  Task section：     定义将要在远程主机上执行的任务列表</div><div class="line">  Handler section：  定义 task 执行完成以后需要调用的任务</div></pre></td></tr></table></figure>
<p>而其对应的目录层为五个，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">一般所需的目录层有：(视情况可变化)</div><div class="line">  vars     变量层</div><div class="line">  tasks    任务层</div><div class="line">  handlers 触发条件</div><div class="line">  files    文件</div><div class="line">  template 模板</div></pre></td></tr></table></figure>
<h4 id="1、Hosts和Users"><a href="#1、Hosts和Users" class="headerlink" title="1、Hosts和Users"></a>1、Hosts和Users</h4><p>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务。</p>
<ul>
<li>hosts：用于指定要执行指定任务的主机其可以是一个或多个由冒号分隔主机组。</li>
<li>remote_user ：用于指定远程主机上的执行任务的用户。不过remote_user也可用于各task中。也可以通过指定其通过sudo的方式在远程主机上执行任务其可用于play全局或某任务。此外甚至可以在sudo时使用sudo_user指定sudo时切换的用户。</li>
<li>user：于remote_user相同</li>
<li>sudo：如果设置为yes，执行该任务组的用户在执行任务的时候，获取root权限</li>
<li>sudo_user：如果设置user为breeze，sudo为yes，sudo_user为bernie时，则breeze用户在执行任务时会获得bernie用户的权限</li>
<li>gather_facts：除非明确说明不需要在远程主机上执行setup模块，否则默认自动执行。如果确实不需要setup模块传递过来的变量，则可以将该选项设置为False</li>
</ul>
<h4 id="2、任务列表和action"><a href="#2、任务列表和action" class="headerlink" title="2、任务列表和action"></a>2、任务列表和action</h4><p>play的主体部分是任务列表。任务列表中的各任务按次序逐个在hosts中指定的所有主机上执行即在所有主机上完成第一个任务后再开始第二个。在自上而下运行某playbook时如果中途发生错误，所有已执行任务都将回滚因此在更正playbook后重新执行一次即可。 </p>
<p>​ task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致。module 具有”幂等”性,所以当远端系统被人改动时,可以重放 playbooks 达到恢复的目的. playbooks 本身可以识别这种改动,并且有一个基本的 event system（事件系统）,可以响应这种改动.</p>
<p>每个task都应该有其name用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name则action的结果将用于输出。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line">  - name: make sure apache is running</div><div class="line">    service: name=httpd state=running</div></pre></td></tr></table></figure>
<p>如果命令或脚本的退出码不为零可以使用如下方式替代</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line">  - name: run this command and ignore the result</div><div class="line">    shell: /usr/bin/somecommand || /bin/true</div></pre></td></tr></table></figure>
<p>使用ignore_errors来忽略错误信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line">  - name: run this command and ignore the result</div><div class="line">    shell: /usr/bin/somecommand</div><div class="line">    ignore_errors: True</div></pre></td></tr></table></figure>
<h4 id="3、handlers：-在发生改变时执行的操作"><a href="#3、handlers：-在发生改变时执行的操作" class="headerlink" title="3、handlers： 在发生改变时执行的操作"></a>3、handlers： 在发生改变时执行的操作</h4><p>“notify”这个action可用于在每个play的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，取而代之仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler也即notify中调用handler中定义的操作。 </p>
<p>注意：在notify中定义内容一定要和tasks中定义的 - name 内容一样，这样才能达到触发的效果，否则会不生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- name: template configuration file</div><div class="line">  template: src=template.j2 dest=/etc/foo.conf</div><div class="line">  notify:</div><div class="line">  - restart memcached</div><div class="line">  - restart apache</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#handler是task列表这些task与前述的task并没有本质上的不同。</div><div class="line">handlers:</div><div class="line">  - name: restart memcached</div><div class="line">    service: name=memcached state=restarted</div><div class="line">  - name: restart apache</div><div class="line">    service: name=apache state=restarted</div></pre></td></tr></table></figure>
<h4 id="4、tags"><a href="#4、tags" class="headerlink" title="4、tags"></a>4、tags</h4><p>tags用于让用户选择运行或略过playbook中的部分代码。ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时如果确信其没有变化就可以通过tags跳过这些代码片断。</p>
<h3 id="三、列出影响的主机"><a href="#三、列出影响的主机" class="headerlink" title="三、列出影响的主机"></a>三、列出影响的主机</h3><p>在执行一个 playbook 之前,想看看这个 playbook 的执行会影响到哪些 hosts,你可以这样做:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook playbook.yml --list-hosts</div></pre></td></tr></table></figure>
<h3 id="执行一个-playbook"><a href="#执行一个-playbook" class="headerlink" title="执行一个 playbook"></a>执行一个 playbook</h3><p>如何运行一个 playbook 呢？这很简单,这里的示例是并行的运行 playbook,并行的级别 是10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible-playbook playbook.yml -f 10</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Playbooks 是 Ansible的配置,部署,编排语言.他们可以被描述为一个需要希望远程主机执行命令的方案,或者一组IT程序运行的命令集合.&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>ad-hoc命令</title>
    <link href="http://wangshengzhuang.com/2017/05/16/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ad-hoc%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9D%97/"/>
    <id>http://wangshengzhuang.com/2017/05/16/运维相关/Ansible/Ad-hoc与命令执行模块/</id>
    <published>2017-05-16T15:26:47.000Z</published>
    <updated>2017-05-23T14:01:57.134Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍了ansible的Ad-hoc命令。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg" alt=""></p>
<a id="more"></a>
<p>Ansible提供两种方式去完成任务,一是 ad-hoc 命令,一是写 Ansible playbook.前者可以解决一些简单的任务, 后者解决较复杂的任务.</p>
<p>ad-hoc 是相对于写 Ansible playbook 来说的.类似于在命令行敲入shell命令和 写shell scripts两者之间的关系。 </p>
<p> Ad-Hoc 是指ansible下临时执行的一条命令，并且不需要保存的命令，对于复杂的命令会使用playbook。那我们会在什么情境下去使用ad-hoc 命令呢?比如说因为圣诞节要来了,想要把所有实验室的电源关闭,我们只需要执行一行命令 就可以达成这个任务,而不需要写 playbook 来做这个任务.至于说做配置管理或部署这种事,还是要借助 playbook 来完成,即使用 ‘/usr/bin/ansible-playbook’ 这个命令.</p>
<p>Ad-hoc的执行依赖于模块，ansible官方提供了大量的模块。 如：command、raw、shell、file、cron等，具体可以通过ansible-doc -l 进行查看 。</p>
<h3 id="一、Ad-hoc命令"><a href="#一、Ad-hoc命令" class="headerlink" title="一、Ad-hoc命令"></a>一、Ad-hoc命令</h3><h4 id="1-1、命令格式说明"><a href="#1-1、命令格式说明" class="headerlink" title="1.1、命令格式说明"></a>1.1、命令格式说明</h4><p>一个ad-hoc命令的执行，需要按以下格式进行执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible 主机或组 -m 模块名  -a &apos;模块参数&apos;  ansible参数</div></pre></td></tr></table></figure>
<ul>
<li>主机和组，是在/etc/ansible/hosts 里进行指定的部分，当然动态Inventory 使用的是脚本从外部应用里获取的主机；</li>
<li>模块名，可以通过ansible-doc -l 查看目前安装的模块，默认不指定时，使用的是command模块，具体可以查看/etc/ansible/ansible.cfg 的<code>module_name = command</code> 部分，默认模块可以在该配置文件中进行修改；</li>
<li>模块参数，可以通过 “ansible-doc -s 模块名” 查看具体的用法及后面的参数；</li>
<li>ansible参数，可以通过ansible命令的帮助信息里查看到，这里有很多参数可以供选择，如是否需要输入密码、是否sudo等。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ansible all -m ping</div><div class="line">ansible all -m command -a &apos;uptime&apos;</div><div class="line">ansible all -m yum -a &apos;name=nginx state=latest&apos;</div><div class="line">ansible all -m service -a &quot;name=nginx state=started enabled=yes“</div><div class="line">ansible all -m shell -a &apos;systemctl status nginx&apos;</div><div class="line">ansible all -m shell -a &apos;systemctl list-unit-files|grep nginx&apos;</div></pre></td></tr></table></figure>
<h4 id="1-2、后台执行"><a href="#1-2、后台执行" class="headerlink" title="1.2、后台执行"></a>1.2、后台执行</h4><p>当命令执行时间比较长时，也可以放到后台执行，使用-B、-P参数，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ansible all -B 3600 -a &quot;/usr/bin/long_running_operation --do-stuff&quot;   #后台执行命令3600s，-B 表示后台执行的时间, 命令会返回一个jid</div><div class="line">ansible all -m async_status -a &quot;jid=123456789&quot;  #检查任务的状态</div><div class="line">ansible all -B 1800 -P 60 -a &quot;/usr/bin/long_running_operation --do-stuff&quot; #后台执行命令最大时间是1800s即30分钟，-P 每60s检查下状态，默认15s</div></pre></td></tr></table></figure>
<h4 id="1-3、查看所有模块"><a href="#1-3、查看所有模块" class="headerlink" title="1.3、查看所有模块"></a>1.3、查看所有模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]# ansible-doc -l |wc -l</div><div class="line">773</div></pre></td></tr></table></figure>
<h3 id="二、使用ansible-doc-查看模块使用方法"><a href="#二、使用ansible-doc-查看模块使用方法" class="headerlink" title="二、使用ansible-doc 查看模块使用方法"></a>二、使用ansible-doc 查看模块使用方法</h3><p>可以使用ansible-doc -s module来查看某个模块的参数，也可以使用ansible-doc help module来查看该模块更详细的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[root@ansible ansible]# ansible-doc command</div><div class="line">&gt; COMMAND</div><div class="line"></div><div class="line">  The [command] module takes the command name followed by a list of space-delimited arguments. The given command will be executed on all</div><div class="line">  selected nodes. It will not be processed through the shell, so variables like `$HOME&apos; and operations like `&quot;&lt;&quot;&apos;, `&quot;&gt;&quot;&apos;, `&quot;|&quot;&apos;, `&quot;;&quot;&apos; and</div><div class="line">  `&quot;&amp;&quot;&apos; will not work (use the [shell] module if you need these features).</div><div class="line"></div><div class="line">Options (= is mandatory):</div><div class="line"></div><div class="line">- chdir</div><div class="line">        cd into this directory before running the command</div><div class="line">        [Default: None]</div><div class="line">- creates</div><div class="line">        a filename or (since 2.0) glob pattern, when it already exists, this step will *not* be run.</div><div class="line">        [Default: None]</div><div class="line">- executable</div><div class="line">        change the shell used to execute the command. Should be an absolute path to the executable.</div><div class="line">        [Default: None]</div><div class="line">= free_form</div><div class="line">        the command module takes a free form command to run.  There is no parameter actually named &apos;free form&apos;. See the examples!</div><div class="line">        [Default: None]</div><div class="line">- removes</div><div class="line">        a filename or (since 2.0) glob pattern, when it does not exist, this step will *not* be run.</div><div class="line">        [Default: None]</div><div class="line">- warn</div><div class="line">        if command warnings are on in ansible.cfg, do not warn about this particular line if set to no/false.</div><div class="line">        [Default: True]</div><div class="line">Notes:</div><div class="line">  * If you want to run a command through the shell (say you are using `&lt;&apos;, `&gt;&apos;, `|&apos;, etc), you actually want the [shell] module</div><div class="line">        instead. The [command] module is much more secure as it&apos;s not affected by the user&apos;s environment.</div><div class="line">  *  `creates&apos;, `removes&apos;, and `chdir&apos; can be specified after the command. For instance, if you only want to run a command if a</div><div class="line">        certain file does not exist, use this.</div><div class="line">EXAMPLES:</div><div class="line"># Example from Ansible Playbooks.</div><div class="line">- command: /sbin/shutdown -t now</div><div class="line"></div><div class="line"># Run the command if the specified file does not exist.</div><div class="line">- command: /usr/bin/make_database.sh arg1 arg2 creates=/path/to/database</div><div class="line"></div><div class="line"># You can also use the &apos;args&apos; form to provide the options. This command</div><div class="line"># will change the working directory to somedir/ and will only run when</div><div class="line"># /path/to/database doesn&apos;t exist.</div><div class="line">- command: /usr/bin/make_database.sh arg1 arg2</div><div class="line">  args:</div><div class="line">    chdir: somedir/</div><div class="line">    creates: /path/to/database</div></pre></td></tr></table></figure>
<h3 id="三、命令执行模块"><a href="#三、命令执行模块" class="headerlink" title="三、命令执行模块"></a>三、命令执行模块</h3><p>命令执行模块包含如下 四个模块：</p>
<ul>
<li><a href="http://docs.ansible.com/command_module.html" target="_blank" rel="external">command模块</a>：该模块通过-a跟上要执行的命令可以直接执行</li>
<li><a href="http://docs.ansible.com/shell_module.html" target="_blank" rel="external">shell 模块</a>：用法基本和command一样，不过其是通过/bin/sh进行执行，所以shell 模块可以执行任何命令，就像在本机执行一样；</li>
<li><a href="http://docs.ansible.com/raw_module.html" target="_blank" rel="external">raw模块</a>：用法和shell 模块一样 ，其也可以执行任意命令，就像在本机执行一样；</li>
<li><a href="http://docs.ansible.com/script_module.html" target="_blank" rel="external">script模块</a>：其是将管理端的shell 在被管理主机上执行，其原理是先将shell 复制到远程主机，再在远程主机上执行，原理类似于raw模块。</li>
</ul>
<p>注：raw模块和comand、shell 模块不同的是其没有chdir、creates、removes参数，chdir参数的作用就是先切到chdir指定的目录后，再执行后面的命令，这在后面很多模块里都会有该参数 。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要介绍了ansible的Ad-hoc命令。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible参数配置文件ansible.cfg</title>
    <link href="http://wangshengzhuang.com/2017/05/15/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ansible%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6ansible.cfg/"/>
    <id>http://wangshengzhuang.com/2017/05/15/运维相关/Ansible/Ansible参数配置文件ansible.cfg/</id>
    <published>2017-05-15T15:26:47.000Z</published>
    <updated>2017-05-23T14:01:46.251Z</updated>
    
    <content type="html"><![CDATA[<p>Ansible默认安装好后有一个配置文件/etc/ansible/ansible.cfg，该配置文件中定义了ansible的主机的默认配置部分，如默认是否需要输入密码、是否开启sudo认证、action_plugins插件的位置、hosts主机组的位置、是否开启log功能、默认端口、key文件位置等等。</p>
<a id="more"></a>
<p>Ansible的一些的设置可以通过配置文件完成.在大多数场景下默认的配置就能满足大多数用户的需求,在一些特殊场景下,用户还是需要自行修改这些配置文件。</p>
<p>用户可以修改一下配置文件来修改设置,他们的被读取的顺序如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">* ANSIBLE_CONFIG (一个环境变量)</div><div class="line">* ansible.cfg (位于当前目录中)</div><div class="line">* .ansible.cfg (位于家目录中)</div><div class="line">* /etc/ansible/ansible.cfg</div></pre></td></tr></table></figure>
<p>Ansible 将会按以上顺序逐个查询这些文件,直到找到一个为止,并且使用第一个寻找到个配置文件的配置,这些配置将不会被叠加.</p>
<h4 id="ask-pass"><a href="#ask-pass" class="headerlink" title="ask_pass"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id63" target="_blank" rel="external">ask_pass</a></h4><ul>
<li><p>这个可以控制,Ansible 剧本playbook 是否会自动默认弹出弹出密码.默认为no::</p>
<p>ask_pass=True</p>
</li>
</ul>
<p>如果使用SSH 密钥匙做身份认证.可能需要修改这一参数</p>
<h4 id="ask-sudo-pass"><a href="#ask-sudo-pass" class="headerlink" title="ask_sudo_pass"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id64" target="_blank" rel="external">ask_sudo_pass</a></h4><p>类似 ask_pass,用来控制Ansible playbook 在执行sudo之前是否询问sudo密码.默认为no:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ask_sudo_pass=True</div></pre></td></tr></table></figure>
<p>如果用户使用的系统平台开启了sudo 密码的话,应该开绿这一参数</p>
<h4 id="forks"><a href="#forks" class="headerlink" title="forks"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id76" target="_blank" rel="external">forks</a></h4><p>这个选项设置在与主机通信时的默认并行进程数.从Ansible 1.3开始,fork数量默认自动设置为主机数量或者潜在的主机数量, 这将直接控制有多少网络资源活着cpu可以被使用.很多用户把这个设置为50,有些设置为500或者更多.如果你有很多的主机, 高数值将会使得跨主机行为变快.默认值比较保守:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_forks=5</div></pre></td></tr></table></figure>
<h4 id="gathering"><a href="#gathering" class="headerlink" title="gathering"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id77" target="_blank" rel="external">gathering</a></h4><p>1.6版本中的新特性,这个设置控制默认facts收集（远程系统变量）. 默认值为’implicit’, 每一次play,facts都会被手机,除非设置’gather_facts: False’. 选项‘explicit’正好相反,facts不会被收集,直到play中需要. ‘smart’选项意思是,没有facts的新hosts将不会被扫描, 但是如果同样一个主机,在不同的plays里面被记录地址,在playbook运行中将不会通信.这个选项当有需求节省fact收集时比较有用.</p>
<h4 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id81" target="_blank" rel="external">inventory</a></h4><p>这个事默认库文件位置,脚本,或者存放可通信主机的目录:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">inventory = /etc/ansible/hosts</div></pre></td></tr></table></figure>
<h4 id="log-path"><a href="#log-path" class="headerlink" title="log_path"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id84" target="_blank" rel="external">log_path</a></h4><p>如果出现在ansible.cfg文件中.Ansible 将会在选定的位置登陆执行信息.请留意用户运行的Ansible对于logfile有权限:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">log_path=/var/log/ansible.log</div></pre></td></tr></table></figure>
<p>这个特性不是默认开启的.如果不设置,ansible将会吧模块加载纪录在系统日志系统中.不包含用密码.</p>
<p>对于需要了解更多日志系统的企业及用户,你也许对:doc:tower 感兴趣.</p>
<h4 id="module-name"><a href="#module-name" class="headerlink" title="module_name"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id87" target="_blank" rel="external">module_name</a></h4><p>这个是/usr/bin/ansible的默认模块名（-m）. 默认是’command’模块. 之前提到过,command模块不支持shell变量,管道,配额. 所以也许你希望把这个参数改为’shell’:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">module_name = command</div></pre></td></tr></table></figure>
<h4 id="poll-interval"><a href="#poll-interval" class="headerlink" title="poll_interval"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id91" target="_blank" rel="external">poll_interval</a></h4><p>对于Ansible中的异步任务(详见 <a href="http://www.ansible.com.cn/docs/playbooks_async.html" target="_blank" rel="external"><em>异步操作和轮询</em></a>）, 这个是设置定义,当具体的poll interval 没有定义时,多少时间回查一下这些任务的状态, 默认值是一个折中选择15秒钟.这个时间是个回查频率和任务完成叫回频率和当任务完成时的回转频率的这种:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">poll_interval=15</div></pre></td></tr></table></figure>
<h4 id="private-key-file"><a href="#private-key-file" class="headerlink" title="private_key_file"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id92" target="_blank" rel="external">private_key_file</a></h4><p>如果你是用pem密钥文件而不是SSH 客户端或秘密啊认证的话,你可以设置这里的默认值,来避免每一次提醒设置密钥文件位置<code>–ansible-private-keyfile</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private_key_file=/path/to/file.pem</div></pre></td></tr></table></figure>
<h4 id="remote-port"><a href="#remote-port" class="headerlink" title="remote_port"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id93" target="_blank" rel="external">remote_port</a></h4><p>这个设置是你系统默认的远程SSH端口,如果不指定,默认为22号端口:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">remote_port = 22</div></pre></td></tr></table></figure>
<h4 id="remote-tmp"><a href="#remote-tmp" class="headerlink" title="remote_tmp"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id94" target="_blank" rel="external">remote_tmp</a></h4><p>Ansible 通过远程传输模块到远程主机,然后远程执行,执行后在清理现场.在有些场景下,你也许想使用默认路径希望像更换补丁一样使用, 这时候你可以使用这个选项.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">remote_tmp = $HOME/.ansible/tmp</div></pre></td></tr></table></figure>
<p>默认路径是在用户家目录下属的目录.Ansible 会在这个目录中使用一个随机的文件夹名称.</p>
<h4 id="remote-user"><a href="#remote-user" class="headerlink" title="remote_user"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id95" target="_blank" rel="external">remote_user</a></h4><p>这是个ansible使用/usr/bin/ansible-playbook链接的默认用户名. 注意如果不指定,/usr/bin/ansible默认使用当前用户名称:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">remote_user = root</div></pre></td></tr></table></figure>
<h4 id="roles-path"><a href="#roles-path" class="headerlink" title="roles_path"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id96" target="_blank" rel="external">roles_path</a></h4><p>roles 路径指的是’roles/’下的额外目录,用于playbook搜索Ansible roles.比如, 如果我们有个用于common roles源代码控制仓库和一个不同的 playbooks仓库,你也许会建立一个惯例去在 /opt/mysite/roles 里面查找roles.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">roles_path = /opt/mysite/roles</div></pre></td></tr></table></figure>
<p>多余的路径可以用冒号分隔,类似于其他path字符串:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">roles_path = /opt/mysite/roles:/opt/othersite/roles</div></pre></td></tr></table></figure>
<p>Roles将会在playbook目录中开始搜索.如果role没有找到,这个参数指定了其它可能的搜索路径.</p>
<h4 id="sudo-user"><a href="#sudo-user" class="headerlink" title="sudo_user"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id99" target="_blank" rel="external">sudo_user</a></h4><p>这个是sudo使用的默认用户,如果<code>–sudo-user</code> 没有特指或者’sudo_user’ 在Ansible playbooks中没有特指,在大多数的逻辑中 默认为: ‘root’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo_user=root</div></pre></td></tr></table></figure>
<h4 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id101" target="_blank" rel="external">timeout</a></h4><p>这个事默认SSH链接尝试超市时间:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">timeout = 10</div></pre></td></tr></table></figure>
<h4 id="vault-password-file"><a href="#vault-password-file" class="headerlink" title="vault_password_file"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id104" target="_blank" rel="external">vault_password_file</a></h4><p>New in version 1.7.</p>
<p>这个用来设置密码文件,也可以通过命令行指定<code>–vault-password-file</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vault_password_file = /path/to/vault_password_file</div></pre></td></tr></table></figure>
<p>在1.7版本中,这个文件也可以称为一个脚本的形式.如果你使用脚本而不是单纯文件的话,请确保它可以执行并且密码可以在标准输出上打印出来.如果你的脚本需要提示请求数据,请求将会发到标准错误输出中.</p>
<h4 id="record-host-keys"><a href="#record-host-keys" class="headerlink" title="record_host_keys"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id106" target="_blank" rel="external">record_host_keys</a></h4><p>默认设置会记录并验证通过在用户hostfile中新发现的的主机（如果host key checking 被激活的话）. 这个选项在有很多主机的时候将会性能很差.在 这种情况下,建议使用SSH传输代替. 当设置为False时, 性能将会提升,在hostkey checking 被禁用时候,建议使用.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">record_host_keys=True</div></pre></td></tr></table></figure>
<h4 id="host-key-checking"><a href="#host-key-checking" class="headerlink" title="host_key_checking"></a><a href="http://www.ansible.com.cn/docs/intro_configuration.html#id80" target="_blank" rel="external">host_key_checking</a></h4><p>如果有台被管节点重新安装系统并在known_hosts中有了与之前不同的密钥信息，就会提示一个密钥不匹配的错误信息，直到被纠正为止，在使用Ansible时，如果有台被管理节点没有在known_hosts中被初始化，将会在使用Ansible或定时执行Ansible时提示对key信息的确认。如果你不想出现这种情况，并且你明白禁用此项行为的含义，只要修改该参数为False即可 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">host_key_checking=True</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ansible默认安装好后有一个配置文件/etc/ansible/ansible.cfg，该配置文件中定义了ansible的主机的默认配置部分，如默认是否需要输入密码、是否开启sudo认证、action_plugins插件的位置、hosts主机组的位置、是否开启log功能、默认端口、key文件位置等等。&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible主机清单Inventory文件hosts</title>
    <link href="http://wangshengzhuang.com/2017/05/14/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ansible%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95Inventory%E6%96%87%E4%BB%B6hosts/"/>
    <id>http://wangshengzhuang.com/2017/05/14/运维相关/Ansible/Ansible主机清单Inventory文件hosts/</id>
    <published>2017-05-14T15:26:47.000Z</published>
    <updated>2017-05-23T14:01:33.718Z</updated>
    
    <content type="html"><![CDATA[<p>Ansible 通过读取默认的主机清单配置,可以同时连接到多个远程主机上执行任务组和主机之间的关系通过 inventory 文件配置. 默认的文件路径为 /etc/ansible/hosts。默认路径可以通过修改 ansible.cfg 的 hostfile 参数指定路径。</p>
<a id="more"></a>
<p>除默认文件外,你还可以同时使用多个 inventory 文件(后面会讲到),也可以从动态源,或云上拉取 inventory 配置信息.详见 <a href="http://www.ansible.com.cn/docs/intro_dynamic_inventory.html" target="_blank" rel="external"><em>动态 Inventory</em></a>.</p>
<h2 id="1-主机与组"><a href="#1-主机与组" class="headerlink" title="1.主机与组"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id8" target="_blank" rel="external">1.主机与组</a></h2><p>/etc/ansible/hosts 文件的格式与windows的ini配置文件类似:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mail.example.com</div><div class="line"></div><div class="line">[webservers]</div><div class="line">foo.example.com</div><div class="line">bar.example.com</div><div class="line"></div><div class="line">[dbservers]</div><div class="line">one.example.com</div><div class="line">two.example.com</div><div class="line">three.example.com</div></pre></td></tr></table></figure>
<ol>
<li>方括号[]中是组名,用于对系统进行分类,便于对不同系统进行个别的管理.可以根据自己的需求将庞大的主机分成具有标识的组，如上面分了两个组webservers和dbservers组；</li>
<li>一个主机可以属于不同的组,比如一台服务器可以同时属于 webserver组 和 dbserver组.这时属于两个组的变量都可以为这台主机所用,</li>
<li>如果有主机的SSH端口不是标准的22端口,可在主机名之后加上端口号,用冒号分隔.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">badwolf.example.com:5309</div></pre></td></tr></table></figure>
<p> 4.假设你有一些静态IP地址,希望设置一些别名,但不是在系统的 host 文件中设置,那么可以设置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jumper ansible_ssh_port=5555 ansible_ssh_host=192.168.1.50</div></pre></td></tr></table></figure>
<ol>
<li>可以按照范围指定主机，一组相似的 hostname , 可简写如下:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[webservers]</div><div class="line">www[01:50].example.com</div><div class="line"></div><div class="line">[databases]</div><div class="line">db-[a:f].example.com</div></pre></td></tr></table></figure>
<h2 id="2-主机变量"><a href="#2-主机变量" class="headerlink" title="2.主机变量"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id9" target="_blank" rel="external">2.主机变量</a></h2><p>前面已经提到过,分配变量给主机很容易做到,这些变量定义后可在 playbooks 中使用:</p>
<p>对于每一个 host,你还可以选择连接类型和连接用户名:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[targets]</div><div class="line"></div><div class="line">localhost              ansible_connection=local</div><div class="line">other1.example.com     ansible_connection=ssh        ansible_ssh_user=mpdehaan</div><div class="line">other2.example.com     ansible_connection=ssh        ansible_ssh_user=mdehaan</div></pre></td></tr></table></figure>
<p>定义其他变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[atlanta]</div><div class="line">host1 http_port=80  maxRequestsPerChild=808</div><div class="line">host2 http_port=303 maxRequestsPerChild=909</div></pre></td></tr></table></figure>
<h2 id="3-组的变量"><a href="#3-组的变量" class="headerlink" title="3.组的变量"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id10" target="_blank" rel="external">3.组的变量</a></h2><p>也可以定义属于整个组的变量，应用到组内的所有成员：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[atlanta]</div><div class="line">host1</div><div class="line">host2</div><div class="line"></div><div class="line">[atlanta:vars]</div><div class="line">ntp_server=ntp.atlanta.example.com</div><div class="line">proxy=proxy.atlanta.example.com</div></pre></td></tr></table></figure>
<p>上面atlanta组中包含两台主机，通过对atlanta组指定vars变更，相应的host1和host2相当于相应的指定了ntp_server和proxy变量参数值 。</p>
<h2 id="4-把一个组作为另一个组的子成员"><a href="#4-把一个组作为另一个组的子成员" class="headerlink" title="4.把一个组作为另一个组的子成员"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id11" target="_blank" rel="external">4.把一个组作为另一个组的子成员</a></h2><p>可以把一个组作为另一个组的子成员,以及分配变量给整个组使用. 这些变量可以给 /usr/bin/ansible-playbook 使用,但不能给 /usr/bin/ansible 使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[atlanta]</div><div class="line">host1</div><div class="line">host2</div><div class="line"></div><div class="line">[raleigh]</div><div class="line">host2</div><div class="line">host3</div><div class="line"></div><div class="line">[southeast:children]</div><div class="line">atlanta</div><div class="line">raleigh</div><div class="line"></div><div class="line">[southeast:vars]</div><div class="line">some_server=foo.southeast.example.com</div><div class="line">halon_system_timeout=30</div><div class="line">self_destruct_countdown=60</div><div class="line">escape_pods=2</div><div class="line"></div><div class="line">[usa:children]</div><div class="line">southeast</div><div class="line">northeast</div><div class="line">southwest</div><div class="line">northwest</div></pre></td></tr></table></figure>
<h2 id="5、分文件定义-Host-和-Group-变量"><a href="#5、分文件定义-Host-和-Group-变量" class="headerlink" title="5、分文件定义 Host 和 Group 变量"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id12" target="_blank" rel="external">5、分文件定义 Host 和 Group 变量</a></h2><p>在 inventory 主文件中保存所有的变量并不是最佳的方式.还可以保存在独立的文件中,这些独立文件与 inventory 文件保持关联. 不同于 inventory 文件(INI 格式),这些独立文件的格式为 YAML.详见 <a href="http://www.ansible.com.cn/docs/YAMLSyntax.html" target="_blank" rel="external"><em>YAML 语法</em></a> .</p>
<p>假设 inventory 文件的路径为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/ansible/hosts</div></pre></td></tr></table></figure>
<p>假设有一个主机名为 ‘foosball’, 主机同时属于两个组,一个是 ‘raleigh’, 另一个是 ‘webservers’. 那么以下配置文件(YAML 格式)中的变量可以为 ‘foosball’ 主机所用.依次为 ‘raleigh’ 的组变量,’webservers’ 的组变量,’foosball’ 的主机变量:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/etc/ansible/group_vars/raleigh</div><div class="line">/etc/ansible/group_vars/webservers</div><div class="line">/etc/ansible/host_vars/foosball</div></pre></td></tr></table></figure>
<h2 id="6-Inventory-参数的说明"><a href="#6-Inventory-参数的说明" class="headerlink" title="6.Inventory 参数的说明"></a><a href="http://www.ansible.com.cn/docs/intro_inventory.html#id13" target="_blank" rel="external">6.Inventory 参数的说明</a></h2><p>如同前面提到的,通过设置下面的参数,可以控制 ansible 与远程主机的交互方式,其中一些我们已经讲到过:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">ansible_ssh_host</div><div class="line">      将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.</div><div class="line"></div><div class="line">ansible_ssh_port</div><div class="line">      ssh端口号.如果不是默认的端口号,通过此变量设置.</div><div class="line"></div><div class="line">ansible_ssh_user</div><div class="line">      默认的 ssh 用户名</div><div class="line"></div><div class="line">ansible_ssh_pass</div><div class="line">      ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)</div><div class="line"></div><div class="line">ansible_sudo_pass</div><div class="line">      sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)</div><div class="line"></div><div class="line">ansible_sudo_exe (new in version 1.8)</div><div class="line">      sudo 命令路径(适用于1.8及以上版本)</div><div class="line"></div><div class="line">ansible_connection</div><div class="line">      与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 &apos;smart&apos;,&apos;smart&apos; 方式会根据是否支持 ControlPersist, 来判断&apos;ssh&apos; 方式是否可行.</div><div class="line"></div><div class="line">ansible_ssh_private_key_file</div><div class="line">      ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.</div><div class="line"></div><div class="line">ansible_shell_type</div><div class="line">      目标系统的shell类型.默认情况下,命令的执行使用 &apos;sh&apos; 语法,可设置为 &apos;csh&apos; 或 &apos;fish&apos;.</div><div class="line"></div><div class="line">ansible_python_interpreter</div><div class="line">      目标主机的 python 路径.适用于的情况: 系统中有多个 Python, 或者命令路径不是&quot;/usr/bin/python&quot;,比如  \*BSD, 或者 /usr/bin/python</div><div class="line">      不是 2.X 版本的 Python.我们不使用 &quot;/usr/bin/env&quot; 机制,因为这要求远程用户的路径设置正确,且要求 &quot;python&quot; 可执行程序名不可为 python以外的名字(实际有可能名为python26).</div><div class="line"></div><div class="line">      与 ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....</div></pre></td></tr></table></figure>
<h2 id="7-一个主机文件的例子"><a href="#7-一个主机文件的例子" class="headerlink" title="7.一个主机文件的例子:"></a>7.一个主机文件的例子:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"># This is the default ansible &apos;hosts&apos; file.</div><div class="line">#</div><div class="line"># It should live in /etc/ansible/hosts</div><div class="line">#</div><div class="line">#   - Comments begin with the &apos;#&apos; character</div><div class="line">#   - Blank lines are ignored</div><div class="line">#   - Groups of hosts are delimited by [header] elements</div><div class="line">#   - You can enter hostnames or ip addresses</div><div class="line">#   - A hostname/ip can be a member of multiple groups</div><div class="line"></div><div class="line"># Ex 1: Ungrouped hosts, specify before any group headers.</div><div class="line"></div><div class="line">## green.example.com</div><div class="line">## blue.example.com</div><div class="line">## 192.168.100.1</div><div class="line">## 192.168.100.10</div><div class="line"></div><div class="line"># Ex 2: A collection of hosts belonging to the &apos;webservers&apos; group</div><div class="line"></div><div class="line">## [webservers]</div><div class="line">## alpha.example.org</div><div class="line">## beta.example.org</div><div class="line">## 192.168.1.100</div><div class="line">## 192.168.1.110</div><div class="line"></div><div class="line"># If you have multiple hosts following a pattern you can specify</div><div class="line"># them like this:</div><div class="line"></div><div class="line">## www[001:006].example.com</div><div class="line"></div><div class="line"># Ex 3: A collection of database servers in the &apos;dbservers&apos; group</div><div class="line"></div><div class="line">## [dbservers]</div><div class="line">## </div><div class="line">## db01.intranet.mydomain.net</div><div class="line">## db02.intranet.mydomain.net</div><div class="line">## 10.25.1.56</div><div class="line">## 10.25.1.57</div><div class="line"></div><div class="line"># Here&apos;s another example of host ranges, this time there are no</div><div class="line"># leading 0s:</div><div class="line"></div><div class="line">## db-[99:101]-node.example.com</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ansible 通过读取默认的主机清单配置,可以同时连接到多个远程主机上执行任务组和主机之间的关系通过 inventory 文件配置. 默认的文件路径为 /etc/ansible/hosts。默认路径可以通过修改 ansible.cfg 的 hostfile 参数指定路径。&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>Ansible安装</title>
    <link href="http://wangshengzhuang.com/2017/05/13/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/Ansible%E5%AE%89%E8%A3%85/"/>
    <id>http://wangshengzhuang.com/2017/05/13/运维相关/Ansible/Ansible安装/</id>
    <published>2017-05-13T15:26:47.000Z</published>
    <updated>2017-05-23T13:58:16.014Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录了ansible的安装方法。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg" alt=""></p>
<a id="more"></a>
<h1 id="一、安装前准备"><a href="#一、安装前准备" class="headerlink" title="一、安装前准备"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id9" target="_blank" rel="external">一、安装前准备</a></h1><h2 id="需要安装些什么"><a href="#需要安装些什么" class="headerlink" title="需要安装些什么"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id11" target="_blank" rel="external">需要安装些什么</a></h2><p>Ansible默认通过 SSH 协议管理机器.目前,只要机器上安装了 Python 2.6 或 Python 2.7 (windows系统不可以做控制主机),都可以运行Ansible.</p>
<p>主机的系统可以是 Red Hat, Debian, CentOS, OS X, BSD的各种版本,等等.</p>
<p>安装Ansible之后,不需要启动或运行一个后台进程,或是添加一个数据库.只要在一台电脑(可以是一台笔记本)上安装好,就可以通过这台电脑管理一组远程的机器.在远程被管理的机器上,不需要安装运行任何软件,因此升级Ansible版本不会有太多问题.</p>
<h2 id="版本及安装方式选择"><a href="#版本及安装方式选择" class="headerlink" title="版本及安装方式选择?"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id12" target="_blank" rel="external">版本及安装方式选择?</a></h2><p>因为Ansible可以很简单的从源码运行,且不必在远程被管理机器上安装任何软件,很多Ansible用户会跟进使用开发版本.</p>
<p>Ansible一般每两个月出一个发行版本.小bugs一般在下一个发行版本中修复,并在稳定分支中做backports.大bugs会在必要时出一个维护版本,不过这不是很频繁.</p>
<p>若你希望使用Ansible的最新版本,并且你使用的操作系统是 Red Hat Enterprise Linux (TM), CentOS, Fedora, Debian, Ubuntu,<strong>我们建议使用系统的软件包管理器</strong>.</p>
<p>另有一种选择是通过”pip”工具安装,”pip”是一个安装和管理Python包的工具.</p>
<p>若你希望跟进开发版本,想使用和测试最新的功能特性,我们会分享如何从源码运行Ansible的方法.从源码运行程序不需要进行软件安装.</p>
<h1 id="二、安装"><a href="#二、安装" class="headerlink" title="二、安装"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id15" target="_blank" rel="external">二、安装</a></h1><h2 id="2-1-通过Yum安装最新发布版本"><a href="#2-1-通过Yum安装最新发布版本" class="headerlink" title="2.1 通过Yum安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id17" target="_blank" rel="external">2.1 通过Yum安装最新发布版本</a></h2><p>RHEL或CentOS用户,需要 <a href="http://fedoraproject.org/wiki/EPEL" target="_blank" rel="external">配置 EPEL</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># install the epel-release RPM if needed on CentOS, RHEL, or Scientific Linux</div><div class="line">$ sudo yum install epel-release</div><div class="line">$ sudo yum install ansible</div></pre></td></tr></table></figure>
<h2 id="2-2-自己创建RPM软件包"><a href="#2-2-自己创建RPM软件包" class="headerlink" title="2.2 自己创建RPM软件包"></a>2.2 自己创建RPM软件包</h2><p>你也可以自己创建RPM软件包.在Ansible项目的checkout的根目录下,或是在一个tarball中,使用 <code>make rpm</code> 命令创建RPM软件包. 然后可分发这个软件包或是使用它来安装Ansible.在创建之前,先确定你已安装了 <code>rpm-build</code>, <code>make</code>, and <code>python2-devel</code> .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git clone git://github.com/ansible/ansible.git</div><div class="line">$ cd ./ansible</div><div class="line">$ make rpm</div><div class="line">$ sudo rpm -Uvh ~/rpmbuild/ansible-*.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="2-3-通过Apt-Ubuntu-安装最新发布版本"><a href="#2-3-通过Apt-Ubuntu-安装最新发布版本" class="headerlink" title="2.3 通过Apt (Ubuntu)安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id18" target="_blank" rel="external">2.3 通过Apt (Ubuntu)安装最新发布版本</a></h2><p>配置PPA及安装ansible,执行如下命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install software-properties-common</div><div class="line">$ sudo apt-add-repository ppa:ansible/ansible</div><div class="line">$ sudo apt-get update</div><div class="line">$ sudo apt-get install ansible</div></pre></td></tr></table></figure>
<h2 id="2-4-通过-Pip-安装最新发布版本"><a href="#2-4-通过-Pip-安装最新发布版本" class="headerlink" title="2.4 通过 Pip 安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id24" target="_blank" rel="external">2.4 通过 Pip 安装最新发布版本</a></h2><p>Ansible可通过 “pip” 安装(安装和管理Python包的工具),若你还没有安装 pip,可执行如下命令安装:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo easy_install pip</div></pre></td></tr></table></figure>
<p>然后安装Ansible:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo pip install ansible</div></pre></td></tr></table></figure>
<p>如果你是在 OS X Mavericks 上安装,编译器可能或告警或报错,可通过如下设置避免这种情况:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo CFLAGS=-Qunused-arguments CPPFLAGS=-Qunused-arguments pip install ansible</div></pre></td></tr></table></figure>
<h2 id="2-5-发行版的Tarball"><a href="#2-5-发行版的Tarball" class="headerlink" title="2.5 发行版的Tarball"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id25" target="_blank" rel="external">2.5 发行版的Tarball</a></h2><p>不想通过git checkout 创建Ansible的软件包？在这里可获取Tarball <a href="http://releases.ansible.com/ansible" target="_blank" rel="external">Ansible downloads</a></p>
<h2 id="2-6-在Mac-OSX-上安装最新发布版本"><a href="#2-6-在Mac-OSX-上安装最新发布版本" class="headerlink" title="2.6 在Mac OSX 上安装最新发布版本"></a><a href="http://www.ansible.com.cn/docs/intro_installation.html#id21" target="_blank" rel="external">2.6 在Mac OSX 上安装最新发布版本</a></h2><p>在 Mac 上安装 ansible，最好是通过 pip 安装，参照 <a href="http://www.ansible.com.cn/docs/intro_installation.html#pip" target="_blank" rel="external">通过 Pip 安装最新发布版本</a> .</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录了ansible的安装方法。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>初识Ansible</title>
    <link href="http://wangshengzhuang.com/2017/05/12/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/%E5%88%9D%E8%AF%86Ansible/"/>
    <id>http://wangshengzhuang.com/2017/05/12/运维相关/Ansible/初识Ansible/</id>
    <published>2017-05-12T15:26:47.000Z</published>
    <updated>2017-05-23T14:03:55.504Z</updated>
    
    <content type="html"><![CDATA[<p>初识ansible。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg" alt=""></p>
<a id="more"></a>
<h3 id="Ansible是什么？"><a href="#Ansible是什么？" class="headerlink" title="Ansible是什么？"></a>Ansible<strong>是什么</strong>？</h3><p>官方的描述如下 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Simple, agentless and powerful open source IT automation</div></pre></td></tr></table></figure>
<p>Ansible是近年越来越火的一款基于Python开发的运维自动化工具，2012.02月出现至今，已成为排名前10的python项目。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-22/53522347-file_1495460433051_500c.png" alt=""></p>
<p>其主要功能是帮助运维实现IT工作的自动化、降低人为操作失误、提高业务自动化率、提升运维工作效率，常用于软件部署自动化、配置自动化、管理自动化、系统化系统任务、持续集成、零宕机平滑升级等。</p>
<h3 id="Ansible名字来源？"><a href="#Ansible名字来源？" class="headerlink" title="Ansible名字来源？"></a>Ansible<strong>名字来源</strong>？</h3><p>Ansible名字其实是来源于作者喜欢的一本书——奥森·斯科特·卡特的《安德的游戏》，该书中Ansible是一种能跨越时空的即时通信工具，使用Ansible可以在相距数光年的距离远程实时控制前线的舰队战斗。Michael DeHaan希望借这个名词比喻控制远端大量的服务器，因此便将自己的这款产品命名为Ansible。</p>
<h3 id="为什么选择Ansible？"><a href="#为什么选择Ansible？" class="headerlink" title="为什么选择Ansible？"></a>为什么选择Ansible？</h3><ol>
<li>noagents：不需要在被管控主机上安装任何客户端</li>
<li>noserver：无服务器daemon进程</li>
<li>基于SSH工作</li>
<li>安装简单</li>
<li>Redhat收购</li>
<li>Ansible galaxy</li>
<li>支持docker的模块管理</li>
</ol>
<h3 id="Ansible架构"><a href="#Ansible架构" class="headerlink" title="Ansible架构"></a>Ansible架构</h3><p><img src="http://image.wangshengzhuang.com/17-5-22/58519827-file_1495460630196_15282.png" alt=""></p>
<p>Ansible没有客户端，因此底层通信依赖于系统软件，Linux系统下基于OpenSSH通信，Windows系统下基于PowerShell，管理端必须是Linux系统，使用者认证通过后在管理节点通过Ansible工具调用各应用模块将指令推送至被管理端执行，并在执行完毕后自动删除产生的临时文件。</p>
<p>ansible是基于模块工作的，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。主要包括：</p>
<p>(1)、连接插件connectionplugins：负责和被监控端实现通信；</p>
<p>(2)、host inventory：指定操作的主机，是一个配置文件里面定义监控的主机；</p>
<p>(3)、各种模块核心模块、command模块、自定义模块；</p>
<p>(4)、借助于插件完成记录日志邮件等功能；</p>
<p>(5)、playbook：剧本执行多个任务</p>
<h3 id="Ansible任务执行流程"><a href="#Ansible任务执行流程" class="headerlink" title="Ansible任务执行流程"></a>Ansible任务执行流程</h3><p><img src="http://image.wangshengzhuang.com/17-5-22/67984305-file_1495460751602_df86.jpg" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;初识ansible。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-19/88214161-file_1495207716369_76e1.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="运维相关" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/"/>
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/categories/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/Ansible/"/>
    
    
      <category term="Ansible" scheme="http://wangshengzhuang.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>ls命令</title>
    <link href="http://wangshengzhuang.com/2017/05/12/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/ls%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/12/Linux/每天一个Linux命令/ls命令/</id>
    <published>2017-05-12T14:29:25.000Z</published>
    <updated>2017-06-07T14:44:43.749Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a>
<h2 id="1、命令简介"><a href="#1、命令简介" class="headerlink" title="1、命令简介"></a>1、命令简介</h2><p><strong>ls</strong>（list 列出目录内容）命令用来列出显示指定目录里的文件及文件夹清单，缺省下ls用来打印出当前目录的清单。通过ls 命令不仅可以查看linux文件夹包含的文件，而且可以查看文件权限、大小、更改时间等等</p>
<h2 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls [OPTION]... [FILE]...</div></pre></td></tr></table></figure>
<h2 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">-a 列出目录下的所有文件，包括以 . 开头的隐含文件。</div><div class="line">-A 显示除“.”和“..”外的所有文件。  </div><div class="line">-b 把文件名中不可输出的字符用反斜杠加字符编号(就象在C语言里一样)的形式列出。 </div><div class="line">-B 不输出以“~”结尾的备份文件。</div><div class="line">-c 与“-lt”选项连用时，按照文件状态时间排序输出目录内容，排序的依据是文件的索引节点中的ctime字段。与“-l”选项连用时，则显示状态改变时间，并以名称排序；其他根据ctime排揎</div><div class="line">-C 多列显示输出结果，纵向排序，这是默认选项。</div><div class="line">--color显示彩色文件名 [always|never|auto] </div><div class="line">-d 将目录像文件一样显示，而不是显示其下的文件。 </div><div class="line">-e 输出时间的全部信息，而不是输出简略信息。 </div><div class="line">-f 此参数的效果和同时指定“aU”参数相同，并关闭“lst”参数的效果；</div><div class="line">-F 在文件名后附上一个字符以说明该文件的类型，“*”表示可执行的普通 文件；“/”表示目录；“@”表示符号链接；“|”表示FIFOs；“=”表示套接字---g 类似于-l 但是不列出owner。 </div><div class="line">-G 输出文件的组的信息。</div><div class="line">-h  和-l一起，以human-readable的格式输出大小信息</div><div class="line">-i  --inode输出文件节点的索引信息。 </div><div class="line">-k 以 k 字节的形式表示文件的大小。 </div><div class="line">-l 列出文件的详细信息。 </div><div class="line">-L 列出链接文件名而不是链接到的文件。 </div><div class="line">-m 横向输出文件名，并以“，”作分格符。 </div><div class="line">-n 用数字的 UID,GID 代替名称。 </div><div class="line">-N 不限制文件长度。</div><div class="line">-o 显示文件的除组信息外的详细信息。 </div><div class="line">-p 文件夹后添加/</div><div class="line">-q 用?代替不可输出的字符。</div><div class="line">-Q 把输出的文件名用双引号括起来。  </div><div class="line">-r 对目录反向排序。 </div><div class="line">-R 列出所有子目录下的文件。</div><div class="line">-s 在每个文件名后输出该文件的大小,单位为block。</div><div class="line">-S 以文件大小排序。  </div><div class="line">-t 以时间排序。 </div><div class="line">-u 与“-lt”选项连用时，按照访问时间排序输出目录内容。与“-l”选项连用时，则显示访问时间，并以名称排序；其他根据访问时间排序</div><div class="line">-U 对输出的文件不排序。</div><div class="line">-x 按列输出，横向排序。 </div><div class="line">-X 以文件的扩展名(最后一个 . 后的字符)排序。 </div><div class="line">-1 一行只输出一个文件。 </div><div class="line">--help 在标准输出上显示帮助信息。 </div><div class="line">--version 在标准输出上输出版本信息并退出。</div></pre></td></tr></table></figure>
<h2 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h2><p><strong>1. 不带任何选项列出文件</strong></p>
<p>不带选项的ls命令来光秃秃地列出文件和目录，我们是不能看到像文件类型、大小、修改日期和时间、权限以及链接这样具体的信息的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 tmp]# ls</div><div class="line">hsperfdata_root  nginx_log_stat  pulse-IhiwHnejlPBk  tomcat-redis-session-manager</div></pre></td></tr></table></figure>
<p><strong>2. 带–l 选项列出文件列表</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@cent6 tmp]# ls -l</div><div class="line">total 16</div><div class="line">drwxr-xr-x  2 root  root  4096 Apr  9 09:01 hsperfdata_root</div><div class="line">-rw-r--r--. 1 root  root     4 Mar 22 17:58 nginx_log_stat</div><div class="line">drwx------. 2 cloud cloud 4096 Feb 16  2015 pulse-IhiwHnejlPBk</div><div class="line">drwxr-xr-x. 3 root  root  4096 Feb 24 21:32 tomcat-redis-session-manager</div></pre></td></tr></table></figure>
<p>可以看到，用ls -l命令查看某一个目录会得到一个7个字段的列表。</p>
<p><strong>第1行:总计(total) </strong>Total后面的数字是指当前目录下所有文件所占用的空间总和,单位kb。可以使用ls –lh查看，</p>
<p><strong>第1字段: 文件属性字段</strong></p>
<p>文件属性字段总共有10个字母组成；第一个字符代表文件的类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">“-”表示该文件是一个普通文件</div><div class="line"></div><div class="line">“d”表示该文件是一个目录，字母&quot;d&quot;，是dirtectory(目录)的缩写</div><div class="line"></div><div class="line">“l”表示该文件是一个链接文件。字母&quot;l&quot;是link(链接)的缩写，类似于windows下的快捷方式</div><div class="line"></div><div class="line">“b”的表示块设备文件(block)，一般置于/dev目录下，设备文件是普通文件和程序访问硬件设备的入口，是很特殊的文件。，如硬盘、光盘等。最小数据传输单位为一个数据块(通常一个数据块的大小为512字节)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">“c”表示该文件是一个字符设备文件(character)，一般置于/dev目录下，一次传输一个字节的设备被称为字符设备，如键盘、字符终端等，传输数据的最小单位为一个字节。</div><div class="line"></div><div class="line">“p”表示该文件为命令管道文件。与shell编程有关的文件。</div><div class="line"></div><div class="line">“s”表示该文件为sock文件。与shell编程有关的文件。</div></pre></td></tr></table></figure>
<p><strong>第2字段</strong>：如果是一个文件，此时这一字段表示这个文件所具有的硬链接数；如果是一个目录，则第2字段表示该目录所含子目录的个数。新建一个空目录，这个目录的第二字段就是2，表示该目录下有两个子目录。为什么新建的目录下面会有两个子目录呢?因为每一个目录都有一个指向它本身的子目录”。” 和指向它上级目录的子目录”。。”，</p>
<p><strong>第3字段：</strong>文件（目录）拥有者</p>
<p><strong>第4字段</strong>：文件（目录）拥有者所在的组</p>
<p><strong>第5字段:</strong> 文件所占用的空间(以字节为单位)</p>
<p><strong>第6字段：</strong>文件（目录）最近访问（修改）时间</p>
<p><strong>第7字段：</strong>文件名</p>
<p><strong>3. 计算当前目录下的文件数和目录数</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls -l  |grep "^d"|wc -l  </div><div class="line">3</div><div class="line">[root@zabbix zabbix]# ls -l  |grep "^-"|wc -l</div><div class="line">6</div></pre></td></tr></table></figure>
<p><strong>4. 用 -lh 选项来以易读方式列出文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -lh</div><div class="line">total 16K</div><div class="line">-rwxr-xr-x. 1 root root 1.3K Feb 16  2015 anaconda-ks.cfg</div><div class="line">-rwxr-xr-x. 1 root root 9.0K Feb 16  2015 install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>5. 浏览隐藏文件</strong></p>
<p>列出所有文件包括以‘.’开头的隐藏文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -a</div><div class="line">.   anaconda-ks.cfg  .bash_logout   .bashrc  .cshrc  .gconfd  install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>6. 列出目录信息</strong></p>
<p>用ls -l命令列出/tmp目录下的文件，其中-ld参数可以只显示/tmp目录的信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -ld /tmp</div><div class="line">drwxrwxrwt. 7 root root 4096 Apr 12 20:34 /tmp</div></pre></td></tr></table></figure>
<p><strong>7. 以尾部以‘/’字符结尾的方式列出文件和目录</strong></p>
<p>使用 ls 命令的 -F 选项，会在每个目录的末尾添加“/”字符显示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -F</div><div class="line">anaconda-ks.cfg*  directory/  install.log.syslog*</div></pre></td></tr></table></figure>
<p><strong>8. 只列出文件下的子目录</strong></p>
<p>利用使用-F选项时，目录以/结尾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls -F |grep /$</div><div class="line">alertscripts/</div><div class="line">web/</div><div class="line">zabbix_agentd.d/</div></pre></td></tr></table></figure>
<p>利用使用-l选项时，目录以d开头</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls -l |grep "^d"</div><div class="line">drwxrwxrwx 2 root   root      97 Jan 28 09:23 alertscripts</div><div class="line">drwxr-x--- 2 apache apache    54 Feb 17 21:10 web</div><div class="line">drwxr-xr-x 2 root   root      45 Feb 17 21:10 zabbix_agentd.d</div></pre></td></tr></table></figure>
<p><strong>9. 按文件大小排序</strong></p>
<p>带-lS组合选项能按文件从大到小的次序显示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -lS</div><div class="line">total 20</div><div class="line">-rwxr-xr-x. 1 root root 9154 Feb 16  2015 install.log.syslog</div><div class="line">drwxr-xr-x  2 root root 4096 Apr 12 21:25 directory</div><div class="line">-rwxr-xr-x. 1 root root 1264 Feb 16  2015 anaconda-ks.cfg</div></pre></td></tr></table></figure>
<p><strong>10.列出当前目录中所有以“zabbix”开头的目录和文件的详细内容</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls zabbix*</div><div class="line">zabbix_agentd.conf  zabbix_java_gateway.conf  zabbix_java_gateway_logback.xml  zabbix_server.conf  zabbix_server.conf_bak  zabbix_server.conf.rpmnew_bak</div><div class="line"></div><div class="line">zabbix_agentd.d:</div><div class="line">userparameter_mysql.conf</div></pre></td></tr></table></figure>
<p><strong>11. 倒序列出文件</strong></p>
<p>ls -r 选项能以倒序方式显示文件和目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -r</div><div class="line">install.log.syslog  directory  anaconda-ks.cfg</div></pre></td></tr></table></figure>
<p><strong>12. 以修改时间列出，最近修改的在上面</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -lt</div><div class="line">total 20</div><div class="line">drwxr-xr-x  2 root root 4096 Apr 12 21:25 directory</div><div class="line">-rwxr-xr-x. 1 root root 1264 Feb 16  2015 anaconda-ks.cfg</div><div class="line">-rwxr-xr-x. 1 root root 9154 Feb 16  2015 install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>13. 以修改时间倒序列出</strong></p>
<p>带-ltr组合选项能以文件或目录的最新修改时间的次序来显示它们。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -ltr</div><div class="line">total 20</div><div class="line">-rwxr-xr-x. 1 root root 9154 Feb 16  2015 install.log.syslog</div><div class="line">-rwxr-xr-x. 1 root root 1264 Feb 16  2015 anaconda-ks.cfg</div><div class="line">drwxr-xr-x  2 root root 4096 Apr 12 21:25 directory</div></pre></td></tr></table></figure>
<p><strong>14.指定文件时间输出格式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls -lt --time-style=long-iso</div><div class="line">total 68</div><div class="line">-rw-r--r-- 1 root   root   14938 2016-04-14 11:48 zabbix_server.conf</div><div class="line">drwxr-xr-x 2 root   root      45 2016-02-17 21:10 zabbix_agentd.d</div><div class="line">drwxr-x--- 2 apache apache    54 2016-02-17 21:10 web</div><div class="line">-rw-r--r-- 1 root   root   10341 2016-02-16 00:16 zabbix_agentd.conf</div><div class="line">-rw-r--r-- 1 root   root     813 2016-02-16 00:16 zabbix_java_gateway.conf</div><div class="line">-rw-r--r-- 1 root   root     770 2016-02-16 00:16 zabbix_java_gateway_logback.xml</div><div class="line">-rw-r----- 1 root   zabbix 14912 2016-02-16 00:16 zabbix_server.conf.rpmnew_bak</div><div class="line">-rw-r----- 1 root   zabbix 13657 2016-02-04 10:19 zabbix_server.conf_bak</div><div class="line">drwxrwxrwx 2 root   root      97 2016-01-28 09:23 alertscripts</div></pre></td></tr></table></figure>
<p><strong>更详细的时间</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls -tl --time-style=full-iso</div><div class="line">total 68</div><div class="line">-rw-r--r-- 1 root   root   14938 2016-04-14 11:48:26.231666438 +0800 zabbix_server.conf</div><div class="line">drwxr-xr-x 2 root   root      45 2016-02-17 21:10:03.471004045 +0800 zabbix_agentd.d</div><div class="line">drwxr-x--- 2 apache apache    54 2016-02-17 21:10:00.024943223 +0800 web</div><div class="line">-rw-r--r-- 1 root   root   10341 2016-02-16 00:16:47.000000000 +0800 zabbix_agentd.conf</div><div class="line">-rw-r--r-- 1 root   root     813 2016-02-16 00:16:47.000000000 +0800 zabbix_java_gateway.conf</div><div class="line">-rw-r--r-- 1 root   root     770 2016-02-16 00:16:47.000000000 +0800 zabbix_java_gateway_logback.xml</div><div class="line">-rw-r----- 1 root   zabbix 14912 2016-02-16 00:16:47.000000000 +0800 zabbix_server.conf.rpmnew_bak</div><div class="line">-rw-r----- 1 root   zabbix 13657 2016-02-04 10:19:44.837012771 +0800 zabbix_server.conf_bak</div><div class="line">drwxrwxrwx 2 root   root      97 2016-01-28 09:23:44.034478732 +0800 alertscripts</div></pre></td></tr></table></figure>
<p><strong>15. **</strong>递归列出子目录**</p>
<p>ls -R 选项能递归列出子目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -lR</div><div class="line">.:</div><div class="line">total 20</div><div class="line">-rwxr-xr-x. 1 root root 1264 Feb 16  2015 anaconda-ks.cfg</div><div class="line">drwxr-xr-x  2 root root 4096 Apr 12 21:25 directory</div><div class="line">-rwxr-xr-x. 1 root root 9154 Feb 16  2015 install.log.syslog</div><div class="line"></div><div class="line">./directory:</div><div class="line">total 0</div><div class="line">-rw-r--r-- 1 root root 0 Apr 12 21:25 subtext.txt</div></pre></td></tr></table></figure>
<p><strong>16.列出当前目录下的所有文件（包括隐藏文件）的绝对路径， 对目录不做递归</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# find $PWD -maxdepth 1 | xargs ls -ld</div><div class="line">drwxr-xr-x 5 root   root    4096 Apr 14 11:48 /etc/zabbix</div><div class="line">drwxrwxrwx 2 root   root      97 Jan 28 09:23 /etc/zabbix/alertscripts</div><div class="line">drwxr-x--- 2 apache apache    54 Feb 17 21:10 /etc/zabbix/web</div><div class="line">-rw-r--r-- 1 root   root   10341 Feb 16 00:16 /etc/zabbix/zabbix_agentd.conf</div><div class="line">drwxr-xr-x 2 root   root      45 Feb 17 21:10 /etc/zabbix/zabbix_agentd.d</div><div class="line">-rw-r--r-- 1 root   root     813 Feb 16 00:16 /etc/zabbix/zabbix_java_gateway.conf</div><div class="line">-rw-r--r-- 1 root   root     770 Feb 16 00:16 /etc/zabbix/zabbix_java_gateway_logback.xml</div><div class="line">-rw-r--r-- 1 root   root   14938 Apr 14 11:48 /etc/zabbix/zabbix_server.conf</div><div class="line">-rw-r----- 1 root   zabbix 13657 Feb  4 10:19 /etc/zabbix/zabbix_server.conf_bak</div><div class="line">-rw-r----- 1 root   zabbix 14912 Feb 16 00:16 /etc/zabbix/zabbix_server.conf.rpmnew_bak</div></pre></td></tr></table></figure>
<p><strong>17.递归列出当前目录下的所有文件（包括隐藏文件）的绝对路径</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# find $PWD | xargs ls -ld </div><div class="line">drwxr-xr-x 5 root   root    4096 Apr 14 11:48 /etc/zabbix</div><div class="line">drwxrwxrwx 2 root   root      97 Jan 28 09:23 /etc/zabbix/alertscripts</div><div class="line">-rwxrwxrwx 1 root   root    2924 Jan 28 09:23 /etc/zabbix/alertscripts/sendim.py</div><div class="line">-rwxrwxrwx 1 root   root     835 Jan 27 06:51 /etc/zabbix/alertscripts/sendmail.py</div><div class="line">-rwxrwxrwx 1 root   root     611 Jan 27 06:51 /etc/zabbix/alertscripts/sendsms.sh</div><div class="line">-rwxrwxrwx 1 root   root    2930 Jan 27 06:51 /etc/zabbix/alertscripts/sendwechat.py</div><div class="line">drwxr-x--- 2 apache apache    54 Feb 17 21:10 /etc/zabbix/web</div><div class="line">-rw-r--r-- 1 root   root    1036 Feb 15 20:25 /etc/zabbix/web/maintenance.inc.php</div><div class="line">-rw-r--r-- 1 apache apache   431 Jan 27 06:27 /etc/zabbix/web/zabbix.conf.php</div><div class="line">-rw-r--r-- 1 root   root   10341 Feb 16 00:16 /etc/zabbix/zabbix_agentd.conf</div><div class="line">drwxr-xr-x 2 root   root      45 Feb 17 21:10 /etc/zabbix/zabbix_agentd.d</div><div class="line">-rw-r--r-- 1 root   root    1517 Feb 16 00:16 /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf</div><div class="line">-rw-r--r-- 1 root   root     813 Feb 16 00:16 /etc/zabbix/zabbix_java_gateway.conf</div><div class="line">-rw-r--r-- 1 root   root     770 Feb 16 00:16 /etc/zabbix/zabbix_java_gateway_logback.xml</div><div class="line">-rw-r--r-- 1 root   root   14938 Apr 14 11:48 /etc/zabbix/zabbix_server.conf</div><div class="line">-rw-r----- 1 root   zabbix 13657 Feb  4 10:19 /etc/zabbix/zabbix_server.conf_bak</div><div class="line">-rw-r----- 1 root   zabbix 14912 Feb 16 00:16 /etc/zabbix/zabbix_server.conf.rpmnew_bak</div></pre></td></tr></table></figure>
<p><strong>18. 显示文件或目录的索引节点号</strong></p>
<p>带-i选项能列出文件或目录的索引节点号。索引节点（index inode简称为“inode”）是Linux中一个特殊的概念，具有相同的索引节点号的两个文本本质上是同一个文件（除文件名不同外）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -i</div><div class="line">1058854 anaconda-ks.cfg  1061385 directory  1048579 install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>19. 显示文件的UID和GID</strong></p>
<p>用ls -n命令来显示文件和目录的UID和GID（root的均为0）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -n</div><div class="line">total 20</div><div class="line">-rwxr-xr-x. 1 0 0 1264 Feb 16  2015 anaconda-ks.cfg</div><div class="line">drwxr-xr-x  2 0 0 4096 Apr 12 21:25 directory</div><div class="line">-rwxr-xr-x. 1 0 0 9154 Feb 16  2015 install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>20. 水平输出文件列表，以逗号分隔</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls -m</div><div class="line">anaconda-ks.cfg, directory, install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>21. 列出文件并标记颜色分类</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# ls --color=auto</div><div class="line">anaconda-ks.cfg  directory  install.log.syslog</div></pre></td></tr></table></figure>
<p><strong>22.在ls中列出文件的绝对路径</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@zabbix zabbix]# ls | sed "s:^:`pwd`/:"</div><div class="line">/etc/zabbix/alertscripts</div><div class="line">/etc/zabbix/web</div><div class="line">/etc/zabbix/zabbix_agentd.conf</div><div class="line">/etc/zabbix/zabbix_agentd.d</div><div class="line">/etc/zabbix/zabbix_java_gateway.conf</div><div class="line">/etc/zabbix/zabbix_java_gateway_logback.xml</div><div class="line">/etc/zabbix/zabbix_server.conf</div><div class="line">/etc/zabbix/zabbix_server.conf_bak</div><div class="line">/etc/zabbix/zabbix_server.conf.rpmnew_bak</div></pre></td></tr></table></figure>
<p><strong>23. ls命令和它的别名</strong></p>
<p>我们给ls命令设置如下别名之后，当我们执行ls命令的时候它会默认执行-l选项并且像上文提到的那样显示长列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">alias ls=&quot;ls -l --color&quot;  </div><div class="line">unalias ls</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;1、命令简介&quot;&gt;&lt;a href=&quot;#1、命令简介&quot; class=&quot;headerlink&quot; title=&quot;1、命令简介&quot;&gt;&lt;/a&gt;1、命令简介&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;ls&lt;/strong&gt;（list 列出目录内容）命令用来
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="ls" scheme="http://wangshengzhuang.com/tags/ls/"/>
    
  </entry>
  
  <entry>
    <title>Supervisor简介、安装、配置</title>
    <link href="http://wangshengzhuang.com/2017/05/11/Linux/Supervisor/Supervisor%E7%AE%80%E4%BB%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/11/Linux/Supervisor/Supervisor简介/</id>
    <published>2017-05-10T16:00:00.000Z</published>
    <updated>2017-05-11T14:05:29.697Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要介绍了supervisor的安装、使用。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-11/27833402-file_1494510301732_82f7.jpg" alt=""></p>
<a id="more"></a>
<h3 id="1-什么是supervisor"><a href="#1-什么是supervisor" class="headerlink" title="1. 什么是supervisor"></a>1. <strong>什么是supervisor</strong></h3><p> Supervisor是一个Python开发的client/server系统，可以管理和监控类unix上面的进程。类似daemontools</p>
<p>什么情况下我们需要进程管理呢？就是执行一些需要以守护进程方式执行的程序，比如一个后台任务，如经常会碰到要写一些守护进程，简单做法放入后台：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; nohup python xxx.py &amp;</div></pre></td></tr></table></figure>
<p>除此之外，Supervisor 还能很友好的管理程序在命令行上输出的日志，可以将日志重定向到自定义的日志文件中，还能按文件大小对日志进行分割。</p>
<h3 id="2-为啥用supervisor"><a href="#2-为啥用supervisor" class="headerlink" title="2. 为啥用supervisor"></a>2. 为啥用supervisor</h3><p><strong>方便</strong></p>
<p>为啥简单呢？因为咱们通常管理linux进程的时候，一般来说都需要自己编写一个能够实现进程start/stop/restart/reload功能的脚本，然后丢到/etc/init.d/下面。这么做有很多不好的地方，第一我们要编写这个脚本，这就很耗时耗力了。第二，当这个进程挂掉的时候，linux不会自动重启它的，想要自动重启的话，我们还要自己写一个监控重启脚本。而supervisor则可以完美的解决这些问题。supervisor管理进程，是通过fork/exec的方式把这些被管理的进程，当作supervisor的子进程来启动。这样的话，我们只要在supervisor的配置文件中，把要管理的进程的可执行文件的路径写进去就OK了。这样就省下了我们如同linux管理进程的时自己写控制脚本的麻烦了。第二，被管理进程作为supervisor的子进程，当子进程挂掉的时候，父进程可以准确获取子进程挂掉的信息的，所以当然也就可以对挂掉的子进程进行自动重启了，当然重启还是不重启，也要看你的配置文件里面有木有设置autostart=true了。</p>
<p><strong>精确</strong></p>
<p> Supervisord将进程作为子进程启动，因此可以一直知晓子进程的状态，可以方便查询。而基于pid文件文件获取进程状态有时候不靠谱</p>
<p><strong>权限代理</strong></p>
<p>某些进程需要root或者sudo权限运行，而又不方便把机器的root权限和sudo权限开放给用户的时候，普通用户可以借助supervisor的命令和web UI进行进程的启动和关闭</p>
<p><strong>进程组</strong></p>
<p>linux系统没有批量启动关闭进程的功能，我们想要停止多个进程，只能一个一个的去停止，要么就自己写个脚本去批量停止。Supervisor 允许赋予进程优先级，可以使用supervisorctl 的“start all”, and “restart all”，按照优先级顺序启动。并且进程可以分组，相关的进程可以作为一个单元启动。</p>
<h3 id="3-supervisor特点"><a href="#3-supervisor特点" class="headerlink" title="3. supervisor特点"></a>3. supervisor特点</h3><ul>
<li><strong>简单</strong> :supervisor通过一个 INI-style的文件配置，简单易学。提供了许多诸如重启失败进程、自动日子归档的功能</li>
<li><strong>中心化</strong>:    可以在在同一个地方启动 停止 监控子进程，进程可以单独控制，也可以分组控制，并提供命令行和web接口配置supervisor</li>
<li><strong>高效</strong>:    通过 fork/exec启动子进程</li>
<li><strong>可扩展</strong>:  提供了simple event notification protocol和XML-RPC interface，方便通过各种语言进行配置管理</li>
<li><strong>兼容性强</strong>: 类Unix都支持，不支持windows，基于Python</li>
<li><strong>作为一款已经被使用了十多年的软件，可用性已经被广泛证明</strong></li>
</ul>
<h3 id="4-Supervisor-组成"><a href="#4-Supervisor-组成" class="headerlink" title="4. Supervisor 组成"></a>4. Supervisor 组成</h3><ol>
<li><strong>supervisord</strong>：supervisord是supervisor的服务端程序。负责启动子程序，应答客户端命令，重启crash进程，子程序日志记录，对进程变化发送事件通知等</li>
<li><strong>supervisorctl：</strong>  客户端命令行工具，可以连接服务器端，进行进程的启动、关闭、重启、状态查看等。重要的一点是，supervisorctl不仅可以连接到本机上的supervisord，还可以连接到远程的supervisord，当然在本机上面是通过UNIX socket连接的，远程是通过TCP socket连接的。supervisorctl和supervisord之间的通信，是通过xml_rpc完成的。    相应的配置在[supervisorctl]块里面</li>
<li><strong>Web Server</strong>   可以在界面上管理进程的WEB UI, 通过[inet_http_server] section配置，默认<a href="http://localhost:9001/`" target="_blank" rel="external">http://localhost:9001/`</a></li>
<li><strong>XML-RPC Interface</strong> XML-RPC接口，提供XML-RPC服务来对子进程进行管理，监控，参照 <a href="http://supervisord.org/api.html#xml-rpc" target="_blank" rel="external"><em>XML-RPC API Documentation</em></a>.</li>
</ol>
<h3 id="5-安装"><a href="#5-安装" class="headerlink" title="5 安装"></a>5 安装</h3><h4 id="5-1-yum-安装-推荐"><a href="#5-1-yum-安装-推荐" class="headerlink" title="5.1 yum 安装(推荐)"></a>5.1 yum 安装(推荐)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install supervisor</div></pre></td></tr></table></figure>
<p>会自动安装成服务形式，可以使用systemctl进行管理</p>
<h4 id="5-2-使用Setuptools安装"><a href="#5-2-使用Setuptools安装" class="headerlink" title="5.2 使用Setuptools安装"></a>5.2 使用Setuptools安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget -q http://peak.telecommunity.com/dist/ez_setup.py</div><div class="line">python ez_setup.py</div><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-setuptools</div><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<h4 id="5-3-安装方式3"><a href="#5-3-安装方式3" class="headerlink" title="5.3 安装方式3"></a>5.3 安装方式3</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://pypi.python.org/packages/80/37/964c0d53cbd328796b1aeb7abea4c0f7b0e8c7197ea9b0b9967b7d004def/supervisor-3.3.1.tar.gz</div><div class="line">tar -zxvf supervisor-3.3.1.tar.gz </div><div class="line">cd supervisor-3.3.1</div><div class="line">python setup.py install</div></pre></td></tr></table></figure>
<h4 id="5-4生成配置文件"><a href="#5-4生成配置文件" class="headerlink" title="5.4生成配置文件"></a>5.4生成配置文件</h4><p><code>yum 安装方式不需要此步骤，因为已经自动生产了supervisord.conf 和supervisord.d文件夹</code></p>
<p>安装完 supervisor 之后，可以运行<code>echo_supervisord_conf</code> 命令输出默认的配置项，也可以重定向到一个配置文件里：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure>
<h4 id="5-5启动"><a href="#5-5启动" class="headerlink" title="5.5启动"></a>5.5启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<h3 id="6-配置文件-etc-supervisord-conf"><a href="#6-配置文件-etc-supervisord-conf" class="headerlink" title="6. 配置文件/etc/supervisord.conf"></a>6. 配置文件/etc/supervisord.conf</h3><p>上面我们已经把 supervisrod 运行起来了，现在可以添加我们要管理的进程的配置文件。可以把所有配置项都写到 supervisord.conf 文件里，但并不推荐这样做，而是通过 include 的方式把不同的程序（组）写到不同的配置文件里。yum方式安装，会自动配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[include]</div><div class="line">files = supervisord.d/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<p>/etc/supervisord.conf 参数说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用</div><div class="line">;chmod=0700                 ; socket 文件的 mode，默认是 0700</div><div class="line">;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid</div><div class="line"> </div><div class="line">;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">;username=user              ; 登录管理后台的用户名</div><div class="line">;password=123               ; 登录管理后台的密码</div><div class="line"> </div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; 日志文件，默认是 $CWD/supervisord.log</div><div class="line">logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB</div><div class="line">logfile_backups=10           ; 日志文件保留备份数量默认 10</div><div class="line">loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace</div><div class="line">pidfile=/tmp/supervisord.pid ; pid 文件</div><div class="line">nodaemon=false               ; 是否在前台启动，默认是 false，即以 daemon 的方式启动</div><div class="line">minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024</div><div class="line">minprocs=200                 ; 可以打开的进程数的最小值，默认 200</div><div class="line"> </div><div class="line">; the below section must remain in the config file for RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them in separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"> </div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致</div><div class="line">;serverurl=http://127.0.0.1:9001 ; 通过 HTTP 的方式连接 supervisord</div><div class="line"> </div><div class="line">; 包含其他的配置文件</div><div class="line">[include]</div><div class="line">files = /etc/supervisord.d/*.ini    ; 可以是 *.conf 或 *.ini</div></pre></td></tr></table></figure>
<h3 id="7-添加一个被管理的进程"><a href="#7-添加一个被管理的进程" class="headerlink" title="7. 添加一个被管理的进程"></a>7. 添加一个被管理的进程</h3><p>我们假如有一个hello.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import web</div><div class="line">urls = (     &apos;/(.*)&apos;,&apos;hello&apos; )</div><div class="line">app = web.application(urls, globals())</div><div class="line">class hello:</div><div class="line">    def GET(self, name):</div><div class="line">        return &apos;hello: &apos; + name</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app.run()</div></pre></td></tr></table></figure>
<p>所以直接在命令行启动的方式可能是这样的：(需要先安装web.py <code>easy_install web.py</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python  /opt/hello.py</div></pre></td></tr></table></figure>
<p>现在编写一份配置文件<code>/etc/supervisord.d/hello.ini</code>来管理这个进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[program:hello]</div><div class="line">directory = /opt    ; 程序的启动目录</div><div class="line">command = python /opt/hello.py  ; 启动命令，可以看出与手动在命令行启动的命令是一样的</div><div class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</div><div class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</div><div class="line">autorestart = true   ; 程序异常退出后自动重启</div><div class="line">startretries = 3     ; 启动失败自动重试次数，默认是 3</div><div class="line">user = xqzt          ; 用哪个用户启动</div><div class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</div><div class="line">stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB</div><div class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</div><div class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</div><div class="line">stdout_logfile = /var/log/supervisor/hello.log</div></pre></td></tr></table></figure>
<p>一份配置文件至少需要一个 <code>[program:x]</code> 部分的配置，来告诉 supervisord 需要管理那个进程。<code>[program:x]</code> 语法中的 <code>x</code> 表示 program name，会在客户端（supervisorctl 或 web 界面）显示，在 supervisorctl 中通过这个值来对程序进行 start、restart、stop 等操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">supervisor&gt; status</div><div class="line">hello                            RUNNING   pid 2809, uptime 0:00:06</div></pre></td></tr></table></figure>
<h3 id="8-使用-supervisorctl"><a href="#8-使用-supervisorctl" class="headerlink" title="8. 使用 supervisorctl"></a>8. 使用 supervisorctl</h3><p>Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件，否则与 supervisord 一样按照顺序查找配置文件。supervisorctl 这个命令会进入 supervisorctl 的 shell 界面，然后可以执行不同的命令了，也可以直接在 bash 终端运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># supervisorctl --help</div><div class="line">supervisorctl -- control applications run by supervisord from the cmd line.</div><div class="line"></div><div class="line">Usage: /usr/bin/supervisorctl [options] [action [arguments]]</div><div class="line"></div><div class="line">Options:</div><div class="line">-c/--configuration -- configuration file path (default /etc/supervisord.conf)</div><div class="line">-h/--help -- print usage message and exit</div><div class="line">-i/--interactive -- start an interactive shell after executing commands</div><div class="line">-s/--serverurl URL -- URL on which supervisord server is listening</div><div class="line">     (default &quot;http://localhost:9001&quot;).</div><div class="line">-u/--username -- username to use for authentication with server</div><div class="line">-p/--password -- password to use for authentication with server</div><div class="line">-r/--history-file -- keep a readline history (if readline is available)</div></pre></td></tr></table></figure>
<p>输入help,可以查看支持的命令及用法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">supervisor&gt; help</div><div class="line"></div><div class="line">default commands (type help &lt;topic&gt;):</div><div class="line">=====================================</div><div class="line">add    clear  fg        open  quit    remove  restart   start   stop  update </div><div class="line">avail  exit   maintail  pid   reload  reread  shutdown  status  tail  version</div><div class="line"></div><div class="line">supervisor&gt; help start</div><div class="line">start &lt;name&gt;		Start a process</div><div class="line">start &lt;gname&gt;:*		Start all processes in a group</div><div class="line">start &lt;name&gt; &lt;name&gt;	Start multiple processes or groups</div><div class="line">start all		Start all processes</div></pre></td></tr></table></figure>
<p>常用命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 停止某一个进程，program_name 为 [program:x] 里的 x</div><div class="line">supervisorctl stop program_name</div><div class="line"># 启动某个进程</div><div class="line">supervisorctl start program_name</div><div class="line"># 重启某个进程</div><div class="line">supervisorctl restart program_name</div><div class="line"># 结束所有属于名为 groupworker 这个分组的进程 (start，restart 同理)</div><div class="line">supervisorctl stop groupworker:</div><div class="line"># 结束 groupworker:name1 这个进程 (start，restart 同理)</div><div class="line">supervisorctl stop groupworker:name1</div><div class="line"># 停止全部进程，注：start、restart、stop 都不会载入最新的配置文件</div><div class="line">supervisorctl stop all</div><div class="line"># 载入最新的配置文件，停止原有进程并按新的配置启动、管理所有进程</div><div class="line">supervisorctl reload</div><div class="line"># 根据最新的配置文件，启动新配置或有改动的进程，配置没有改动的进程不会受影响而重启</div><div class="line">supervisorctl update</div></pre></td></tr></table></figure>
<h3 id="9-supervisor-Web-UI"><a href="#9-supervisor-Web-UI" class="headerlink" title="9. supervisor Web UI"></a>9. supervisor Web UI</h3><p>除了 supervisorctl 之外，还可以配置 supervisrod 启动 web 管理界面，这个 web 后台使用 Basic Auth 的方式进行身份认证。将supervisord.conf中[inet_http_server]部分做相应配置，在supervisorctl中reload即可启动web管理界面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[inet_http_server] ; HTTP 服务器，提供 web 管理界面</div><div class="line">port=172.17.84.64:9001 ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">username=user ; 登录管理后台的用户名</div><div class="line">password=123 ; 登录管理后台的密码</div></pre></td></tr></table></figure>
<p>在浏览器中输入<a href="http://127.0.0.1:9001，可进入web管理界面" target="_blank" rel="external">http://127.0.0.1:9001，可进入web管理界面</a></p>
<p><img src="http://image.wangshengzhuang.com/17-5-11/65946564-file_1494502213044_176b5.png" alt=""></p>
<h3 id="10-将多个进程按组管理"><a href="#10-将多个进程按组管理" class="headerlink" title="10.  将多个进程按组管理"></a>10.  将多个进程按组管理</h3><p>Supervisor 同时还提供了另外一种进程组的管理方式，通过这种方式，可以使用 supervisorctl 命令来管理一组进程。跟 [program:x] 的进程组不同的是，这里的进程是一个个的 [program:x] 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[group:thegroupname]</div><div class="line">programs=progname1,progname2  ; each refers to &apos;x&apos; in [program:x] definitions</div><div class="line">priority=999                  ; the relative start priority (default 999)</div></pre></td></tr></table></figure>
<p>当添加了上述配置后，<code>progname1</code> 和 <code>progname2</code> 的进程名就会变成 <code>thegroupname:progname1</code> 和 <code>thegroupname:progname2</code> 以后就要用这个名字来管理进程了，而不是之前的 <code>progname1</code>。</p>
<p>以后执行 <code>supervisorctl stop thegroupname:</code> 就能同时结束 <code>progname1</code> 和 <code>progname2</code>，执行 <code>supervisorctl stop thegroupname:progname1</code> 就能结束 <code>progname1</code>。如下所示</p>
<p><code>/etc/supervisord.d/hello.ini</code>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[group:group1]</div><div class="line">programs=hello</div><div class="line"></div><div class="line">[program:hello]</div><div class="line">directory = /opt    ; 程序的启动目录</div><div class="line">command = python /opt/hello.py  ; 启动命令，可以看出与手动在命令行启动的命令是一样的</div><div class="line">autostart = true     ; 在 supervisord 启动的时候也自动启动</div><div class="line">startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了</div><div class="line">autorestart = true   ; 程序异常退出后自动重启</div><div class="line">startretries = 3     ; 启动失败自动重试次数，默认是 3</div><div class="line">user = xqzt          ; 用哪个用户启动</div><div class="line">redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false</div><div class="line">stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB</div><div class="line">stdout_logfile_backups = 20     ; stdout 日志文件备份数</div><div class="line">; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）</div><div class="line">; stdout_logfile = /var/log/supervisor/hello.log</div></pre></td></tr></table></figure>
<p>进程状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@centos7 etc]# supervisorctl </div><div class="line">group1:hello                     RUNNING   pid 2842, uptime 0:02:53</div></pre></td></tr></table></figure>
<h3 id="11-Subprocesses进程状态变化"><a href="#11-Subprocesses进程状态变化" class="headerlink" title="11. Subprocesses进程状态变化"></a>11. Subprocesses进程状态变化</h3><p><img src="http://supervisord.org/_images/subprocess-transitions.png" alt="http://supervisord.org/_images/subprocess-transitions.png"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://supervisord.org/#" target="_blank" rel="external">官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要介绍了supervisor的安装、使用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-11/27833402-file_1494510301732_82f7.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="Supervisor" scheme="http://wangshengzhuang.com/categories/Linux/Supervisor/"/>
    
    
      <category term="supervisor" scheme="http://wangshengzhuang.com/tags/supervisor/"/>
    
  </entry>
  
  <entry>
    <title>cd命令</title>
    <link href="http://wangshengzhuang.com/2017/05/10/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/cd%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/10/Linux/每天一个Linux命令/cd命令/</id>
    <published>2017-05-10T14:12:49.000Z</published>
    <updated>2017-05-11T14:43:40.740Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录cd命令的用法</p>
<a id="more"></a>
<h3 id="1、作用"><a href="#1、作用" class="headerlink" title="1、作用"></a><strong>1、作用</strong></h3><p><strong>cd</strong>（Change Directory 改变目录）命令用来切换工作目录至dirname。 其中dirName表示法可为绝对路径或相对路径。若目录名称省略，则变换至使用者的home directory(也就是刚login时所在的目录)。另外，~也表示为home directory的意思，.则是表示目前所在的目录，..则表示目前目录位置的上一层目录。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a><strong>2、用法</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd    (选项)   (参数)</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-p  如果要切换到的目标目录是一个符号连接，直接切换到符号连接指向的目标目录</div><div class="line">-L  如果要切换的目标目录是一个符号的连接，直接切换到字符连接名代表的目录，而非符号连接所指向的目标目录。</div><div class="line"> -   当仅实用&quot;-&quot;一个选项时，当前工作目录将被切换到环境变量&quot;OLDPWD&quot;所表示的目录。每当你更改目录时，shell都会将上一个目录位置记录在环境变量OLDPWD中</div></pre></td></tr></table></figure>
<h4 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h4><h4 id="1、cd-进入用户主目录；"><a href="#1、cd-进入用户主目录；" class="headerlink" title="1、cd 进入用户主目录；"></a>1、cd 进入用户主目录；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# cd</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="2、cd-进入用户主目录；"><a href="#2、cd-进入用户主目录；" class="headerlink" title="2、cd ~ 进入用户主目录；"></a>2、cd ~ 进入用户主目录；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# cd ~</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div><div class="line">[root@cent6 ~]#</div></pre></td></tr></table></figure>
<h4 id="3、cd-返回进入此目录之前所在的目录"><a href="#3、cd-返回进入此目录之前所在的目录" class="headerlink" title="3、cd - 返回进入此目录之前所在的目录"></a>3、cd - 返回进入此目录之前所在的目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div><div class="line">[root@cent6 ~]# cd /home</div><div class="line">[root@cent6 home]# cd -</div><div class="line">/root</div><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="4、cd-返回上级目录"><a href="#4、cd-返回上级目录" class="headerlink" title="4、cd .. 返回上级目录"></a>4、cd .. 返回上级目录</h4><p>（若当前目录为“/“，则执行完后还在“/“；”..”为上级目录的意思）；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# pwd</div><div class="line">/etc/init.d</div><div class="line">[root@cent6 init.d]# cd ..</div><div class="line">[root@cent6 etc]# pwd</div><div class="line">/etc</div></pre></td></tr></table></figure>
<h4 id="5、cd-返回上两级目录；"><a href="#5、cd-返回上两级目录；" class="headerlink" title="5、cd ../.. 返回上两级目录；"></a>5、cd ../.. 返回上两级目录；</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# pwd</div><div class="line">/etc/init.d</div><div class="line">[root@cent6 init.d]# cd ../..</div><div class="line">[root@cent6 /]# pwd</div><div class="line">/</div></pre></td></tr></table></figure>
<h4 id="6、cd-把上个命令的参数作为cd参数使用"><a href="#6、cd-把上个命令的参数作为cd参数使用" class="headerlink" title="6、cd !$ 把上个命令的参数作为cd参数使用"></a>6、cd !$ 把上个命令的参数作为cd参数使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@cent6 /]# ls -ld /media/</div><div class="line">drwxr-xr-x. 2 root root 4096 Sep 23  2011 /media/</div><div class="line">[root@cent6 /]# cd !$</div><div class="line">cd /media/</div><div class="line">[root@cent6 media]# pwd</div><div class="line">/media</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录cd命令的用法&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="cd" scheme="http://wangshengzhuang.com/tags/cd/"/>
    
  </entry>
  
  <entry>
    <title>pwd命令</title>
    <link href="http://wangshengzhuang.com/2017/05/09/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/pwd%E5%91%BD%E4%BB%A4/"/>
    <id>http://wangshengzhuang.com/2017/05/09/Linux/每天一个Linux命令/pwd命令/</id>
    <published>2017-05-09T14:12:49.000Z</published>
    <updated>2017-05-11T14:36:17.259Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要记录pwd命令的用法</p>
<a id="more"></a>
<h3 id="1、命令简介"><a href="#1、命令简介" class="headerlink" title="1、命令简介"></a>1、命令简介</h3><p><strong>pwd</strong>（print work directory 打印当前目录）命令以绝对路径的方式显示用户当前工作目录。</p>
<h3 id="2、用法"><a href="#2、用法" class="headerlink" title="2、用法"></a>2、用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pwd  [-LP]</div></pre></td></tr></table></figure>
<h3 id="3、选项"><a href="#3、选项" class="headerlink" title="3、选项"></a>3、选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-L    --logical    当目录为连接路径时，显示连接路径</div><div class="line">-P    --physical    显示实际物理路径，而非使用连接（link）路径</div></pre></td></tr></table></figure>
<h3 id="4、实例"><a href="#4、实例" class="headerlink" title="4、实例"></a>4、实例</h3><h4 id="4-1-显示当前目录所在路径-pwd"><a href="#4-1-显示当前目录所在路径-pwd" class="headerlink" title="4.1 显示当前目录所在路径 pwd"></a>4.1 显示当前目录所在路径 pwd</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# pwd</div><div class="line">/root</div></pre></td></tr></table></figure>
<h4 id="4-2-显示当前目录的物理路径-pwd-–P"><a href="#4-2-显示当前目录的物理路径-pwd-–P" class="headerlink" title="4.2 显示当前目录的物理路径 pwd –P"></a>4.2 显示当前目录的物理路径 pwd –P</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 ~]# cd /etc/init.d </div><div class="line">[root@cent6 init.d]# pwd -P</div><div class="line">/etc/rc.d/init.d</div></pre></td></tr></table></figure>
<h4 id="4-3-显示当前目录的连接路径：pwd-L"><a href="#4-3-显示当前目录的连接路径：pwd-L" class="headerlink" title="4.3 显示当前目录的连接路径：pwd -L"></a>4.3 显示当前目录的连接路径：pwd -L</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@cent6 init.d]# cd /etc/init.d </div><div class="line">[root@cent6 init.d]# pwd -L</div><div class="line">/etc/init.d</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要记录pwd命令的用法&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://wangshengzhuang.com/categories/Linux/"/>
    
      <category term="每天一个Linux命令" scheme="http://wangshengzhuang.com/categories/Linux/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AALinux%E5%91%BD%E4%BB%A4/"/>
    
    
      <category term="每天一个linux命令" scheme="http://wangshengzhuang.com/tags/%E6%AF%8F%E5%A4%A9%E4%B8%80%E4%B8%AAlinux%E5%91%BD%E4%BB%A4/"/>
    
      <category term="pwd" scheme="http://wangshengzhuang.com/tags/pwd/"/>
    
  </entry>
  
  <entry>
    <title>从已有的组复制搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/08/MySQL/MySQL%20HA/InnoDB%20Cluster/%E4%BB%8E%E5%B7%B2%E6%9C%89%E7%9A%84%E7%BB%84%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/08/MySQL/MySQL HA/InnoDB Cluster/从已有的组复制搭建InnoDB Cluster环境/</id>
    <published>2017-05-07T16:00:00.000Z</published>
    <updated>2017-05-07T17:47:01.159Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何基于已有的MySQL Group Replication，创建一个 Innodb cluster。</p>
<a id="more"></a>
<h3 id="1-已有的MySQL-Group-Replication-环境信息"><a href="#1-已有的MySQL-Group-Replication-环境信息" class="headerlink" title="1. 已有的MySQL Group Replication 环境信息"></a>1. 已有的MySQL Group Replication 环境信息</h3><table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.84.71</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>172.17.84.72</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>172.17.84.73</td>
<td>mysql003</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>查看组复制当前状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 80af8598-1520-11e7-a8b9-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | 8abf4eab-1521-11e7-9cc9-080027b95fc4 | mysql002    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | dcd3068d-15bc-11e7-b264-080027dad0d6 | mysql003    |        3306 | ONLINE       |</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><pre><code>wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm
rpm -ivh mysql57-community-release-el7-10.noarch.rpm
yum install mysql-shell -y
</code></pre><h3 id="3-创建cluster"><a href="#3-创建cluster" class="headerlink" title="3. 创建cluster"></a>3. 创建cluster</h3><p>通过指定 <code>adoptFromGR</code> option，使用dba.createCluster()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysqlsh --uri root@172.17.84.71:3306</div><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;prodCluster&apos;, &#123;adoptFromGR: true&#125;);</div><div class="line">A new InnoDB cluster will be created on instance &apos;root@172.17.84.7:3306&apos;.</div><div class="line"></div><div class="line">Creating InnoDB cluster &apos;prodCluster&apos; on &apos;root@172.17.84.72:3306&apos;...</div><div class="line">Adding Seed Instance...</div><div class="line"></div><div class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</div><div class="line">At least 3 instances are needed for the cluster to be able to withstand up to</div><div class="line">one server failure.</div></pre></td></tr></table></figure>
<p>查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster=dba.getCluster()</div><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;,</div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;,</div><div class="line">        &quot;primary&quot;: &quot;172.17.84.71:3306&quot;,</div><div class="line">        &quot;status&quot;: &quot;OK&quot;,</div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;,</div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;172.17.84.71:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.84.71:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql002:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql002:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql003:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql003:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-持久化配置文件"><a href="#4-持久化配置文件" class="headerlink" title="4. 持久化配置文件"></a>4. 持久化配置文件</h3><p>对于已经在cluster中的实例，可以持久化cluster的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dba.configureLocalInstance(root@localhost:3306)</div></pre></td></tr></table></figure>
<p>查看配置文件的变化my.cnf</p>
<h3 id="5-简单测试Failover"><a href="#5-简单测试Failover" class="headerlink" title="5.简单测试Failover"></a>5.简单测试Failover</h3><p>关闭mysql001实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld</div></pre></td></tr></table></figure>
<p>重启mysql001实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld</div></pre></td></tr></table></figure>
<p>查看cluster状态,发现Primary Master已经切换到mysql002</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;prodCluster&quot;,</div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;,</div><div class="line">        &quot;primary&quot;: &quot;172.17.84.72:3306&quot;,</div><div class="line">        &quot;status&quot;: &quot;OK&quot;,</div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;,</div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;172.17.84.72:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.17.84.72:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql001:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql001:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;mysql003:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;mysql003:3306&quot;,</div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;,</div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;,</div><div class="line">                &quot;role&quot;: &quot;HA&quot;,</div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-createCluster语法"><a href="#6-createCluster语法" class="headerlink" title="6.createCluster语法"></a>6.createCluster语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.help(createCluster());</div><div class="line">ReferenceError: createCluster is not defined</div><div class="line">mysql-js&gt; dba.help(&apos;createCluster&apos;);</div><div class="line"></div><div class="line">Creates a MySQL InnoDB cluster.</div><div class="line"></div><div class="line">SYNTAX</div><div class="line"></div><div class="line">  &lt;Dba&gt;.createCluster(name[, options])</div><div class="line"></div><div class="line">WHERE</div><div class="line"></div><div class="line">  name: The name of the cluster object to be created.</div><div class="line">  options: Dictionary with options that modify the behavior of this function.</div><div class="line"></div><div class="line">DESCRIPTION</div><div class="line"></div><div class="line">Creates a MySQL InnoDB cluster taking as seed instance the active global</div><div class="line">session.</div><div class="line"></div><div class="line">The options dictionary can contain the next values:</div><div class="line"></div><div class="line"> - clusterAdminType: defines the type of management to be done on the cluster</div><div class="line">   instances.</div><div class="line"> - multiMaster: boolean value used to define an InnoDB cluster with multiple</div><div class="line">   writable instances.</div><div class="line"> - force: boolean, confirms that the multiMaster option must be applied.</div><div class="line"> - adoptFromGR: boolean value used to create the InnoDB cluster based on</div><div class="line">   existing replication group.</div><div class="line"> - memberSslMode: SSL mode used to configure the members of the cluster.</div><div class="line"> - ipWhitelist: The list of hosts allowed to connect to the instance for group</div><div class="line">   replication.</div><div class="line"></div><div class="line">The values for clusterAdminType options include: local, manual, guided or ssh,</div><div class="line">however, at the moment only local is supported and is used as default value if</div><div class="line">this attribute is not specified.</div><div class="line"></div><div class="line">A InnoDB cluster may be setup in two ways:</div><div class="line"></div><div class="line"> - Single Master: One member of the cluster allows write operations while the</div><div class="line">   rest are in read only mode.</div><div class="line"> - Multi Master: All the members in the cluster support both read and write</div><div class="line">   operations.</div><div class="line"></div><div class="line">By default this function create a Single Master cluster, use the multiMaster</div><div class="line">option set to true if a Multi Master cluster is required.</div><div class="line"></div><div class="line">The memberSslMode option supports these values:</div><div class="line"></div><div class="line"> - REQUIRED: if used, SSL (encryption) will be enabled for the instances to</div><div class="line">   communicate with other members of the cluster</div><div class="line"> - DISABLED: if used, SSL (encryption) will be disabled</div><div class="line"> - AUTO: if used, SSL (encryption) will be enabled if supported by the</div><div class="line">   instance, otherwise disabled</div><div class="line"></div><div class="line">If memberSslMode is not specified AUTO will be used by default.</div><div class="line"></div><div class="line">The ipWhitelist format is a comma separated list of IP addresses or subnet CIDR</div><div class="line">notation, for example: 192.168.1.0/24,10.0.0.1. By default the value is set to</div><div class="line">AUTOMATIC, allowing addresses from the instance private network to be</div><div class="line">automatically set for the whitelist.</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-group-replication.html" target="_blank" rel="external">Creating an InnoDB Cluster From an Existing Group Replication Deployment</a></li>
<li><a href="https://ronniethedba.wordpress.com/2017/04/23/creating-an-innodb-cluster-router-from-an-existing-group-replication-deployment/" target="_blank" rel="external">https://ronniethedba.wordpress.com/2017/04/23/creating-an-innodb-cluster-router-from-an-existing-group-replication-deployment/</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何基于已有的MySQL Group Replication，创建一个 Innodb cluster。&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/tags/Group-Replication/"/>
    
  </entry>
  
  <entry>
    <title>MySQL Group Replication 部署中遇到的错误</title>
    <link href="http://wangshengzhuang.com/2017/05/07/MySQL/Group%20Replication/MySQL%20Group%20Replication%20%E9%83%A8%E7%BD%B2%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF/"/>
    <id>http://wangshengzhuang.com/2017/05/07/MySQL/Group Replication/MySQL Group Replication 部署中遇到的错误/</id>
    <published>2017-05-06T16:20:05.000Z</published>
    <updated>2017-05-07T16:41:56.285Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要描述了MySQL Group Replication 部署中遇到的错误</p>
<a id="more"></a>
<h3 id="错误一-未设置白名单导致的无法启动group-replication"><a href="#错误一-未设置白名单导致的无法启动group-replication" class="headerlink" title="错误一 未设置白名单导致的无法启动group_replication"></a>错误一 未设置白名单导致的无法启动group_replication</h3><h4 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">2017-04-24T06:23:09.971308Z 3 [Note] Plugin group_replication reported: &apos;[GCS] Added automatically IP ranges 127.0.0.1/8 to the whitelist&apos;</div><div class="line">2017-04-24T06:23:09.971480Z 3 [Note] Plugin group_replication reported: &apos;[GCS] SSL was not enabled&apos;</div><div class="line">2017-04-24T06:23:09.971513Z 3 [Note] Plugin group_replication reported: &apos;Initialized group communication with configuration: group_replication_group_name: &quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;; group_replication_local_address: &quot;172.17.84.71:33061&quot;; group_replication_group_seeds: &quot;172.17.84.71:33061,172.17.84.72:33061,172.17.84.73:33061&quot;; group_replication_bootstrap_group: true; group_replication_poll_spin_loops: 0; group_replication_compression_threshold: 1000000; group_replication_ip_whitelist: &quot;AUTOMATIC&quot;&apos;</div><div class="line">2017-04-24T06:23:09.972386Z 12 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_applier&apos; executed&apos;. Previous state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;&lt;NULL&gt;&apos;, master_port= 0, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T06:23:09.982442Z 15 [Note] Slave SQL thread for channel &apos;group_replication_applier&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./mysql001-relay-bin-group_replication_applier.000001&apos; position: 4</div><div class="line">2017-04-24T06:23:09.982441Z 3 [Note] Plugin group_replication reported: &apos;Group Replication applier module successfully initialized!&apos;</div><div class="line">2017-04-24T06:23:09.982618Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_increment is set to 7&apos;</div><div class="line">2017-04-24T06:23:09.982637Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_offset is set to 1&apos;</div><div class="line">2017-04-24T06:23:09.982841Z 0 [Note] Plugin group_replication reported: &apos;state 4257 action xa_init&apos;</div><div class="line">2017-04-24T06:23:09.982957Z 0 [Note] Plugin group_replication reported: &apos;Successfully bound to 0.0.0.0:33061 (socket=80).&apos;</div><div class="line">2017-04-24T06:23:09.983104Z 0 [Note] Plugin group_replication reported: &apos;Successfully set listen backlog to 32 (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983149Z 0 [Note] Plugin group_replication reported: &apos;Successfully unblocked socket (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983232Z 0 [Note] Plugin group_replication reported: &apos;Ready to accept incoming connections on 0.0.0.0:33061 (socket=80)!&apos;</div><div class="line">2017-04-24T06:23:09.983302Z 0 [Note] Plugin group_replication reported: &apos;connecting to 172.17.84.71 33061&apos;</div><div class="line">2017-04-24T06:23:09.983432Z 0 [Note] Plugin group_replication reported: &apos;client connected to 172.17.84.71 33061 fd 83&apos;</div><div class="line">2017-04-24T06:23:09.983524Z 0 [Warning] Plugin group_replication reported: &apos;[GCS] Connection attempt from IP address 172.17.84.71 refused. Address is not in the IP whitelist.&apos;</div><div class="line">2017-04-24T06:23:09.983620Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] Error connecting to the local group communication engine instance.&apos;</div><div class="line">2017-04-24T06:23:09.983647Z 0 [Note] Plugin group_replication reported: &apos;state 4257 action xa_exit&apos;</div><div class="line">2017-04-24T06:23:09.983926Z 0 [Note] Plugin group_replication reported: &apos;Exiting xcom thread&apos;</div><div class="line">2017-04-24T06:23:11.014814Z 0 [ERROR] Plugin group_replication reported: &apos;[GCS] The member was unable to join the group. Local port: 33061&apos;</div><div class="line">2017-04-24T06:24:09.991677Z 3 [ERROR] Plugin group_replication reported: &apos;Timeout on wait for view after joining group&apos;</div><div class="line">2017-04-24T06:24:09.991847Z 3 [Note] Plugin group_replication reported: &apos;Requesting to leave the group despite of not being a member&apos;</div><div class="line">2017-04-24T06:24:09.991903Z 3 [ERROR] Plugin group_replication reported: &apos;[GCS] The member is leaving a group without being on one.&apos;</div><div class="line">2017-04-24T06:24:09.992323Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_increment is reset to 1&apos;</div><div class="line">2017-04-24T06:24:09.992354Z 3 [Note] Plugin group_replication reported: &apos;auto_increment_offset is reset to 1&apos;</div><div class="line">2017-04-24T06:24:09.992922Z 15 [Note] Error reading relay log event for channel &apos;group_replication_applier&apos;: slave SQL thread was killed</div><div class="line">2017-04-24T06:24:09.993527Z 12 [Note] Plugin group_replication reported: &apos;The group replication applier thread was killed&apos;</div></pre></td></tr></table></figure>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><p>基于网段或者IP 指定白名单，可以在线动态修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">set global group_replication_ip_whitelist = &apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;;</div><div class="line">set global group_replication_ip_whitelist = &apos;172.17.84.71/24&apos;;</div></pre></td></tr></table></figure>
<p>或者添加到my.cnf中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure>
<h3 id="错误二-无法解析主机名导致member状态一直未recoving"><a href="#错误二-无法解析主机名导致member状态一直未recoving" class="headerlink" title="错误二 无法解析主机名导致member状态一直未recoving"></a>错误二 无法解析主机名导致member状态一直未recoving</h3><h4 id="错误信息-1"><a href="#错误信息-1" class="headerlink" title="错误信息"></a>错误信息</h4><p>通过<code>SELECT * FROM performance_schema.replication_group_members;</code>查询，发现MEMBER_STATE一直是recoving</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">2017-04-24T07:01:19.864784Z 0 [Note] Plugin group_replication reported: &apos;Starting group replication recovery with view_id 14930159987057432:2&apos;</div><div class="line">2017-04-24T07:01:19.865335Z 19 [Note] Plugin group_replication reported: &apos;Establishing group recovery connection with a possible donor. Attempt 1/10&apos;</div><div class="line">2017-04-24T07:01:19.871742Z 19 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;mysql001&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T07:01:19.881203Z 19 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 60b61f19-289f-11e7-b97d-08002730b4d8 at mysql001 port: 3306.&apos;</div><div class="line">2017-04-24T07:01:19.881586Z 21 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</div><div class="line">2017-04-24T07:01:19.882339Z 22 [Note] Slave SQL thread for channel &apos;group_replication_recovery&apos; initialized, starting replication in log &apos;FIRST&apos; at position 0, relay log &apos;./mysql002-relay-bin-group_replication_recovery.000001&apos; position: 4</div><div class="line">2017-04-24T07:01:19.883547Z 21 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: error connecting to master &apos;rpl_user@mysql001:3306&apos; - retry-time: 60  retries: 1, Error_code: 2005</div><div class="line">2017-04-24T07:01:19.883573Z 21 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos; killed while connecting to master</div><div class="line">2017-04-24T07:01:19.883582Z 21 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</div><div class="line">2017-04-24T07:01:19.883861Z 19 [ERROR] Plugin group_replication reported: &apos;There was an error when connecting to the donor server. Check group replication recovery&apos;s connection credentials.&apos;</div><div class="line">2017-04-24T07:01:19.884138Z 19 [Note] Plugin group_replication reported: &apos;Retrying group recovery connection with another donor. Attempt 2/10&apos;</div><div class="line">2017-04-24T07:01:55.338092Z 0 [Note] Plugin group_replication reported: &apos;getstart group_id 4317e324&apos;</div><div class="line">2017-04-24T07:01:57.362663Z 0 [Note] Plugin group_replication reported: &apos;Marking group replication view change with view_id 14930159987057432:3&apos;</div><div class="line">2017-04-24T07:01:57.422909Z 0 [Note] Plugin group_replication reported: &apos;The member with address mysql003:3306 was declared online within the replication group&apos;</div><div class="line">2017-04-24T07:02:19.884808Z 19 [Note] &apos;CHANGE MASTER TO FOR CHANNEL &apos;group_replication_recovery&apos; executed&apos;. Previous state master_host=&apos;mysql001&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;. New state master_host=&apos;mysql003&apos;, master_port= 3306, master_log_file=&apos;&apos;, master_log_pos= 4, master_bind=&apos;&apos;.</div><div class="line">2017-04-24T07:02:19.890519Z 19 [Note] Plugin group_replication reported: &apos;Establishing connection to a group replication recovery donor 164b8061-28ba-11e7-9a51-080027dad0d6 at mysql003 port: 3306.&apos;</div><div class="line">2017-04-24T07:02:19.891514Z 26 [Warning] Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the &apos;START SLAVE Syntax&apos; in the MySQL Manual for more information.</div><div class="line">2017-04-24T07:02:19.893156Z 26 [ERROR] Slave I/O for channel &apos;group_replication_recovery&apos;: error connecting to master &apos;rpl_user@mysql003:3306&apos; - retry-time: 60  retries: 1, Error_code: 2005</div><div class="line">2017-04-24T07:02:19.893186Z 26 [Note] Slave I/O thread for channel &apos;group_replication_recovery&apos; killed while connecting to master</div><div class="line">2017-04-24T07:02:19.893194Z 26 [Note] Slave I/O thread exiting for channel &apos;group_replication_recovery&apos;, read up to log &apos;FIRST&apos;, position 4</div><div class="line">2017-04-24T0</div></pre></td></tr></table></figure>
<h4 id="解决办法-1"><a href="#解决办法-1" class="headerlink" title="解决办法"></a>解决办法</h4><p><strong>方法一  配置hosts</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">172.17.84.71 mysql001</div><div class="line">172.17.84.72 msyql002</div><div class="line">172.17.84.73 mysql003</div></pre></td></tr></table></figure>
<p><strong>方法二</strong></p>
<p>或者在配置文件my.cnf使用report_host=ip，显示指定使用IP，而非默认的主机名</p>
<h3 id="错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed-Gtid-Set不同"><a href="#错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed-Gtid-Set不同" class="headerlink" title="错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed_Gtid_Set不同"></a>错误三：mysql初始化，修改root密码，没有禁用日志，导致各节点Executed_Gtid_Set不同</h3><h4 id="错误信息-2"><a href="#错误信息-2" class="headerlink" title="错误信息"></a>错误信息</h4><p>修改密码操作必须设置binlog不记录，执行后再打开，否则会引起START GROUP_REPLICATION执行报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ERROR] Plugin group_replication reported: &apos;The member contains transactions not present in the group. The member will now exit the group.&apos;</div><div class="line">[Note] Plugin group_replication reported: &apos;To force this member into the group you can use the group_replication_allow_local_disjoint_gtids_join option&apos;</div></pre></td></tr></table></figure>
<h4 id="解决办法-2"><a href="#解决办法-2" class="headerlink" title="解决办法"></a>解决办法</h4><p><strong>方法一：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000002</div><div class="line">         Position: 150</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set:</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p><strong>方法二</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set global group_replication_allow_local_disjoint_gtids_join=ON;</div></pre></td></tr></table></figure></p>
<p><strong>方法三</strong></p>
<p>如果是全新的实例，可以通过reset master清空Executed_Gtid_Set</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt;reset master</div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000010</div><div class="line">         Position: 1486</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-10</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文主要描述了MySQL Group Replication 部署中遇到的错误&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/categories/MySQL/Group-Replication/"/>
    
    
  </entry>
  
  <entry>
    <title>Deploying Group Replication in Single-Primary Mode</title>
    <link href="http://wangshengzhuang.com/2017/05/06/MySQL/Group%20Replication/Deploying%20Group%20Replication%20in%20Single-Primary%20Mode/"/>
    <id>http://wangshengzhuang.com/2017/05/06/MySQL/Group Replication/Deploying Group Replication in Single-Primary Mode/</id>
    <published>2017-05-06T15:41:22.000Z</published>
    <updated>2017-05-07T16:12:30.150Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了3实例MySQL Group Replication的搭建过程</p>
<p><img src="http://image.wangshengzhuang.com/c0fb0918de7c170b6d6749896862f7bd.png" alt="MGR"></p>
<a id="more"></a>
<h3 id="一、环境信息"><a href="#一、环境信息" class="headerlink" title="一、环境信息"></a>一、环境信息</h3><table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.84.71</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>172.17.84.72</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>172.17.84.73</td>
<td>mysql003</td>
<td>3</td>
</tr>
</tbody>
</table>
<h3 id="二、搭建前准备"><a href="#二、搭建前准备" class="headerlink" title="二、搭建前准备"></a>二、搭建前准备</h3><ol>
<li>关闭selinux(略)     </li>
<li><p>开启端口3306 33061</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">##Add</div><div class="line">firewall-cmd --permanent --zone=public --add-port=3306/tcp</div><div class="line">firewall-cmd --permanent --zone=public --add-port=33061/tcp</div><div class="line"></div><div class="line">##Reload</div><div class="line">firewall-cmd --reload</div><div class="line"> </div><div class="line">## 检查是否生效</div><div class="line">firewall-cmd --zone=public --query-port=3306/tcp</div><div class="line">firewall-cmd --zone=public --query-port=33061/tcp</div><div class="line"> </div><div class="line">## 列出所有的开放端口</div><div class="line">firewall-cmd --list-all</div></pre></td></tr></table></figure>
</li>
<li><p>配置/etc/hosts ip和主机名对应关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@mysql003 ~]# cat /etc/hosts</div><div class="line">172.17.84.71 mysql001</div><div class="line">172.17.84.72 msyql002</div><div class="line">172.17.84.73 mysql003</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="三、初始化三个数据库实例"><a href="#三、初始化三个数据库实例" class="headerlink" title="三、初始化三个数据库实例"></a>三、初始化三个数据库实例</h3><h4 id="3-1-初始化3个mysql实例"><a href="#3-1-初始化3个mysql实例" class="headerlink" title="3.1 初始化3个mysql实例"></a>3.1 初始化3个mysql实例</h4><p>mysql001配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">[root@mysql001 ~]# cat /usr/local/mysql/etc/my.cnf</div><div class="line">[client]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/run/mysql.sock</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/run/mysql.sock</div><div class="line">pid_file = /usr/local/mysql/run/mysql.pid</div><div class="line">datadir = /usr/local/mysql/data</div><div class="line">default_storage_engine = InnoDB</div><div class="line">max_allowed_packet = 512M</div><div class="line">max_connections = 2048</div><div class="line">open_files_limit = 65535</div><div class="line"></div><div class="line">lower_case_table_names=1</div><div class="line"></div><div class="line">character-set-server = utf8mb4</div><div class="line">collation-server = utf8mb4_unicode_ci</div><div class="line">init_connect=&apos;SET NAMES utf8mb4&apos;</div><div class="line"></div><div class="line"></div><div class="line">innodb_buffer_pool_size = 1024M</div><div class="line">innodb_log_file_size = 2048M</div><div class="line">innodb_file_per_table = 1</div><div class="line">innodb_flush_log_at_trx_commit = 0</div><div class="line"></div><div class="line"></div><div class="line">key_buffer_size = 64M</div><div class="line"></div><div class="line">log-error = /usr/local/mysql/log/mysql_error.log</div><div class="line">log-bin = /usr/local/mysql/binlogs/mysql-bin</div><div class="line">slow_query_log = 1</div><div class="line">slow_query_log_file = /usr/local/mysql/log/mysql_slow_query.log</div><div class="line">long_query_time = 5</div><div class="line"></div><div class="line"></div><div class="line">tmp_table_size = 32M</div><div class="line">max_heap_table_size = 32M</div><div class="line">query_cache_type = 0</div><div class="line">query_cache_size = 0</div><div class="line"></div><div class="line">server-id=1</div><div class="line">gtid_mode = ON</div><div class="line">enforce_gtid_consistency = ON</div><div class="line">binlog_checksum=NONE</div><div class="line">log_slave_updates = ON</div><div class="line">master_info_repository = TABLE</div><div class="line">relay_log_info_repository = TABLE</div><div class="line"></div><div class="line">transaction_write_set_extraction=XXHASH64</div><div class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</div><div class="line">loose-group_replication_start_on_boot=off</div><div class="line">loose-group_replication_local_address= &quot;172.17.84.71:33061&quot;</div><div class="line">loose-group_replication_group_seeds= &quot;172.17.84.71:33061,172.17.84.72:33061,172.17.84.73:33061&quot;</div><div class="line">loose-group_replication_bootstrap_group= off</div><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure></p>
<p>参数说明见<a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html" target="_blank" rel="external">Group Replication System Variables</a></p>
<p>初始化实例 并启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</div><div class="line">systemctl start mysqld</div></pre></td></tr></table></figure>
<p>到错误日志文件中找到临时密码进行登录，登录后修改临时密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@mysql001 /]# grep &apos;temporary password&apos; /usr/local/mysql/log/mysql_error.log</div><div class="line">2017-04-24T03:37:44.558511Z 1 [Note] A temporary password is generated for root@localhost: 3yFK,#qtjAl;</div></pre></td></tr></table></figure></p>
<p>修改root密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000002</div><div class="line">         Position: 150</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set:</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">ERROR:</div><div class="line">No query specified</div></pre></td></tr></table></figure></p>
<p>修改密码操作必须设置binlog不记录，执行后再打开，否则会引起START GROUP_REPLICATION执行报错。全新的环境可以通过reset master解决这个问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[ERROR] Plugin group_replication reported: &apos;The member contains transactions not present in the group. The member will now exit the group.&apos;</div><div class="line">[Note] Plugin group_replication reported: &apos;To force this member into the group you can use the group_replication_allow_local_disjoint_gtids_join option&apos;</div></pre></td></tr></table></figure></p>
<h3 id="四、配置MGR"><a href="#四、配置MGR" class="headerlink" title="四、配置MGR"></a>四、配置MGR</h3><h4 id="4-1-创建复制账号"><a href="#4-1-创建复制账号" class="headerlink" title="4.1 创建复制账号"></a>4.1 创建复制账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos;;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos; IDENTIFIED BY &apos;rpl_pass&apos;;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="4-2-使用change-master命令配置server"><a href="#4-2-使用change-master命令配置server" class="headerlink" title="4.2 使用change master命令配置server"></a>4.2 使用change master命令配置server</h4><p>在下次需要从其他成员恢复其状态时，使用group_replication_recovery复制通道的给定凭据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;rpl_pass&apos;  FOR CHANNEL &apos;group_replication_recovery&apos;;</div><div class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</div></pre></td></tr></table></figure></p>
<h4 id="4-3-安装复制组插件"><a href="#4-3-安装复制组插件" class="headerlink" title="4.3 安装复制组插件"></a>4.3 安装复制组插件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; install plugin group_replication soname &apos;group_replication.so&apos;;</div><div class="line">Query OK, 0 rows affected (0.26 sec)</div></pre></td></tr></table></figure>
<h4 id="4-4-查看插件是否安装成功"><a href="#4-4-查看插件是否安装成功" class="headerlink" title="4.4 查看插件是否安装成功"></a>4.4 查看插件是否安装成功</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show plugins;</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div><div class="line">| Name                       | Status   | Type               | Library              | License |</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div><div class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</div><div class="line">| mysql_native_password      | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</div><div class="line">.</div><div class="line">.</div><div class="line">.</div><div class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</div><div class="line">+----------------------------+----------+--------------------+----------------------+---------+</div></pre></td></tr></table></figure>
<h4 id="4-5、配置引导组，并启动GROUP-REPLICATION"><a href="#4-5、配置引导组，并启动GROUP-REPLICATION" class="headerlink" title="4.5、配置引导组，并启动GROUP_REPLICATION"></a>4.5、配置引导组，并启动GROUP_REPLICATION</h4><p>此引导应仅有单个server独立完成，该server启动组并且只启动一次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#### 设置group_replication_bootstrap_group 只需要在mysql001上执行一次，另外两个实例不执行这句</div><div class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON;  </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">ERROR 3092 (HY000): The server is not configured properly to be an active member of the group. Please see more details on error log.</div></pre></td></tr></table></figure></p>
<p>查看log，发现是白名单问题导致的，my.cnf添加白名单后重新启动组复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set global group_replication_ip_whitelist = &apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">Query OK, 0 rows affected (1.02 sec)</div><div class="line"></div><div class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>直接添加白名单到my.cnf,防止下次启动再重新问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_ip_whitelist=&apos;172.17.84.71,172.17.84.72,172.17.84.73&apos;</div></pre></td></tr></table></figure>
<h4 id="4-6-查看状态"><a href="#4-6-查看状态" class="headerlink" title="4.6 查看状态"></a>4.6 查看状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 60b61f19-289f-11e7-b97d-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">1 row in set (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; show master status \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">             File: mysql-bin.000003</div><div class="line">         Position: 434</div><div class="line">     Binlog_Do_DB:</div><div class="line"> Binlog_Ignore_DB:</div><div class="line">Executed_Gtid_Set: aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h4 id="4-7-向组中添加实例mysql002-mysql003"><a href="#4-7-向组中添加实例mysql002-mysql003" class="headerlink" title="4.7 向组中添加实例mysql002 mysql003"></a>4.7 向组中添加实例mysql002 mysql003</h4><p>mysql002 mysql003的操作和mysql001相同，除了不需要SET GLOBAL group_replication_bootstrap_group=ON;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; START GROUP_REPLICATION;</div><div class="line">Query OK, 0 rows affected (1.02 sec)</div></pre></td></tr></table></figure>
<p>查看最终状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">| group_replication_applier | 80af8598-1520-11e7-a8b9-08002730b4d8 | mysql001    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | 8abf4eab-1521-11e7-9cc9-080027b95fc4 | mysql002    |        3306 | ONLINE       |</div><div class="line">| group_replication_applier | dcd3068d-15bc-11e7-b264-080027dad0d6 | mysql003    |        3306 | ONLINE       |</div><div class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<h4 id="4-8-修改-group-replication-start-on-boot-on"><a href="#4-8-修改-group-replication-start-on-boot-on" class="headerlink" title="4.8 修改 group_replication_start_on_boot=on"></a>4.8 修改 group_replication_start_on_boot=on</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loose-group_replication_start_on_boot=on</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-deploying-in-single-primary-mode.html" target="_blank" rel="external">Deploying Group Replication in Single-Primary Mode</a></li>
<li><a href="http://www.niugebbs.com/HRT152/1244148.html" target="_blank" rel="external">http://www.niugebbs.com/HRT152/1244148.html</a></li>
<li><a href="http://blog.csdn.net/dbaxiaosa/article/details/70226540" target="_blank" rel="external">http://blog.csdn.net/dbaxiaosa/article/details/70226540</a></li>
<li><a href="http://hbxflihua.iteye.com/blog/2358031" target="_blank" rel="external">MySQL Group Replication多机多实例安装配置</a></li>
<li><a href="http://fordba.com/mysql-group-replication-install.html" target="_blank" rel="external">MySQL Group Replication 9节点快速部署</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了3实例MySQL Group Replication的搭建过程&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/c0fb0918de7c170b6d6749896862f7bd.png&quot; alt=&quot;MGR&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="Group Replication" scheme="http://wangshengzhuang.com/categories/MySQL/Group-Replication/"/>
    
    
  </entry>
  
  <entry>
    <title>多节点3实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/05/MySQL/MySQL%20HA/InnoDB%20Cluster/InnoDB%20Cluster%20%E5%A4%9A%E6%9C%BA3%E5%AE%9E%E4%BE%8B%E8%8A%82%E7%82%B9%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/05/MySQL/MySQL HA/InnoDB Cluster/InnoDB Cluster 多机3实例节点搭建过程/</id>
    <published>2017-05-05T13:00:00.000Z</published>
    <updated>2017-05-05T15:38:59.799Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<table>
<thead>
<tr>
<th>ip地址</th>
<th>主机名</th>
<th>server_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.101</td>
<td>mysql001</td>
<td>1</td>
</tr>
<tr>
<td>192.168.0.102</td>
<td>mysql002</td>
<td>2</td>
</tr>
<tr>
<td>192.168.0.103</td>
<td>mysql003</td>
<td>3</td>
</tr>
<tr>
<td>192.168.0.104</td>
<td>mysql-router</td>
</tr>
</tbody>
</table>
<p><img src="http://image.wangshengzhuang.com/17-5-5/42193296-file_1493993554567_5bbb.png" alt=""></p>
<a id="more"></a>
<p>主要步骤如图所示</p>
<p><img src="http://image.wangshengzhuang.com/17-5-5/60464800-file_1493998183242_301b.png" alt=""></p>
<h3 id="1-安装3个mysql实例"><a href="#1-安装3个mysql实例" class="headerlink" title="1. 安装3个mysql实例"></a>1. 安装3个mysql实例</h3><p>注意：修改root密码时候设置SQL_LOG_BIN=0;此步骤主要是避免Executed_Gtid_Set不一致</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password('admin_123');</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'admin_123' WITH GRANT OPTION;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt;  SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>一句话执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql -uroot -padmin_123 -e "SET SQL_LOG_BIN=0;GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'admin_123' WITH GRANT OPTION; flush privileges; SET SQL_LOG_BIN=1"</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="3-Configuring-the-Instance"><a href="#3-Configuring-the-Instance" class="headerlink" title="3. Configuring the Instance"></a>3. Configuring the Instance</h3><p>检查并配置3个数据库实例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:<span class="number">3306</span></div><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(<span class="string">'root@localhost:3306'</span>)</div><div class="line">mysql-js&gt; dba.configureLocalInstance(<span class="string">'root@localhost:3306'</span>)</div></pre></td></tr></table></figure>
<p>详细过程如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3306&apos; is not valid for Cluster usage.</div><div class="line"></div><div class="line">The following issues were encountered:</div><div class="line"></div><div class="line"> - Some configuration options need to be fixed.</div><div class="line"></div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| Variable                         | Current Value | Required Value | Note                                             |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| binlog_checksum                  | CRC32         | NONE           | Update the server variable or restart the server |</div><div class="line">| enforce_gtid_consistency         | OFF           | ON             | Restart the server                               |</div><div class="line">| gtid_mode                        | OFF           | ON             | Restart the server                               |</div><div class="line">| log_slave_updates                | 0             | ON             | Restart the server                               |</div><div class="line">| master_info_repository           | FILE          | TABLE          | Restart the server                               |</div><div class="line">| relay_log_info_repository        | FILE          | TABLE          | Restart the server                               |</div><div class="line">| transaction_write_set_extraction | OFF           | XXHASH64       | Restart the server                               |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line">Please fix these issues , restart the serverand try again.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;server_update&quot;, </div><div class="line">            &quot;current&quot;: &quot;CRC32&quot;, </div><div class="line">            &quot;option&quot;: &quot;binlog_checksum&quot;, </div><div class="line">            &quot;required&quot;: &quot;NONE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line"></div><div class="line">Detecting the configuration file...</div><div class="line">Default file not found at the standard locations.</div><div class="line">Please specify the path to the MySQL configuration file: /usr/local/mysql/mysql_3306/etc/my.cnf</div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The configuration has been updated but it is required to restart the server.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; systemctl restart mysqld</div></pre></td></tr></table></figure>
<p>重新检查3个实例，确保结果ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  dba.checkInstanceConfiguration(&apos;root@localhost:3306&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3306&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3306&apos; is valid for Cluster usage</div><div class="line">&#123;</div><div class="line">    &quot;status&quot;: &quot;ok&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-创建-InnoDB-Cluster"><a href="#4-创建-InnoDB-Cluster" class="headerlink" title="4.  创建 InnoDB Cluster"></a>4.  创建 InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3306:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.101:3306</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@192.168.0.101:3306&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="5-添加-Instances-至-InnoDB-Cluster"><a href="#5-添加-Instances-至-InnoDB-Cluster" class="headerlink" title="5.添加 Instances 至 InnoDB Cluster"></a>5.添加 Instances 至 InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.0.101 mysql001</div><div class="line">192.168.0.102 mysql002</div><div class="line">192.168.0.103 mysql003</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.101:3306</div><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.102:3306&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3306&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-持久化配置文件"><a href="#6-持久化配置文件" class="headerlink" title="6. 持久化配置文件"></a>6. 持久化配置文件</h3><p>已经在cluster中的实例，第二次运行dba.configureLocalInstance(‘root@localhost:3306’)，会将配置cluster的配置持久化到my.cnf</p>
<p>必须使用<code>localhost</code>连接后在每个实例单独执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3306</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3306&apos;)</div></pre></td></tr></table></figure>
<h3 id="7-安装配置-MySQL-Router"><a href="#7-安装配置-MySQL-Router" class="headerlink" title="7. 安装配置 MySQL Router"></a>7. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@192.168.0.103:3306 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:devCluster]</div><div class="line">router_id=1</div><div class="line">bootstrap_server_addresses=mysql://192.168.0.101:3306,mysql://192.168.0.102:3306,mysql://192.168.0.103:3306</div><div class="line">user=mysql_router1_m55oiq8bjdry</div><div class="line">metadata_cluster=devCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:devCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:devCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">shell&gt;</span> mysqlsh --uri root@localhost:6446</div><div class="line"><span class="meta">mysql-js&gt;</span> \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line"><span class="meta">mysql-sql&gt;</span> select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3306 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="8-Testing-Failover"><a href="#8-Testing-Failover" class="headerlink" title="8. Testing Failover"></a>8. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 192.168.0.101:3306</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld@3301</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3306 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现192.168.0.102:3306已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.101:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@192.168.0.101:3306&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.102:3306&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.101:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.102:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3306&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3306&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="lhttps://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html" target="_blank" rel="external"> Working with a Production Deployment</a></li>
<li><a href="http://mysqlserverteam.com/mysql-innodb-cluster-real-world-cluster-tutorial-for-oel-fedora-rhel-and-centos/" target="_blank" rel="external">MySQL InnoDB Cluster – Real-World Cluster Tutorial for OEL, Fedora, RHEL and CentOS</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ip地址&lt;/th&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;th&gt;server_id&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.101&lt;/td&gt;
&lt;td&gt;mysql001&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.102&lt;/td&gt;
&lt;td&gt;mysql002&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.103&lt;/td&gt;
&lt;td&gt;mysql003&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;192.168.0.104&lt;/td&gt;
&lt;td&gt;mysql-router&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-5/42193296-file_1493993554567_5bbb.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>单机3实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/04/MySQL/MySQL%20HA/InnoDB%20Cluster/%E5%8D%95%E6%9C%BA3%E5%AE%9E%E4%BE%8B%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/04/MySQL/MySQL HA/InnoDB Cluster/单机3实例搭建InnoDB Cluster环境/</id>
    <published>2017-05-04T13:00:00.000Z</published>
    <updated>2017-05-04T15:08:17.710Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-4/61574976-file_1493910145576_cdbc.png" alt=""></p>
<a id="more"></a>
<blockquote>
<p>This section explains how to set up a single-primary InnoDB cluster and configure MySQL Router to achieve high availability. </p>
<p>This tutorial shows how to use MySQL Shell to create an InnoDB cluster consisting of a MySQL Server instance which provides the seed instance of the InnoDB cluster and holds the initial data set. Two more MySQL server instances are created and added to the InnoDB cluster. Then MySQL Router is deployed and used to route connections to the InnoDB cluster, and high availability is tested. </p>
</blockquote>
<h3 id="1-安装3个mysql实例"><a href="#1-安装3个mysql实例" class="headerlink" title="1. 安装3个mysql实例"></a>1. 安装3个mysql实例</h3><p>注意：修改root密码时候设置SQL_LOG_BIN=0;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt;  SET SQL_LOG_BIN=0;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; set password=password(&apos;admin_123&apos;);</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;admin_123&apos; WITH GRANT OPTION;</div><div class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt;  SET SQL_LOG_BIN=1;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="2-Yum-安装MySQL-Shell"><a href="#2-Yum-安装MySQL-Shell" class="headerlink" title="2. Yum 安装MySQL Shell"></a>2. Yum 安装MySQL Shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="3-Configuring-the-Instance"><a href="#3-Configuring-the-Instance" class="headerlink" title="3. Configuring the Instance"></a>3. Configuring the Instance</h3><p>检查并配置3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3301</div><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div></pre></td></tr></table></figure>
<p>详细过程如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3301&apos; is not valid for Cluster usage.</div><div class="line"></div><div class="line">The following issues were encountered:</div><div class="line"></div><div class="line"> - Some configuration options need to be fixed.</div><div class="line"></div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| Variable                         | Current Value | Required Value | Note                                             |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line">| binlog_checksum                  | CRC32         | NONE           | Update the server variable or restart the server |</div><div class="line">| enforce_gtid_consistency         | OFF           | ON             | Restart the server                               |</div><div class="line">| gtid_mode                        | OFF           | ON             | Restart the server                               |</div><div class="line">| log_slave_updates                | 0             | ON             | Restart the server                               |</div><div class="line">| master_info_repository           | FILE          | TABLE          | Restart the server                               |</div><div class="line">| relay_log_info_repository        | FILE          | TABLE          | Restart the server                               |</div><div class="line">| transaction_write_set_extraction | OFF           | XXHASH64       | Restart the server                               |</div><div class="line">+----------------------------------+---------------+----------------+--------------------------------------------------+</div><div class="line"></div><div class="line"></div><div class="line">Please fix these issues , restart the serverand try again.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;server_update&quot;, </div><div class="line">            &quot;current&quot;: &quot;CRC32&quot;, </div><div class="line">            &quot;option&quot;: &quot;binlog_checksum&quot;, </div><div class="line">            &quot;required&quot;: &quot;NONE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line"></div><div class="line">Detecting the configuration file...</div><div class="line">Default file not found at the standard locations.</div><div class="line">Please specify the path to the MySQL configuration file: /usr/local/mysql/mysql_3301/etc/my.cnf</div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The configuration has been updated but it is required to restart the server.</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;config_errors&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;enforce_gtid_consistency&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;gtid_mode&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;0&quot;, </div><div class="line">            &quot;option&quot;: &quot;log_slave_updates&quot;, </div><div class="line">            &quot;required&quot;: &quot;ON&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;master_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;FILE&quot;, </div><div class="line">            &quot;option&quot;: &quot;relay_log_info_repository&quot;, </div><div class="line">            &quot;required&quot;: &quot;TABLE&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;action&quot;: &quot;restart&quot;, </div><div class="line">            &quot;current&quot;: &quot;OFF&quot;, </div><div class="line">            &quot;option&quot;: &quot;transaction_write_set_extraction&quot;, </div><div class="line">            &quot;required&quot;: &quot;XXHASH64&quot;</div><div class="line">        &#125;</div><div class="line">    ], </div><div class="line">    &quot;errors&quot;: [], </div><div class="line">    &quot;restart_required&quot;: true, </div><div class="line">    &quot;status&quot;: &quot;error&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启3个数据库实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">shell&gt; systemctl restart mysqld@3301</div><div class="line">shell&gt; systemctl restart mysqld@3302</div><div class="line">shell&gt; systemctl restart mysqld@3303</div></pre></td></tr></table></figure>
<p>重新检查3个实例，确保结果ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  dba.checkInstanceConfiguration(&apos;root@localhost:3301&apos;)</div><div class="line">Please provide the password for &apos;root@localhost:3301&apos;: </div><div class="line">Validating instance...</div><div class="line"></div><div class="line">The instance &apos;localhost:3301&apos; is valid for Cluster usage</div><div class="line">&#123;</div><div class="line">    &quot;status&quot;: &quot;ok&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-Creating-the-InnoDB-Cluster"><a href="#4-Creating-the-InnoDB-Cluster" class="headerlink" title="4.  Creating the InnoDB Cluster"></a>4.  Creating the InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3301:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.103:3301</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@192.168.0.103:3301&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="5-Adding-Instances-to-an-InnoDB-Cluster"><a href="#5-Adding-Instances-to-an-InnoDB-Cluster" class="headerlink" title="5. Adding Instances to an InnoDB Cluster"></a>5. Adding Instances to an InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 mysql001</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@192.168.0.103:3301</div><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3302&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt;  cluster.addInstance(&apos;root@192.168.0.103:3303&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-持久化配置文件"><a href="#6-持久化配置文件" class="headerlink" title="6. 持久化配置文件"></a>6. 持久化配置文件</h3><p>已经在cluster中的实例，第二次运行dba.configureLocalInstance(‘root@localhost:3301’)，会将配置cluster的配置持久化到my.cnf</p>
<p>必须使用<code>localhost</code>连接后在每个实例单独执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3301</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3301&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3302</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3302&apos;)</div><div class="line">mysql-js&gt; \connect root@localhost:3303</div><div class="line">mysql-js&gt; dba.configureLocalInstance(&apos;root@localhost:3303&apos;)</div></pre></td></tr></table></figure>
<h3 id="7-安装配置-MySQL-Router"><a href="#7-安装配置-MySQL-Router" class="headerlink" title="7. 安装配置 MySQL Router"></a>7. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@localhost:3301 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:devCluster]</div><div class="line">router_id=1</div><div class="line">bootstrap_server_addresses=mysql://192.168.0.103:3301,mysql://192.168.0.103:3302,mysql://192.168.0.103:3303</div><div class="line">user=mysql_router1_m55oiq8bjdry</div><div class="line">metadata_cluster=devCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:devCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:devCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://devCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:devCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://devCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh --uri root@localhost:6446</div><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3301 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="8-Testing-Failover"><a href="#8-Testing-Failover" class="headerlink" title="8. Testing Failover"></a>8. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 3301</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl stop mysqld@3301</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3302 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现3302实例已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl start mysqld@3301</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@192.168.0.103:3301&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;devCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;192.168.0.103:3301&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3301&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3302&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3302&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;192.168.0.103:3303&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;192.168.0.103:3303&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="lhttps://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-working-with-production-deployment.html" target="_blank" rel="external"> Working with a Production Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过单机三个msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-4/61574976-file_1493910145576_cdbc.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>沙盒实例搭建InnoDB Cluster环境</title>
    <link href="http://wangshengzhuang.com/2017/05/03/MySQL/MySQL%20HA/InnoDB%20Cluster/3%E6%B2%99%E7%9B%92%E5%AE%9E%E4%BE%8B%E6%90%AD%E5%BB%BAInnoDB%20Cluster%E7%8E%AF%E5%A2%83/"/>
    <id>http://wangshengzhuang.com/2017/05/03/MySQL/MySQL HA/InnoDB Cluster/3沙盒实例搭建InnoDB Cluster环境/</id>
    <published>2017-05-02T16:00:00.000Z</published>
    <updated>2017-05-04T15:16:41.278Z</updated>
    
    <content type="html"><![CDATA[<p>本文描述了如何通过三个沙盒msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。</p>
<p><img src="http://image.wangshengzhuang.com/17-5-4/93088466-file_1493910959566_e506.png" alt=""></p>
<a id="more"></a>
<blockquote>
<p>This section explains how to set up a single-primary InnoDB cluster and configure MySQL Router to achieve high availability. </p>
<p>This tutorial shows how to use MySQL Shell to create an InnoDB cluster consisting of a MySQL Server instance which provides the seed instance of the InnoDB cluster and holds the initial data set. Two more sandbox MySQL server instances are created and added to the InnoDB cluster. Then MySQL Router is deployed and used to route connections to the InnoDB cluster, and high availability is tested. </p>
</blockquote>
<h3 id="1-Yum-安装MySQL-Shell"><a href="#1-Yum-安装MySQL-Shell" class="headerlink" title="1. Yum 安装MySQL Shell"></a>1. Yum 安装MySQL Shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-shell -y</div></pre></td></tr></table></figure>
<h3 id="2-创建三个沙盒实例"><a href="#2-创建三个沙盒实例" class="headerlink" title="2. 创建三个沙盒实例"></a>2. 创建三个沙盒实例</h3><p>Start MySQL Shell </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh</div></pre></td></tr></table></figure>
<p>MySQL Shell provides two scripting languages: JavaScript and Python. Throughout this guide MySQL Shell is used primarily in JavaScript mode . When MySQL Shell starts it is in JavaScript mode by default. You switch into JavaScript mode, Python mode and SQL mode using the commands <code>\js</code>, <code>\py</code>, and <code>\sql</code>. Ensure you are in JavaScript mode by issuing the <code>\js</code> command, then execute:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.deploySandboxInstance(3310)</div><div class="line">mysql-js&gt; dba.deploySandboxInstance(3320)</div><div class="line">mysql-js&gt; dba.deploySandboxInstance(3330)</div></pre></td></tr></table></figure>
<h3 id="3-Creating-the-InnoDB-Cluster"><a href="#3-Creating-the-InnoDB-Cluster" class="headerlink" title="3.  Creating the InnoDB Cluster"></a>3.  Creating the InnoDB Cluster</h3><p>Connect MySQL Shell to the seed instance, in this case the one at port 3310:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \connect root@localhost:3310</div><div class="line">或者</div><div class="line">mysql-js&gt; shell.connect(&apos;root@localhost:3310&apos;)</div></pre></td></tr></table></figure>
<p>Use the <code>createCluster()</code> method to create the InnoDB cluster with the currently connected instance as the seed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.createCluster(&apos;testCluster&apos;)</div></pre></td></tr></table></figure>
<h3 id="4-Adding-Instances-to-an-InnoDB-Cluster"><a href="#4-Adding-Instances-to-an-InnoDB-Cluster" class="headerlink" title="4. Adding Instances to an InnoDB Cluster"></a>4. Adding Instances to an InnoDB Cluster</h3><p>配置<code>/etc/hosts</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 mysql001</div></pre></td></tr></table></figure>
<p>Obtaining the <code>cluster</code> Instance Variable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; var cluster = dba.getCluster(&quot;testCluster&quot;)</div></pre></td></tr></table></figure>
<p>Add the second instance to the InnoDB cluster:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.addInstance(&apos;root@localhost:3320&apos;)</div></pre></td></tr></table></figure>
<p>Add the third instance:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.addInstance(&apos;root@localhost:3330&apos;)</div></pre></td></tr></table></figure>
<p>查看cluster 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3310&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-安装配置-MySQL-Router"><a href="#5-安装配置-MySQL-Router" class="headerlink" title="5. 安装配置 MySQL Router"></a>5. 安装配置 MySQL Router</h3><p>Yum安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</div><div class="line">rpm -ivh mysql57-community-release-el7-10.noarch.rpm</div><div class="line">yum install mysql-router -y</div></pre></td></tr></table></figure>
<p> bootstrap 生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlrouter --bootstrap root@localhost:3310 --user=mysqlrouter</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/mysqlrouter/mysqlrouter.conf</code>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">shell &gt; cat  /etc/mysqlrouter/mysqlrouter.conf</div><div class="line"># File automatically generated during MySQL Router bootstrap</div><div class="line">[DEFAULT]</div><div class="line">name=system</div><div class="line">user=mysqlrouter</div><div class="line">keyring_path=/var/lib/mysqlrouter/keyring</div><div class="line">master_key_path=/etc/mysqlrouter/mysqlrouter.key</div><div class="line"></div><div class="line">[logger]</div><div class="line">level = INFO</div><div class="line"></div><div class="line">[metadata_cache:testCluster]</div><div class="line">router_id=3</div><div class="line">bootstrap_server_addresses=mysql://localhost:3310,mysql://localhost:3320,mysql://localhost:3330</div><div class="line">user=mysql_router3_c3j5z9t7rjgk</div><div class="line">metadata_cluster=testCluster</div><div class="line">ttl=300</div><div class="line"></div><div class="line">[routing:testCluster_default_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6446</div><div class="line">destinations=metadata-cache://testCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:testCluster_default_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=6447</div><div class="line">destinations=metadata-cache://testCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=classic</div><div class="line"></div><div class="line">[routing:testCluster_default_x_rw]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64460</div><div class="line">destinations=metadata-cache://testCluster/default?role=PRIMARY</div><div class="line">mode=read-write</div><div class="line">protocol=x</div><div class="line"></div><div class="line">[routing:testCluster_default_x_ro]</div><div class="line">bind_address=0.0.0.0</div><div class="line">bind_port=64470</div><div class="line">destinations=metadata-cache://testCluster/default?role=SECONDARY</div><div class="line">mode=read-only</div><div class="line">protocol=x</div></pre></td></tr></table></figure>
<p>启动mysqlrouter(记得修改下权限 默认权限不对)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chown mysqlrouter.mysqlrouter /var/lib/mysqlrouter</div><div class="line">systemctl start mysqlrouter</div></pre></td></tr></table></figure>
<p>测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqlsh --uri root@localhost:6446</div><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3310 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<h3 id="6-Testing-Failover"><a href="#6-Testing-Failover" class="headerlink" title="6. Testing Failover"></a>6. Testing Failover</h3><p>killing the <code>PRIMARY</code> instance 3310</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.killSandboxInstance(3310)</div></pre></td></tr></table></figure>
<p>测试连接（第一次失败，第二次成功）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; \sql</div><div class="line">Switching to SQL mode... Commands end with ;</div><div class="line">mysql-sql&gt; SELECT @@port;</div><div class="line">ERROR: 2013 (HY000): Lost connection to MySQL server during query</div><div class="line">The global session got disconnected.</div><div class="line">Attempting to reconnect to &apos;root@localhost:6446&apos;...</div><div class="line">The global session was successfully reconnected.</div><div class="line">mysql-sql&gt; select @@port;</div><div class="line">+--------+</div><div class="line">| @@port |</div><div class="line">+--------+</div><div class="line">|   3330 |</div><div class="line">+--------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>查看cluster状态, 可以发现3320实例已经变成Primary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3320&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;(MISSING)&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> bring the instance that you killed back online.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; dba.startSandboxInstance(3310)</div><div class="line">mysql-js&gt; cluster.rejoinInstance(&apos;root@localhost:3310&apos;)</div><div class="line">mysql-js&gt; cluster.status()</div></pre></td></tr></table></figure>
<p>重新查看cluster状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql-js&gt; cluster.status()</div><div class="line">&#123;</div><div class="line">    &quot;clusterName&quot;: &quot;testCluster&quot;, </div><div class="line">    &quot;defaultReplicaSet&quot;: &#123;</div><div class="line">        &quot;name&quot;: &quot;default&quot;, </div><div class="line">        &quot;primary&quot;: &quot;localhost:3320&quot;, </div><div class="line">        &quot;status&quot;: &quot;OK&quot;, </div><div class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </div><div class="line">        &quot;topology&quot;: &#123;</div><div class="line">            &quot;localhost:3310&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3310&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3320&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3320&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/W&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;, </div><div class="line">            &quot;localhost:3330&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;localhost:3330&quot;, </div><div class="line">                &quot;mode&quot;: &quot;R/O&quot;, </div><div class="line">                &quot;readReplicas&quot;: &#123;&#125;, </div><div class="line">                &quot;role&quot;: &quot;HA&quot;, </div><div class="line">                &quot;status&quot;: &quot;ONLINE&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-innodb-cluster-getting-started.html" target="_blank" rel="external"> Getting Started with InnoDB Cluster</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文描述了如何通过三个沙盒msyql实例，创建一个Single-Primary Innodb cluster，并通过mysql Router对connections实现路由，实现高可用性。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/17-5-4/93088466-file_1493910959566_e506.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDB Cluster简介</title>
    <link href="http://wangshengzhuang.com/2017/05/02/MySQL/MySQL%20HA/InnoDB%20Cluster/InnoDB%20Cluster%E7%AE%80%E4%BB%8B/"/>
    <id>http://wangshengzhuang.com/2017/05/02/MySQL/MySQL HA/InnoDB Cluster/InnoDB Cluster简介/</id>
    <published>2017-05-01T16:00:00.000Z</published>
    <updated>2017-05-05T15:23:53.587Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、InnoDB-Cluster简介"><a href="#一、InnoDB-Cluster简介" class="headerlink" title="一、InnoDB Cluster简介"></a>一、InnoDB Cluster简介</h3><p>前几天 Mysql 团队愉快的发布了 InnoDB Cluster 的 GA（General Availability 正式发布） 版本</p>
<p>InnoDB Cluster 是 Mysql 的一套完整的高可用解决方案</p>
<blockquote>
<p>MySQL InnoDB cluster is a collection of products that work together to provide a complete High Availability solution for MySQL.</p>
</blockquote>
<p><img src="http://image.wangshengzhuang.com/0acc4ee7b48fa39a7685491e99bbccfb.png" alt=""></p>
<a id="more"></a>
<p>InnoDB Cluster 由下面3个核心组件构成：</p>
<ul>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysql-shell.html" target="_blank" rel="external">MySQL Shell</a>    通过内置的 AdminAPI 来创建和管理整个 InnoDB Clusters</p>
<blockquote>
<p>Includes the AdminAPI, which enables you to script the creation and administration of an InnoDB cluster, using either JavaScript or Python.</p>
</blockquote>
</li>
<li><p><a href="https://dev.mysql.com/doc/mysql-router/2.1/en/" target="_blank" rel="external">MySQL Router</a>   缓存 InnoDB cluster 的元数据，负责把 client 的 read/write 请求路由到当前的主数据库节点，还可以对 client 的请求进行负载均衡，并且在主数据库节点出现故障时，保证 client 的请求被路由到新的主服务器节点</p>
<blockquote>
<p>Caches the metadata of the InnoDB cluster and routes read/write client requests to the current primary. If the primary instance becomes unavailable, MySQL Router automatically routes client requests to a promoted secondary (the new primary). </p>
</blockquote>
</li>
<li><p><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication.html" target="_blank" rel="external"><em>Group Replication</em></a>  MySQL Server 5.7.17 or higher. 可以把数据同步到集群内的所有成员中，并支持 <strong>容错</strong> 、 <strong>自动故障转移</strong> 、 <strong>灵活扩展</strong>   等重要特性</p>
<blockquote>
<p>This provides the MySQL Group Replication mechanism to allow data to be replicated within the cluster, with built-in failover. Group Replication </p>
</blockquote>
<p><img src="http://image.wangshengzhuang.com/17-5-3/23165946-file_1493815367505_f827.png" alt=""></p>
<p>​</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、InnoDB-Cluster简介&quot;&gt;&lt;a href=&quot;#一、InnoDB-Cluster简介&quot; class=&quot;headerlink&quot; title=&quot;一、InnoDB Cluster简介&quot;&gt;&lt;/a&gt;一、InnoDB Cluster简介&lt;/h3&gt;&lt;p&gt;前几天 Mysql 团队愉快的发布了 InnoDB Cluster 的 GA（General Availability 正式发布） 版本&lt;/p&gt;
&lt;p&gt;InnoDB Cluster 是 Mysql 的一套完整的高可用解决方案&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;MySQL InnoDB cluster is a collection of products that work together to provide a complete High Availability solution for MySQL.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&quot;http://image.wangshengzhuang.com/0acc4ee7b48fa39a7685491e99bbccfb.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/categories/MySQL/"/>
    
      <category term="MySQL HA" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/"/>
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/categories/MySQL/MySQL-HA/InnoDB-Cluster/"/>
    
    
      <category term="InnoDB Cluster" scheme="http://wangshengzhuang.com/tags/InnoDB-Cluster/"/>
    
      <category term="MySQL" scheme="http://wangshengzhuang.com/tags/MySQL/"/>
    
  </entry>
  
</feed>
